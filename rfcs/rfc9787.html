<!DOCTYPE html>
<html lang="en" class="RFC">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>RFC 9787: Guidance on End-to-End Email Security</title>
<meta content="Daniel Kahn Gillmor" name="author">
<meta content="Alexey Melnikov" name="author">
<meta content="Bernie Hoeneisen" name="author">
<meta content="
       End-to-end cryptographic protections for email messages can provide useful security.
However, the standards for providing cryptographic protection are extremely flexible.
That flexibility can trap users and cause surprising failures.
This document offers guidance for Mail User Agent (MUA) implementers to help mitigate those risks and to make end-to-end email simple and secure for the end user.
It provides a useful set of vocabulary as well as recommendations to avoid common failures.
It also identifies a number of currently unsolved usability and interoperability problems. 
    " name="description">
<meta content="xml2rfc 3.30.0" name="generator">
<meta content="cryptography" name="keyword">
<meta content="encryption" name="keyword">
<meta content="signature" name="keyword">
<meta content="signing" name="keyword">
<meta content="usability" name="keyword">
<meta content="MIME" name="keyword">
<meta content="confidentiality" name="keyword">
<meta content="integrity" name="keyword">
<meta content="authenticity" name="keyword">
<meta content="9787" name="rfc.number">
<!-- Generator version information:
  xml2rfc 3.30.0
    Python 3.9.15
    ConfigArgParse 1.5.3
    google-i18n-address 3.0.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 5.3.0
    platformdirs 3.8.0
    pycountry 22.3.5
    PyYAML 6.0
    requests 2.28.0
    setuptools 44.1.1
    six 1.16.0
    wcwidth 0.2.5
    weasyprint 65.0
-->
<link href="rfc9787.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necessary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

:root {
  --font-sans: 'Noto Sans', Arial, Helvetica, sans-serif;
  --font-serif: 'Noto Serif', 'Times', 'Times New Roman', serif;
  --font-mono: 'Roboto Mono', Courier, 'Courier New', monospace;
}

@viewport {
  zoom: 1.0;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: var(--font-sans);
  line-height: 1.6;
  scroll-behavior: smooth;
  overflow-wrap: break-word;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
@media print {
  svg {
    max-height: 850px;
    max-width: 660px;
  }
}
svg[font-family~="serif" i], svg [font-family~="serif" i] {
  font-family: var(--font-serif);
}
svg[font-family~="sans-serif" i], svg [font-family~="sans-serif" i] {
  font-family: var(--font-sans);
}
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  display: table;
  border: none;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre {
  background-color: #f9f9f9;
  font-family: var(--font-mono);
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
blockquote > *:last-child {
  margin-bottom: 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}
.xref {
  overflow-wrap: normal;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    max-width: 100%;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.refSubseries {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: var(--font-sans);
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  .breakable pre {
    break-inside: auto;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The following is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
.sourcecode pre,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .artwork > pre,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: upper-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background slightly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr {
  break-inside: avoid;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottom margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code, dt tt, dt code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the compact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > blockquote:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div.sourcecode:first-child,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type:only-child {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<link href="https://datatracker.ietf.org/doc/draft-ietf-lamps-e2e-mail-guidance-17" rel="prev">
  <link href="https://dx.doi.org/10.17487/rfc9787" rel="alternate">
  <link href="urn:issn:2070-1721" rel="alternate">
  </head>
<body class="xml2rfc">
<script src="https://www.rfc-editor.org/js/metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">RFC 9787</td>
<td class="center">Guidance on End-to-End Email Security</td>
<td class="right">August 2025</td>
</tr></thead>
<tfoot><tr>
<td class="left">Gillmor, et al.</td>
<td class="center">Informational</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-stream">Stream:</dt>
<dd class="stream">Internet Engineering Task Force (IETF)</dd>
<dt class="label-rfc">RFC:</dt>
<dd class="rfc"><a href="https://www.rfc-editor.org/rfc/rfc9787" class="eref">9787</a></dd>
<dt class="label-category">Category:</dt>
<dd class="category">Informational</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2025-08" class="published">August 2025</time>
    </dd>
<dt class="label-issn">ISSN:</dt>
<dd class="issn">2070-1721</dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">D. K. Gillmor, <span class="editor">Ed.</span>
</div>
<div class="org">ACLU</div>
</div>
<div class="author">
      <div class="author-name">A. Melnikov, <span class="editor">Ed.</span>
</div>
<div class="org">Isode Ltd</div>
</div>
<div class="author">
      <div class="author-name">B. Hoeneisen, <span class="editor">Ed.</span>
</div>
<div class="org">pEp Project</div>
</div>
</dd>
</dl>
</div>
<h1 id="rfcnum">RFC 9787</h1>
<h1 id="title">Guidance on End-to-End Email Security</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">End-to-end cryptographic protections for email messages can provide useful security.
However, the standards for providing cryptographic protection are extremely flexible.
That flexibility can trap users and cause surprising failures.
This document offers guidance for Mail User Agent (MUA) implementers to help mitigate those risks and to make end-to-end email simple and secure for the end user.
It provides a useful set of vocabulary as well as recommendations to avoid common failures.
It also identifies a number of currently unsolved usability and interoperability problems.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
            This document is not an Internet Standards Track specification; it is
            published for informational purposes.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
            This document is a product of the Internet Engineering Task Force
            (IETF).  It represents the consensus of the IETF community.  It has
            received public review and has been approved for publication by the
            Internet Engineering Steering Group (IESG).  Not all documents
            approved by the IESG are candidates for any level of Internet
            Standard; see Section 2 of RFC 7841.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
            Information about the current status of this document, any
            errata, and how to provide feedback on it may be obtained at
            <span><a href="https://www.rfc-editor.org/info/rfc9787">https://www.rfc-editor.org/info/rfc9787</a></span>.<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2025 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="auto internal xref">1.1</a>.  <a href="#name-terminology" class="internal xref">Terminology</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1.2.1">
                    <p id="section-toc.1-1.1.2.1.2.1.1" class="keepWithNext"><a href="#section-1.1.1" class="auto internal xref">1.1.1</a>.  <a href="#name-structural-header-fields" class="internal xref">Structural Header Fields</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1.2.2">
                    <p id="section-toc.1-1.1.2.1.2.2.1" class="keepWithNext"><a href="#section-1.1.2" class="auto internal xref">1.1.2</a>.  <a href="#name-user-facing-header-fields" class="internal xref">User-Facing Header Fields</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-usability" class="internal xref">Usability</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a href="#section-2.1" class="auto internal xref">2.1</a>.  <a href="#name-simplicity" class="internal xref">Simplicity</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a href="#section-2.2" class="auto internal xref">2.2</a>.  <a href="#name-email-users-want-a-familiar" class="internal xref">Email Users Want a Familiar Experience</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a href="#section-2.3" class="auto internal xref">2.3</a>.  <a href="#name-warning-about-failure-vs-an" class="internal xref">Warning About Failure vs. Announcing Success</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-types-of-protection" class="internal xref">Types of Protection</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-simplified-mental-model" class="internal xref">Simplified Mental Model</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-one-cryptographic-status-pe" class="internal xref">One Cryptographic Status per Message</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-cryptographic-mime-message-" class="internal xref">Cryptographic MIME Message Structure</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-cryptographic-layers" class="internal xref">Cryptographic Layers</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.1">
                    <p id="section-toc.1-1.4.2.1.2.1.1"><a href="#section-4.1.1" class="auto internal xref">4.1.1</a>.  <a href="#name-s-mime-cryptographic-layers" class="internal xref">S/MIME Cryptographic Layers</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.2">
                    <p id="section-toc.1-1.4.2.1.2.2.1"><a href="#section-4.1.2" class="auto internal xref">4.1.2</a>.  <a href="#name-pgp-mime-cryptographic-laye" class="internal xref">PGP/MIME Cryptographic Layers</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-cryptographic-envelope" class="internal xref">Cryptographic Envelope</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="auto internal xref">4.3</a>.  <a href="#name-cryptographic-payload" class="internal xref">Cryptographic Payload</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="auto internal xref">4.4</a>.  <a href="#name-types-of-cryptographic-enve" class="internal xref">Types of Cryptographic Envelope</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.1">
                    <p id="section-toc.1-1.4.2.4.2.1.1"><a href="#section-4.4.1" class="auto internal xref">4.4.1</a>.  <a href="#name-simple-cryptographic-envelo" class="internal xref">Simple Cryptographic Envelopes</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.2">
                    <p id="section-toc.1-1.4.2.4.2.2.1"><a href="#section-4.4.2" class="auto internal xref">4.4.2</a>.  <a href="#name-multilayer-cryptographic-en" class="internal xref">Multilayer Cryptographic Envelopes</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a href="#section-4.5" class="auto internal xref">4.5</a>.  <a href="#name-errant-cryptographic-layers" class="internal xref">Errant Cryptographic Layers</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.1">
                    <p id="section-toc.1-1.4.2.5.2.1.1"><a href="#section-4.5.1" class="auto internal xref">4.5.1</a>.  <a href="#name-mailing-list-wrapping" class="internal xref">Mailing List Wrapping</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.2">
                    <p id="section-toc.1-1.4.2.5.2.2.1"><a href="#section-4.5.2" class="auto internal xref">4.5.2</a>.  <a href="#name-a-baroque-example" class="internal xref">A Baroque Example</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6">
                <p id="section-toc.1-1.4.2.6.1"><a href="#section-4.6" class="auto internal xref">4.6</a>.  <a href="#name-cryptographic-summary" class="internal xref">Cryptographic Summary</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-message-composition" class="internal xref">Message Composition</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-message-composition-algorit" class="internal xref">Message Composition Algorithm</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-encryption-outside-signatur" class="internal xref">Encryption Outside, Signature Inside</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="auto internal xref">5.3</a>.  <a href="#name-avoid-offering-encrypted-on" class="internal xref">Avoid Offering Encrypted-Only Messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.4">
                <p id="section-toc.1-1.5.2.4.1"><a href="#section-5.4" class="auto internal xref">5.4</a>.  <a href="#name-composing-a-reply-message" class="internal xref">Composing a Reply Message</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-message-interpretation" class="internal xref">Message Interpretation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-rendering-well-formed-messa" class="internal xref">Rendering Well-Formed Messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-errant-cryptographic-layers-2" class="internal xref">Errant Cryptographic Layers</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.1">
                    <p id="section-toc.1-1.6.2.2.2.1.1"><a href="#section-6.2.1" class="auto internal xref">6.2.1</a>.  <a href="#name-errant-signing-layer" class="internal xref">Errant Signing Layer</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.2">
                    <p id="section-toc.1-1.6.2.2.2.2.1"><a href="#section-6.2.2" class="auto internal xref">6.2.2</a>.  <a href="#name-errant-encryption-layer" class="internal xref">Errant Encryption Layer</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.3">
                    <p id="section-toc.1-1.6.2.2.2.3.1"><a href="#section-6.2.3" class="auto internal xref">6.2.3</a>.  <a href="#name-avoiding-non-mime-cryptogra" class="internal xref">Avoiding Non-MIME Cryptographic Mechanisms</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="auto internal xref">6.3</a>.  <a href="#name-forwarded-messages-with-cry" class="internal xref">Forwarded Messages with Cryptographic Protection</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4">
                <p id="section-toc.1-1.6.2.4.1"><a href="#section-6.4" class="auto internal xref">6.4</a>.  <a href="#name-signature-failures" class="internal xref">Signature Failures</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5">
                <p id="section-toc.1-1.6.2.5.1"><a href="#section-6.5" class="auto internal xref">6.5</a>.  <a href="#name-weak-encryption" class="internal xref">Weak Encryption</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-reasoning-about-message-par" class="internal xref">Reasoning about Message Parts</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="auto internal xref">7.1</a>.  <a href="#name-main-body-part" class="internal xref">Main Body Part</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="auto internal xref">7.2</a>.  <a href="#name-attachments" class="internal xref">Attachments</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="auto internal xref">7.3</a>.  <a href="#name-mime-part-examples" class="internal xref">MIME Part Examples</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-certificate-management" class="internal xref">Certificate Management</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="auto internal xref">8.1</a>.  <a href="#name-peer-certificates" class="internal xref">Peer Certificates</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1.2.1">
                    <p id="section-toc.1-1.8.2.1.2.1.1"><a href="#section-8.1.1" class="auto internal xref">8.1.1</a>.  <a href="#name-peer-certificate-selection" class="internal xref">Peer Certificate Selection</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="auto internal xref">8.2</a>.  <a href="#name-local-certificates" class="internal xref">Local Certificates</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2.2.1">
                    <p id="section-toc.1-1.8.2.2.2.1.1"><a href="#section-8.2.1" class="auto internal xref">8.2.1</a>.  <a href="#name-getting-certificates-for-th" class="internal xref">Getting Certificates for the User</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2.2.2">
                    <p id="section-toc.1-1.8.2.2.2.2.1"><a href="#section-8.2.2" class="auto internal xref">8.2.2</a>.  <a href="#name-local-certificate-maintenan" class="internal xref">Local Certificate Maintenance</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2.2.3">
                    <p id="section-toc.1-1.8.2.2.2.3.1"><a href="#section-8.2.3" class="auto internal xref">8.2.3</a>.  <a href="#name-shipping-certificates-in-ou" class="internal xref">Shipping Certificates in Outbound Messages</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-common-pitfalls-and-guideli" class="internal xref">Common Pitfalls and Guidelines</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="auto internal xref">9.1</a>.  <a href="#name-reading-sent-messages" class="internal xref">Reading Sent Messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="auto internal xref">9.2</a>.  <a href="#name-reading-encrypted-messages-" class="internal xref">Reading Encrypted Messages after Certificate Expiration</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.3">
                <p id="section-toc.1-1.9.2.3.1"><a href="#section-9.3" class="auto internal xref">9.3</a>.  <a href="#name-unprotected-message-header-" class="internal xref">Unprotected Message Header Fields</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.4">
                <p id="section-toc.1-1.9.2.4.1"><a href="#section-9.4" class="auto internal xref">9.4</a>.  <a href="#name-composing-an-encrypted-mess" class="internal xref">Composing an Encrypted Message with Bcc</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.4.2.1">
                    <p id="section-toc.1-1.9.2.4.2.1.1"><a href="#section-9.4.1" class="auto internal xref">9.4.1</a>.  <a href="#name-simple-encryption-with-bcc" class="internal xref">Simple Encryption with Bcc</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.5">
                <p id="section-toc.1-1.9.2.5.1"><a href="#section-9.5" class="auto internal xref">9.5</a>.  <a href="#name-draft-messages" class="internal xref">Draft Messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.6">
                <p id="section-toc.1-1.9.2.6.1"><a href="#section-9.6" class="auto internal xref">9.6</a>.  <a href="#name-composing-a-message-to-hete" class="internal xref">Composing a Message to Heterogeneous Recipients</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.7">
                <p id="section-toc.1-1.9.2.7.1"><a href="#section-9.7" class="auto internal xref">9.7</a>.  <a href="#name-message-transport-protocol-" class="internal xref">Message Transport Protocol Proxy: A Dangerous Implementation Choice</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.7.2.1">
                    <p id="section-toc.1-1.9.2.7.2.1.1"><a href="#section-9.7.1" class="auto internal xref">9.7.1</a>.  <a href="#name-dangers-of-a-submission-pro" class="internal xref">Dangers of a Submission Proxy for Message Composition</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.7.2.2">
                    <p id="section-toc.1-1.9.2.7.2.2.1"><a href="#section-9.7.2" class="auto internal xref">9.7.2</a>.  <a href="#name-dangers-of-an-imap-proxy-fo" class="internal xref">Dangers of an IMAP Proxy for Message Rendering</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.7.2.3">
                    <p id="section-toc.1-1.9.2.7.2.3.1"><a href="#section-9.7.3" class="auto internal xref">9.7.3</a>.  <a href="#name-who-controls-the-proxy" class="internal xref">Who Controls the Proxy?</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.8">
                <p id="section-toc.1-1.9.2.8.1"><a href="#section-9.8" class="auto internal xref">9.8</a>.  <a href="#name-intervening-muas-do-not-han" class="internal xref">Intervening MUAs Do Not Handle End-to-End Cryptographic Protections</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.9">
                <p id="section-toc.1-1.9.2.9.1"><a href="#section-9.9" class="auto internal xref">9.9</a>.  <a href="#name-external-subresources-in-mi" class="internal xref">External Subresources in MIME Parts Break Cryptographic Protections</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1" class="auto internal xref">12.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2" class="auto internal xref">12.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#appendix-A" class="auto internal xref">Appendix A</a>.  <a href="#name-future-work" class="internal xref">Future Work</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#appendix-A.1" class="auto internal xref">A.1</a>.  <a href="#name-webmail-threat-model" class="internal xref">Webmail Threat Model</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#appendix-A.2" class="auto internal xref">A.2</a>.  <a href="#name-test-vectors" class="internal xref">Test Vectors</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.3">
                <p id="section-toc.1-1.13.2.3.1"><a href="#appendix-A.3" class="auto internal xref">A.3</a>.  <a href="#name-further-guidance-on-peer-ce" class="internal xref">Further Guidance on Peer Certificates</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.3.2.1">
                    <p id="section-toc.1-1.13.2.3.2.1.1"><a href="#appendix-A.3.1" class="auto internal xref">A.3.1</a>.  <a href="#name-certificate-discovery-from-" class="internal xref">Certificate Discovery from Incoming Messages</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.3.2.2">
                    <p id="section-toc.1-1.13.2.3.2.2.1"><a href="#appendix-A.3.2" class="auto internal xref">A.3.2</a>.  <a href="#name-certificate-directories" class="internal xref">Certificate Directories</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.3.2.3">
                    <p id="section-toc.1-1.13.2.3.2.3.1"><a href="#appendix-A.3.3" class="auto internal xref">A.3.3</a>.  <a href="#name-checking-for-certificate-re" class="internal xref">Checking for Certificate Revocation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.3.2.4">
                    <p id="section-toc.1-1.13.2.3.2.4.1"><a href="#appendix-A.3.4" class="auto internal xref">A.3.4</a>.  <a href="#name-further-peer-certificate-se" class="internal xref">Further Peer Certificate Selection</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.3.2.5">
                    <p id="section-toc.1-1.13.2.3.2.5.1"><a href="#appendix-A.3.5" class="auto internal xref">A.3.5</a>.  <a href="#name-human-readable-names-in-pee" class="internal xref">Human-Readable Names in Peer Certificates, Header Fields, and Address Books</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.4">
                <p id="section-toc.1-1.13.2.4.1"><a href="#appendix-A.4" class="auto internal xref">A.4</a>.  <a href="#name-further-guidance-on-local-c" class="internal xref">Further Guidance on Local Certificates and Secret Keys</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.4.2.1">
                    <p id="section-toc.1-1.13.2.4.2.1.1"><a href="#appendix-A.4.1" class="auto internal xref">A.4.1</a>.  <a href="#name-cross-mua-sharing-of-local-" class="internal xref">Cross-MUA Sharing of Local Certificates and Secret Keys</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.4.2.2">
                    <p id="section-toc.1-1.13.2.4.2.2.1"><a href="#appendix-A.4.2" class="auto internal xref">A.4.2</a>.  <a href="#name-use-of-smart-cards-or-other" class="internal xref">Use of Smart Cards or Other Portable Secret Key Mechanisms</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.4.2.3">
                    <p id="section-toc.1-1.13.2.4.2.3.1"><a href="#appendix-A.4.3" class="auto internal xref">A.4.3</a>.  <a href="#name-active-local-certificate-ma" class="internal xref">Active Local Certificate Maintenance</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.5">
                <p id="section-toc.1-1.13.2.5.1"><a href="#appendix-A.5" class="auto internal xref">A.5</a>.  <a href="#name-certification-authorities" class="internal xref">Certification Authorities</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.6">
                <p id="section-toc.1-1.13.2.6.1"><a href="#appendix-A.6" class="auto internal xref">A.6</a>.  <a href="#name-indexing-and-search-of-encr" class="internal xref">Indexing and Search of Encrypted Messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.7">
                <p id="section-toc.1-1.13.2.7.1"><a href="#appendix-A.7" class="auto internal xref">A.7</a>.  <a href="#name-cached-signature-validation" class="internal xref">Cached Signature Validation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.8">
                <p id="section-toc.1-1.13.2.8.1"><a href="#appendix-A.8" class="auto internal xref">A.8</a>.  <a href="#name-aggregate-cryptographic-sta" class="internal xref">Aggregate Cryptographic Status</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.9">
                <p id="section-toc.1-1.13.2.9.1"><a href="#appendix-A.9" class="auto internal xref">A.9</a>.  <a href="#name-expectations-of-cryptograph" class="internal xref">Expectations of Cryptographic Protection</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.10">
                <p id="section-toc.1-1.13.2.10.1"><a href="#appendix-A.10" class="auto internal xref">A.10</a>. <a href="#name-secure-deletion" class="internal xref">Secure Deletion</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.11">
                <p id="section-toc.1-1.13.2.11.1"><a href="#appendix-A.11" class="auto internal xref">A.11</a>. <a href="#name-interaction-with-opportunis" class="internal xref">Interaction with Opportunistic Encryption</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.12">
                <p id="section-toc.1-1.13.2.12.1"><a href="#appendix-A.12" class="auto internal xref">A.12</a>. <a href="#name-split-attachments" class="internal xref">Split Attachments</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.13">
                <p id="section-toc.1-1.13.2.13.1"><a href="#appendix-A.13" class="auto internal xref">A.13</a>. <a href="#name-proxy-extensions" class="internal xref">Proxy Extensions</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13.2.14">
                <p id="section-toc.1-1.13.2.14.1"><a href="#appendix-A.14" class="auto internal xref">A.14</a>. <a href="#name-mailing-lists" class="internal xref">Mailing Lists</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-acknowledgements" class="internal xref">Acknowledgements</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#appendix-C" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">End-to-end email security using S/MIME <span>[<a href="#RFC8551" class="cite xref">RFC8551</a>]</span> and PGP/MIME (Pretty Good Privacy with MIME) <span>[<a href="#RFC3156" class="cite xref">RFC3156</a>]</span> cryptographic standards can provide integrity, authentication, and confidentiality to MIME <span>[<a href="#RFC4289" class="cite xref">RFC4289</a>]</span> email messages.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">However, there are many ways that an MUA handling such a message can misinterpret or accidentally break these security guarantees.
For example, as described in <span>[<a href="#EFAIL" class="cite xref">EFAIL</a>]</span>, the "Direct Exfiltration" attack leaks cleartext due to an attack that splices existing ciphertext into a new message, which is then handled optimistically (and wrongly) by many MUAs.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">A MUA that interprets a message with end-to-end cryptographic protections needs to do so defensively, staying alert to different ways that these protections can be bypassed by mangling (either malicious or accidental) or a failed user experience.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">A MUA that generates a message with end-to-end cryptographic protections should be aware of these defensive interpretation strategies and should compose any new outbound message conservatively if they want the protections to remain intact.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">This document offers guidance to the implementer of a MUA that provides these cryptographic protections, whether for composing, interpreting, rendering, or replying to a message.
An implementation that follows this guidance will provide its users with stronger and easier-to-understand security properties and will also offer more reliable interoperability for messages exchanged with other implementations.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">In <a href="#future-work" class="auto internal xref">Appendix A</a>, this document also identifies a number of interoperability and usability concerns for end-to-end cryptographic email that have no current broadly accepted technical standard for resolution.
      One major area not covered in this document is the acquisition and long-term maintenance of cryptographic identity information and metadata across multiple MUAs controlled by the same user.<a href="#section-1-6" class="pilcrow">¶</a></p>
<div id="terminology">
<section id="section-1.1">
        <h3 id="name-terminology">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
        </h3>
<p id="section-1.1-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">For the purposes of this document, we define the following concepts:<a href="#section-1.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-3.1">
            <p id="section-1.1-3.1.1">The <em>Mail User Agent (MUA)</em> is an email client.<a href="#section-1.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-3.2">
            <p id="section-1.1-3.2.1"><em>Protection</em> of message data refers to cryptographic encryption and/or signatures, providing confidentiality, authenticity, and/or integrity.<a href="#section-1.1-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-3.3">
            <p id="section-1.1-3.3.1"><em>Cryptographic Layer</em>, <em>Cryptographic Envelope</em>, <em>Cryptographic Payload</em>, <em>Cryptographic Summary</em>, and <em>Errant Cryptographic Layer</em> are defined in <a href="#cryptographic-structure" class="auto internal xref">Section 4</a>.<a href="#section-1.1-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-3.4">
            <p id="section-1.1-3.4.1">A <em>well-formed</em> email message with cryptographic protection has both a <em>Cryptographic Envelope</em> and a <em>Cryptographic Payload</em>.<a href="#section-1.1-3.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-3.5">
            <p id="section-1.1-3.5.1"><em>Structural Header Fields</em> are documented in <a href="#structural-header-fields" class="auto internal xref">Section 1.1.1</a>.<a href="#section-1.1-3.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-3.6">
            <p id="section-1.1-3.6.1"><em>Non-Structural Header Fields</em> are header fields that are not Structural Header Fields.<a href="#section-1.1-3.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-3.7">
            <p id="section-1.1-3.7.1"><em>User-Facing Header Fields</em> are documented in <a href="#user-facing-header-fields" class="auto internal xref">Section 1.1.2</a>.<a href="#section-1.1-3.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-3.8">
            <p id="section-1.1-3.8.1">A <em>Main Body Part</em> is any part of a message that is typically rendered to the user as the message itself (not "as an attachment").  See <a href="#main-body-part" class="auto internal xref">Section 7.1</a>.<a href="#section-1.1-3.8.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-4">This document contains extensive discussion about end-to-end cryptographic protections in email while acknowledging that many MUAs have no capabilities for end-to-end cryptographic protections at all.
We divide MUAs into three distinct profiles:<a href="#section-1.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-5.1">
            <p id="section-1.1-5.1.1">A <em>non-cryptographic</em> MUA has no capabilities for end-to-end cryptographic protections.<a href="#section-1.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.2">
            <p id="section-1.1-5.2.1">A <em>conformant</em> MUA follows the guidance in this document when dealing with end-to-end cryptographic protections.<a href="#section-1.1-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.3">
            <p id="section-1.1-5.3.1">A <em>legacy</em> MUA has capabilities for end-to-end cryptographic protections but does not adhere to the guidance in this document.<a href="#section-1.1-5.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-6">At the time of the writing of this document, most MUAs with cryptographic protections are legacy MUAs.<a href="#section-1.1-6" class="pilcrow">¶</a></p>
<div id="structural-header-fields">
<section id="section-1.1.1">
          <h4 id="name-structural-header-fields">
<a href="#section-1.1.1" class="section-number selfRef">1.1.1. </a><a href="#name-structural-header-fields" class="section-name selfRef">Structural Header Fields</a>
          </h4>
<p id="section-1.1.1-1">A message header field named <code>MIME-Version</code>, or whose name begins with <code>Content-</code>, is referred to in this document as a "structural" header field.
This is a less-ambiguous name for what <span>[<a href="#RFC2045" class="cite xref">RFC2045</a>]</span> calls "MIME header fields".<a href="#section-1.1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1.1-2">These header fields indicate something about the specific MIME part they are attached to and cannot be transferred or copied to other parts without endangering the readability of the message.<a href="#section-1.1.1-2" class="pilcrow">¶</a></p>
<p id="section-1.1.1-3">This includes:<a href="#section-1.1.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1.1-4.1">
              <p id="section-1.1.1-4.1.1"><code>MIME-Version</code><a href="#section-1.1.1-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.1-4.2">
              <p id="section-1.1.1-4.2.1"><code>Content-Type</code><a href="#section-1.1.1-4.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.1-4.3">
              <p id="section-1.1.1-4.3.1"><code>Content-Transfer-Encoding</code><a href="#section-1.1.1-4.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.1-4.4">
              <p id="section-1.1.1-4.4.1"><code>Content-Disposition</code><a href="#section-1.1.1-4.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
<div id="user-facing-header-fields">
<section id="section-1.1.2">
          <h4 id="name-user-facing-header-fields">
<a href="#section-1.1.2" class="section-number selfRef">1.1.2. </a><a href="#name-user-facing-header-fields" class="section-name selfRef">User-Facing Header Fields</a>
          </h4>
<p id="section-1.1.2-1">Of all the header fields that an email message may contain, only a small subset are typically presented directly to the user.
This document refers to them as User-Facing Header Fields.
Typically, User-Facing Header Fields are:<a href="#section-1.1.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1.2-2.1">
              <p id="section-1.1.2-2.1.1"><code>Subject</code><a href="#section-1.1.2-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.2">
              <p id="section-1.1.2-2.2.1"><code>From</code><a href="#section-1.1.2-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.3">
              <p id="section-1.1.2-2.3.1"><code>To</code><a href="#section-1.1.2-2.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.4">
              <p id="section-1.1.2-2.4.1"><code>Cc</code><a href="#section-1.1.2-2.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.5">
              <p id="section-1.1.2-2.5.1"><code>Date</code><a href="#section-1.1.2-2.5.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.6">
              <p id="section-1.1.2-2.6.1"><code>Reply-To</code><a href="#section-1.1.2-2.6.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.7">
              <p id="section-1.1.2-2.7.1"><code>Followup-To</code><a href="#section-1.1.2-2.7.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.8">
              <p id="section-1.1.2-2.8.1"><code>Sender</code><a href="#section-1.1.2-2.8.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.9">
              <p id="section-1.1.2-2.9.1"><code>Resent-From</code><a href="#section-1.1.2-2.9.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.10">
              <p id="section-1.1.2-2.10.1"><code>Resent-To</code><a href="#section-1.1.2-2.10.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.11">
              <p id="section-1.1.2-2.11.1"><code>Resent-Cc</code><a href="#section-1.1.2-2.11.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.12">
              <p id="section-1.1.2-2.12.1"><code>Resent-Date</code><a href="#section-1.1.2-2.12.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-1.1.2-2.13">
              <p id="section-1.1.2-2.13.1"><code>Resent-Sender</code><a href="#section-1.1.2-2.13.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-1.1.2-3">The above list contains the header fields most often presented directly to the user who views a message, though an MUA may also decide to treat any other header field as "User-Facing".
Of course, many of these header fields are entirely absent from any given message, and an absent header field is not presented to the user at all.<a href="#section-1.1.2-3" class="pilcrow">¶</a></p>
<p id="section-1.1.2-4">Note that the resending header fields (those beginning with <code>Resent-</code>) are typically only added by an intervening MUA (see <span><a href="https://rfc-editor.org/rfc/rfc5322#section-3.6.6" class="relref">Section 3.6.6</a> of [<a href="#RFC5322" class="cite xref">RFC5322</a>]</span> and <a href="#intervening-mua" class="auto internal xref">Section 9.8</a> of this document).
As such, though they may in some cases be presented to the user, they will typically not bear any end-to-end cryptographic protection (even if the original header fields of a message are protected; see <a href="#message-header-fields" class="auto internal xref">Section 9.3</a>), because they are unknown to the original sender.<a href="#section-1.1.2-4" class="pilcrow">¶</a></p>
<p id="section-1.1.2-5">Other header fields may affect the visible rendering of the message (e.g., <code>References</code> and <code>In-Reply-To</code> may affect the placement of a message in a threaded discussion, or the <code>List-*</code> and <code>Archived-At</code> header fields added by mailing lists may cause additional buttons to be displayed during rendering), but they are not directly displayed to the user and so are not considered "User-Facing".<a href="#section-1.1.2-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="usability">
<section id="section-2">
      <h2 id="name-usability">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-usability" class="section-name selfRef">Usability</a>
      </h2>
<p id="section-2-1">Any MUA that enables its user to transition from unprotected messages to messages with end-to-end cryptographic protection needs to consider how the user understands this transition.
That said, the primary goal of the user of an MUA is communication -- so interface elements that interfere with communication should be avoided where possible.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">Furthermore, it is a near certainty that the user will continue to encounter unprotected messages and may need to send unprotected messages (for example, if a given recipient cannot handle cryptographic protections).
This means that the MUA needs to provide the user with some guidance so that they understand what protections any given message or conversation has.
But the user should not be overwhelmed with choices or presented with unactionable information.<a href="#section-2-2" class="pilcrow">¶</a></p>
<div id="simplicity">
<section id="section-2.1">
        <h3 id="name-simplicity">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-simplicity" class="section-name selfRef">Simplicity</a>
        </h3>
<p id="section-2.1-1">The end user (the operator of the MUA) is unlikely to understand complex end-to-end cryptographic protections on any email message, so keep it simple.<a href="#section-2.1-1" class="pilcrow">¶</a></p>
<p id="section-2.1-2">For clarity to the user, any cryptographic protections should apply to the message as a whole, not just to some subparts.<a href="#section-2.1-2" class="pilcrow">¶</a></p>
<p id="section-2.1-3">This is true for message composition: The standard message composition user interface of an MUA should offer minimal controls that indicate which types of protection to apply to the new message as a whole.<a href="#section-2.1-3" class="pilcrow">¶</a></p>
<p id="section-2.1-4">This is also true for message interpretation: The standard message rendering user interface of an MUA should offer a minimal, clear indicator about the end-to-end cryptographic status of the message as a whole.<a href="#section-2.1-4" class="pilcrow">¶</a></p>
<p id="section-2.1-5">See <a href="#types-of-protection" class="auto internal xref">Section 3</a> for more details about mental models and cryptographic status.<a href="#section-2.1-5" class="pilcrow">¶</a></p>
<aside id="section-2.1-6">
          <p id="section-2.1-6.1">(It is of course possible that a message forwarded as a MIME attachment could have its own cryptographic status while still being a message subpart, but that status should be distinct from the status of the enclosing message.)<a href="#section-2.1-6.1" class="pilcrow">¶</a></p>
</aside>
</section>
</div>
<div id="similar-ux">
<section id="section-2.2">
        <h3 id="name-email-users-want-a-familiar">
<a href="#section-2.2" class="section-number selfRef">2.2. </a><a href="#name-email-users-want-a-familiar" class="section-name selfRef">Email Users Want a Familiar Experience</a>
        </h3>
<p id="section-2.2-1">A person communicating over the Internet today often has many options for reaching their desired correspondent, including web-based bulletin boards, contact forms, and instant messaging services.<a href="#section-2.2-1" class="pilcrow">¶</a></p>
<p id="section-2.2-2">Email offers a few distinctions from these other systems, most notably features like:<a href="#section-2.2-2" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2.2-3">
          <dt id="section-2.2-3.1">Ubiquity:</dt>
          <dd style="margin-left: 1.5em" id="section-2.2-3.2">Most correspondents will have an email address, while not everyone is present on the various non-email messaging services, particularly those that have reliable end-to-end cryptographic protections.<a href="#section-2.2-3.2" class="pilcrow">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-2.2-3.3">Federation:</dt>
          <dd style="margin-left: 1.5em" id="section-2.2-3.4">Interaction between users on distinct domains who have not agreed on a common communications provider is still possible.<a href="#section-2.2-3.4" class="pilcrow">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-2.2-3.5">User Control:</dt>
          <dd style="margin-left: 1.5em" id="section-2.2-3.6">The user can interact with the email system using an MUA of their choosing, including automation and other control over their preferred and/or customized workflow.<a href="#section-2.2-3.6" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
</dl>
<p id="section-2.2-4">Other systems (like some popular instant messaging applications, such as WhatsApp and Signal Private Messenger) offer built-in end-to-end cryptographic protections by default, which are simpler for the user to understand.
("All the messages I see on Signal are confidential and integrity-protected" is a clean user story.)<a href="#section-2.2-4" class="pilcrow">¶</a></p>
<p id="section-2.2-5">A user of email is likely using email instead of other systems because of the distinctions outlined above.
When adding end-to-end cryptographic protection to an email endpoint, care should be taken not to negate any of the distinct features of email as a whole.
If these features are violated to provide end-to-end cryptographic protection, the user may just as well choose one of the other systems that don't have the drawbacks that email has.
Implementers should try to provide end-to-end protections that retain the familiar experience of email itself.<a href="#section-2.2-5" class="pilcrow">¶</a></p>
<p id="section-2.2-6">Furthermore, an email user is likely to regularly interact with other email correspondents who <em>cannot</em> handle or produce end-to-end cryptographic protections.
Care should be taken when enabling cryptography in an MUA so that the MUA does not inadvertently limit the ability of the user to interact with correspondents who use legacy or non-cryptographic MUAs.<a href="#section-2.2-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-indicators">
<section id="section-2.3">
        <h3 id="name-warning-about-failure-vs-an">
<a href="#section-2.3" class="section-number selfRef">2.3. </a><a href="#name-warning-about-failure-vs-an" class="section-name selfRef">Warning About Failure vs. Announcing Success</a>
        </h3>
<p id="section-2.3-1">Moving the Web from http to https offers useful historical similarities to adding end-to-end encryption to email.<a href="#section-2.3-1" class="pilcrow">¶</a></p>
<p id="section-2.3-2">In particular, the indicators of what is "secure" vs. "insecure" for web browsers have changed over time.
For example, years ago, the default experience was http, and https sites were flagged with "secure" indicators like a lock icon.
 Starting in 2018, some browsers reversed that process by downplaying https and instead visibly marking http as "not secure" (see <span>[<a href="#CHROME-INDICATORS" class="cite xref">CHROME-INDICATORS</a>]</span>).<a href="#section-2.3-2" class="pilcrow">¶</a></p>
<p id="section-2.3-3">By analogy, when the user of an MUA first enables end-to-end cryptographic protection, it's likely that they will want to see which messages <em>have</em> protection (that is, the security indicators amenable to a conformant MUA as of 2025 are most likely to be comparable to those of a pre-2018 web browser).
But a user whose private email communications with a given correspondent, or within a given domain, are known to be entirely end-to-end protected might instead want to know which messages do <em>not</em> have the expected protections.<a href="#section-2.3-3" class="pilcrow">¶</a></p>
<p id="section-2.3-4">Note also that some messages may be expected to be confidential, but other messages are expected to be public -- the types of protection (see <a href="#types-of-protection" class="auto internal xref">Section 3</a>) that apply to each particular message will be different.
 And the types of protection that are <em>expected</em> to be present in any context might differ (for example, by sender, by thread, or by date).<a href="#section-2.3-4" class="pilcrow">¶</a></p>
<p id="section-2.3-5">It is out of scope for this document to define expectations about protections for any given message, but an implementer who cares about offering a simple user experience should be deliberate and judicious about the expectations their interface assumes that the user has in a given context.
See <a href="#expect-e2e" class="auto internal xref">Appendix A.9</a> for future work.<a href="#section-2.3-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="types-of-protection">
<section id="section-3">
      <h2 id="name-types-of-protection">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-types-of-protection" class="section-name selfRef">Types of Protection</a>
      </h2>
<p id="section-3-1">A given message might be:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.1">
          <p id="section-3-2.1.1">signed,<a href="#section-3-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.2">
          <p id="section-3-2.2.1">encrypted,<a href="#section-3-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.3">
          <p id="section-3-2.3.1">both signed and encrypted, or<a href="#section-3-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.4">
          <p id="section-3-2.4.1">none of the above.<a href="#section-3-2.4.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-3">Given that many email messages offer no cryptographic protections, the user needs to be able to detect which protections are present for any given message.<a href="#section-3-3" class="pilcrow">¶</a></p>
<div id="simple-mental-model">
<section id="section-3.1">
        <h3 id="name-simplified-mental-model">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-simplified-mental-model" class="section-name selfRef">Simplified Mental Model</a>
        </h3>
<p id="section-3.1-1">To the extent that an email message actually does have end-to-end cryptographic protections, those protections need to be visible and comprehensible to the end users: both the composing user and the recipient who views the rendered message.
If either user is unaware of the protections, then they do not effectively extend all the way to the "end".<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">However, most users do not have (or want to have) a sophisticated mental model of what kinds of protections can be associated with a given message.
Even the four states above approach the limits of complexity for an interface for normal users.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1-3">While <a href="#no-encrypted-only" class="auto internal xref">Section 5.3</a> recommends avoiding deliberate creation of encrypted-only messages, some messages may end up in the encrypted-only state due to signature failure or certificate revocation.<a href="#section-3.1-3" class="pilcrow">¶</a></p>
<p id="section-3.1-4">A simple model for the recipient could be that a message is in one of three normal states, which align with the only reasonable choices for message composition:<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-5.1">
            <p id="section-3.1-5.1.1">Unprotected<a href="#section-3.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.1-5.2">
            <p id="section-3.1-5.2.1">Verified (has a valid signature from the apparent sender of the message)<a href="#section-3.1-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.1-5.3">
            <p id="section-3.1-5.3.1">Confidential (encrypted with a valid signature from the apparent sender of the message)<a href="#section-3.1-5.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.1-6">However, one error state exists for rendered mail that does not correspond to a reasonable choice for message composition:<a href="#section-3.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-7.1">
            <p id="section-3.1-7.1.1">Encrypted But Unverified (encrypted without a valid signature from the apparent sender of the message)<a href="#section-3.1-7.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.1-8">Note that this last state is not "Confidential" (a secret shared exclusively between the participants in the communication) because the recipient does not know for sure who sent it.<a href="#section-3.1-8" class="pilcrow">¶</a></p>
<p id="section-3.1-9">In an ecosystem where encrypted-only messages are never deliberately sent (see <a href="#no-encrypted-only" class="auto internal xref">Section 5.3</a>), representing an Encrypted But Unverified message as a type of user-visible error is not unreasonable.
However, this is not the state of the global email ecosystem when this document was written, since some legacy MUAs permit composing encrypted-but-unsigned mail (see <a href="#expect-e2e" class="auto internal xref">Appendix A.9</a> for possible future guidance).<a href="#section-3.1-9" class="pilcrow">¶</a></p>
<p id="section-3.1-10">Alternately, an MUA may prefer to represent the state of an Encrypted But Unverified message to the user as though it was Unprotected since no verification is possible.
However the MUA represents the message to the user, it <span class="bcp14">MUST NOT</span> leak cleartext of an encrypted message (even an Encrypted But Unverified message) in subsequent replies (see <a href="#composing-reply" class="auto internal xref">Section 5.4</a>) or similar replications of the message.<a href="#section-3.1-10" class="pilcrow">¶</a></p>
<p id="section-3.1-11">Note that a cleartext message with an invalid signature <span class="bcp14">SHOULD NOT</span> be represented to the user as anything other than Unprotected (see <a href="#signature-failures" class="auto internal xref">Section 6.4</a>) unless the MUA is providing the user with debugging information.<a href="#section-3.1-11" class="pilcrow">¶</a></p>
<p id="section-3.1-12">At the time this document was written, the global email ecosystem contains a heterogeneous mix of legacy and non-cryptographic MUAs.
In such an ecosystem, a conformant MUA may instead prefer to represent "Verified" and "Encrypted" as orthogonal states of any given rendered message.
While this model does not precisely match the choice a user makes when composing a message, it may align more with the reality of the range of messages they encounter as a recipient.<a href="#section-3.1-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="one-cryptographic-status-per-message">
<section id="section-3.2">
        <h3 id="name-one-cryptographic-status-pe">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-one-cryptographic-status-pe" class="section-name selfRef">One Cryptographic Status per Message</a>
        </h3>
<p id="section-3.2-1">Some MUAs may attempt to generate multiple copies of a given email message, with different copies offering different types of protection (for example, opportunistically encrypting on a per-recipient basis).
A message resulting from this approach will have a cryptographic state that few users will understand.
Even if the composer understands the different statuses of the different copies, the recipients of the messages may not understand (each recipient might not even know about the other copies).
See, for example, the discussion in <a href="#mixed-recipients" class="auto internal xref">Section 9.6</a> for how this can go wrong.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">For comprehensibility, a conformant MUA <span class="bcp14">SHOULD NOT</span> create multiple copies of a given message that differ in the types of end-to-end cryptographic protections afforded.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">For opportunistic cryptographic protections that are not surfaced to the user (that is, that are not end-to-end), other mechanisms like transport encryption <span>[<a href="#RFC3207" class="cite xref">RFC3207</a>]</span> or domain-based signing <span>[<a href="#RFC6376" class="cite xref">RFC6376</a>]</span> may be preferable due to ease of implementation and deployment.
These opportunistic transport protections are orthogonal to the end-to-end protections described in this document.<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<p id="section-3.2-4">To the extent that opportunistic message protections are made visible to the user for a given copy of a message, a conformant MUA will distinguish that status from the message's end-to-end cryptographic status.
But the potential confusion caused by rendering this complex, hybrid state may not be worth the value of additional knowledge gained by the user.
The benefits of opportunistic protections accrue (or don't) even without visibility to the user (see <span>[<a href="#RFC7435" class="cite xref">RFC7435</a>]</span>).<a href="#section-3.2-4" class="pilcrow">¶</a></p>
<p id="section-3.2-5">The user needs a single clear, simple, and correct indication about the end-to-end cryptographic status of any given message.
See <a href="#cryptographic-summary" class="auto internal xref">Section 4.6</a> for more details.<a href="#section-3.2-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="cryptographic-structure">
<section id="section-4">
      <h2 id="name-cryptographic-mime-message-">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-cryptographic-mime-message-" class="section-name selfRef">Cryptographic MIME Message Structure</a>
      </h2>
<p id="section-4-1">Implementations use the structure of an email message to establish (when composing) and understand (when rendering) the cryptographic status of the message.
This section establishes some conventions about how to think about message structure.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div id="cryptographic-layer">
<section id="section-4.1">
        <h3 id="name-cryptographic-layers">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-cryptographic-layers" class="section-name selfRef">Cryptographic Layers</a>
        </h3>
<p id="section-4.1-1">"Cryptographic Layer" refers to a MIME substructure that supplies some cryptographic protections to an internal MIME subtree.
The internal subtree is known as the "protected part", though of course it may itself be a multipart object.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">In the diagrams below, <span class="unicode">"╧" (BOX DRAWINGS UP SINGLE AND HORIZONTAL DOUBLE, U+2567)</span> indicates "decrypts to" and <span class="unicode">"┴" (BOX DRAWINGS LIGHT UP AND HORIZONTAL, U+2534)</span> indicates "unwraps to".<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<div id="smime-cryptographic-layers">
<section id="section-4.1.1">
          <h4 id="name-s-mime-cryptographic-layers">
<a href="#section-4.1.1" class="section-number selfRef">4.1.1. </a><a href="#name-s-mime-cryptographic-layers" class="section-name selfRef">S/MIME Cryptographic Layers</a>
          </h4>
<p id="section-4.1.1-1">For S/MIME <span>[<a href="#RFC8551" class="cite xref">RFC8551</a>]</span>, there are four forms of Cryptographic Layers: multipart/signed, PKCS #7 signed-data, PKCS #7 enveloped-data, and PKCS #7 authEnveloped-data.<a href="#section-4.1.1-1" class="pilcrow">¶</a></p>
<div id="smime-multipart-signed">
<section id="section-4.1.1.1">
            <h5 id="name-s-mime-multipart-signed-cry">
<a href="#section-4.1.1.1" class="section-number selfRef">4.1.1.1. </a><a href="#name-s-mime-multipart-signed-cry" class="section-name selfRef">S/MIME Multipart Signed Cryptographic Layer</a>
            </h5>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.1.1.1-1">
<pre>
└┬╴multipart/signed; protocol="application/pkcs7-signature"
 ├─╴[protected part]
 └─╴application/pkcs7-signature
</pre><a href="#section-4.1.1.1-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1.1-2">This MIME layer offers authentication and integrity.<a href="#section-4.1.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="smime-pkcs7-signed-data">
<section id="section-4.1.1.2">
            <h5 id="name-s-mime-pkcs-7-signed-data-c">
<a href="#section-4.1.1.2" class="section-number selfRef">4.1.1.2. </a><a href="#name-s-mime-pkcs-7-signed-data-c" class="section-name selfRef">S/MIME PKCS #7 signed-data Cryptographic Layer</a>
            </h5>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.1.1.2-1">
<pre>
└┬╴application/pkcs7-mime; smime-type="signed-data"
 ┴ (unwraps to)
 └─╴[protected part]
</pre><a href="#section-4.1.1.2-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1.2-2">This MIME layer offers authentication and integrity.<a href="#section-4.1.1.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="smime-pkcs7-enveloped-data">
<section id="section-4.1.1.3">
            <h5 id="name-s-mime-pkcs-7-enveloped-dat">
<a href="#section-4.1.1.3" class="section-number selfRef">4.1.1.3. </a><a href="#name-s-mime-pkcs-7-enveloped-dat" class="section-name selfRef">S/MIME PKCS #7 enveloped-data Cryptographic Layer</a>
            </h5>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.1.1.3-1">
<pre>
└┬╴application/pkcs7-mime; smime-type="enveloped-data"
 ╧ (decrypts to)
 └─╴[protected part]
</pre><a href="#section-4.1.1.3-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1.3-2">This MIME layer offers confidentiality.<a href="#section-4.1.1.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="smime-pkcs7-authenveloped-data">
<section id="section-4.1.1.4">
            <h5 id="name-s-mime-pkcs-7-authenveloped">
<a href="#section-4.1.1.4" class="section-number selfRef">4.1.1.4. </a><a href="#name-s-mime-pkcs-7-authenveloped" class="section-name selfRef">S/MIME PKCS #7 authEnveloped-data Cryptographic Layer</a>
            </h5>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.1.1.4-1">
<pre>
└┬╴application/pkcs7-mime; smime-type="authEnveloped-data"
 ╧ (decrypts to)
 └─╴[protected part]
</pre><a href="#section-4.1.1.4-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1.4-2">This MIME layer offers confidentiality and integrity.<a href="#section-4.1.1.4-2" class="pilcrow">¶</a></p>
<p id="section-4.1.1.4-3">Note that <code>enveloped-data</code> (<a href="#smime-pkcs7-enveloped-data" class="auto internal xref">Section 4.1.1.3</a>) and <code>authEnveloped-data</code> (<a href="#smime-pkcs7-authenveloped-data" class="auto internal xref">Section 4.1.1.4</a>) have identical message structures and very similar confidentiality semantics.
The only difference between the two is ciphertext malleability.<a href="#section-4.1.1.4-3" class="pilcrow">¶</a></p>
<p id="section-4.1.1.4-4">The examples in this document only include <code>enveloped-data</code>, but the implications for that layer apply to <code>authEnveloped-data</code> as well.<a href="#section-4.1.1.4-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="pkcs7-compression-is-not-a-cryptographic-layer">
<section id="section-4.1.1.5">
            <h5 id="name-pkcs-7-compression-is-not-a">
<a href="#section-4.1.1.5" class="section-number selfRef">4.1.1.5. </a><a href="#name-pkcs-7-compression-is-not-a" class="section-name selfRef">PKCS #7 Compression is NOT a Cryptographic Layer</a>
            </h5>
<p id="section-4.1.1.5-1">The Cryptographic Message Syntax (CMS) provides a MIME compression layer (<code>smime-type="compressed-data"</code>), as defined in <span>[<a href="#RFC3274" class="cite xref">RFC3274</a>]</span>.
While the compression layer is technically a part of CMS, it is not considered a Cryptographic Layer for the purposes of this document.<a href="#section-4.1.1.5-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="pgpmime-cryptographic-layers">
<section id="section-4.1.2">
          <h4 id="name-pgp-mime-cryptographic-laye">
<a href="#section-4.1.2" class="section-number selfRef">4.1.2. </a><a href="#name-pgp-mime-cryptographic-laye" class="section-name selfRef">PGP/MIME Cryptographic Layers</a>
          </h4>
<p id="section-4.1.2-1">For PGP/MIME <span>[<a href="#RFC3156" class="cite xref">RFC3156</a>]</span>, there are two forms of Cryptographic Layers: signing and encryption.<a href="#section-4.1.2-1" class="pilcrow">¶</a></p>
<div id="pgpmime-multipart-signed">
<section id="section-4.1.2.1">
            <h5 id="name-pgp-mime-signing-cryptograp">
<a href="#section-4.1.2.1" class="section-number selfRef">4.1.2.1. </a><a href="#name-pgp-mime-signing-cryptograp" class="section-name selfRef">PGP/MIME Signing Cryptographic Layer (multipart/signed)</a>
            </h5>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.1.2.1-1">
<pre>
└┬╴multipart/signed; protocol="application/pgp-signature"
 ├─╴[protected part]
 └─╴application/pgp-signature
</pre><a href="#section-4.1.2.1-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.2.1-2">This MIME layer offers authenticity and integrity.<a href="#section-4.1.2.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="pgpmime-multipart-encrypted">
<section id="section-4.1.2.2">
            <h5 id="name-pgp-mime-encryption-cryptog">
<a href="#section-4.1.2.2" class="section-number selfRef">4.1.2.2. </a><a href="#name-pgp-mime-encryption-cryptog" class="section-name selfRef">PGP/MIME Encryption Cryptographic Layer (multipart/encrypted)</a>
            </h5>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.1.2.2-1">
<pre>
└┬╴multipart/encrypted
 ├─╴application/pgp-encrypted
 └┬╴application/octet-stream
  ╧ (decrypts to)
  └─╴[protected part]
</pre><a href="#section-4.1.2.2-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.2.2-2">This MIME layer can offer:<a href="#section-4.1.2.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2.2-3.1">
                <p id="section-4.1.2.2-3.1.1">confidentiality (via a Symmetrically Encrypted Data Packet, see <span><a href="https://rfc-editor.org/rfc/rfc9580#section-5.7" class="relref">Section 5.7</a> of [<a href="#RFC9580" class="cite xref">RFC9580</a>]</span>; an MUA <span class="bcp14">MUST NOT</span> generate this form due to ciphertext malleability),<a href="#section-4.1.2.2-3.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.1.2.2-3.2">
                <p id="section-4.1.2.2-3.2.1">confidentiality and integrity (via a Symmetrically Encrypted and Integrity Protected Data Packet (SEIPD); see <span><a href="https://rfc-editor.org/rfc/rfc9580#section-5.13" class="relref">Section 5.13</a> of [<a href="#RFC9580" class="cite xref">RFC9580</a>]</span>), or<a href="#section-4.1.2.2-3.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.1.2.2-3.3">
                <p id="section-4.1.2.2-3.3.1">confidentiality, integrity, and authenticity all together (by including an OpenPGP Signature Packet, see <span><a href="https://rfc-editor.org/rfc/rfc9580#section-5.2" class="relref">Section 5.2</a> of [<a href="#RFC9580" class="cite xref">RFC9580</a>]</span>, within the SEIPD).<a href="#section-4.1.2.2-3.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="cryptographic-envelope">
<section id="section-4.2">
        <h3 id="name-cryptographic-envelope">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-cryptographic-envelope" class="section-name selfRef">Cryptographic Envelope</a>
        </h3>
<p id="section-4.2-1">The Cryptographic Envelope is the largest contiguous set of Cryptographic Layers of an email message starting with the outermost MIME type (that is, with the Content-Type of the message itself).<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2-2">If the Content-Type of the message itself is not a Cryptographic Layer, then the message has no Cryptographic Envelope.<a href="#section-4.2-2" class="pilcrow">¶</a></p>
<p id="section-4.2-3">"Contiguous" in the definition above indicates that if a Cryptographic Layer is the protected part of another Cryptographic Layer, the layers together comprise a single Cryptographic Envelope.<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<p id="section-4.2-4">Note that if a non-Cryptographic Layer intervenes, all Cryptographic Layers within the non-Cryptographic Layer <em>are not</em> part of the Cryptographic Envelope.
They are Errant Cryptographic Layers (see <a href="#errant-cryptographic-layers" class="auto internal xref">Section 4.5</a>).<a href="#section-4.2-4" class="pilcrow">¶</a></p>
<p id="section-4.2-5">Also note that the ordering of the Cryptographic Layers implies different cryptographic properties.
A signed-then-encrypted message is different than an encrypted-then-signed message.
See <a href="#sign-then-encrypt" class="auto internal xref">Section 5.2</a>.<a href="#section-4.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cryptographic-payload">
<section id="section-4.3">
        <h3 id="name-cryptographic-payload">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-cryptographic-payload" class="section-name selfRef">Cryptographic Payload</a>
        </h3>
<p id="section-4.3-1">The Cryptographic Payload of a message is the first non-Cryptographic Layer -- the "protected part" -- within the Cryptographic Envelope.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="types-of-cryptographic-envelope">
<section id="section-4.4">
        <h3 id="name-types-of-cryptographic-enve">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-types-of-cryptographic-enve" class="section-name selfRef">Types of Cryptographic Envelope</a>
        </h3>
<div id="simple-cryptographic-envelopes">
<section id="section-4.4.1">
          <h4 id="name-simple-cryptographic-envelo">
<a href="#section-4.4.1" class="section-number selfRef">4.4.1. </a><a href="#name-simple-cryptographic-envelo" class="section-name selfRef">Simple Cryptographic Envelopes</a>
          </h4>
<p id="section-4.4.1-1">As described above, if the "protected part" identified in the section above is not itself a Cryptographic Layer, that part <em>is</em> the Cryptographic Payload.<a href="#section-4.4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.4.1-2">If the application wants to generate a message that is both encrypted and signed, it <span class="bcp14">MAY</span> use the simple MIME structure from <a href="#pgpmime-multipart-encrypted" class="auto internal xref">Section 4.1.2.2</a> by ensuring that the <span>[<a href="#RFC9580" class="cite xref">RFC9580</a>]</span> Encrypted Message within the <code>application/octet-stream</code> part contains a <span>[<a href="#RFC9580" class="cite xref">RFC9580</a>]</span> Signed Message (the final option described in <a href="#pgpmime-multipart-encrypted" class="auto internal xref">Section 4.1.2.2</a>).<a href="#section-4.4.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="multilayer-cryptographic-envelopes">
<section id="section-4.4.2">
          <h4 id="name-multilayer-cryptographic-en">
<a href="#section-4.4.2" class="section-number selfRef">4.4.2. </a><a href="#name-multilayer-cryptographic-en" class="section-name selfRef">Multilayer Cryptographic Envelopes</a>
          </h4>
<p id="section-4.4.2-1">It is possible to construct a Cryptographic Envelope consisting of multiple layers with either S/MIME or PGP/MIME, for example, using the following structure:<a href="#section-4.4.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.4.2-2">
<pre>
A └┬╴application/pkcs7-mime; smime-type="enveloped-data"
B  ╧ (decrypts to)
C  └┬╴application/pkcs7-mime; smime-type="signed-data"
D   ┴ (unwraps to)
E   └─╴[protected part]
</pre><a href="#section-4.4.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.4.2-3">When handling such a message, the properties of the Cryptographic Envelope are derived from the series <code>A</code> and <code>C</code>.<a href="#section-4.4.2-3" class="pilcrow">¶</a></p>
<p id="section-4.4.2-4">As noted in <a href="#simple-cryptographic-envelopes" class="auto internal xref">Section 4.4.1</a>, PGP/MIME applications also have a simpler MIME construction available with the same cryptographic properties.<a href="#section-4.4.2-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="errant-cryptographic-layers">
<section id="section-4.5">
        <h3 id="name-errant-cryptographic-layers">
<a href="#section-4.5" class="section-number selfRef">4.5. </a><a href="#name-errant-cryptographic-layers" class="section-name selfRef">Errant Cryptographic Layers</a>
        </h3>
<p id="section-4.5-1">Due to confusion, malice, message forwarding, or well-intentioned tampering, a message may contain a Cryptographic Layer that is not part of the Cryptographic Envelope.
Such a layer is an Errant Cryptographic Layer.<a href="#section-4.5-1" class="pilcrow">¶</a></p>
<p id="section-4.5-2">An Errant Cryptographic Layer <span class="bcp14">MUST NOT</span> contribute to the message's overall cryptographic state.<a href="#section-4.5-2" class="pilcrow">¶</a></p>
<p id="section-4.5-3">Guidance for dealing with Errant Cryptographic Layers can be found in <a href="#errant-layers" class="auto internal xref">Section 6.2</a>.<a href="#section-4.5-3" class="pilcrow">¶</a></p>
<div id="mailing-list-wrapping">
<section id="section-4.5.1">
          <h4 id="name-mailing-list-wrapping">
<a href="#section-4.5.1" class="section-number selfRef">4.5.1. </a><a href="#name-mailing-list-wrapping" class="section-name selfRef">Mailing List Wrapping</a>
          </h4>
<p id="section-4.5.1-1">Some mailing list software will rewrap a well-formed signed message before resending to add a footer, resulting in the following structure seen by recipients of the email:<a href="#section-4.5.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.5.1-2">
<pre>
H └┬╴multipart/mixed
I  ├┬╴multipart/signed
J  │├─╴text/plain
K  │└─╴application/pgp-signature
L  └─╴text/plain
</pre><a href="#section-4.5.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.5.1-3">In this message, <code>L</code> is the footer added by the mailing list.  <code>I</code> is now an Errant Cryptographic Layer.<a href="#section-4.5.1-3" class="pilcrow">¶</a></p>
<p id="section-4.5.1-4">Note that this message has no Cryptographic Envelope at all.<a href="#section-4.5.1-4" class="pilcrow">¶</a></p>
<p id="section-4.5.1-5">It is <span class="bcp14">NOT RECOMMENDED</span> to produce email messages with this structure, because a legacy MUA may present the data in part <code>L</code> as though it were part of <code>J</code>, though they have different cryptographic properties.
In particular, if the user believes that the entire message is signed but cannot distinguish <code>L</code> from <code>J</code>, then the author of <code>L</code> can effectively tamper with content of the signed message, breaking the user's expectation of integrity and authenticity.<a href="#section-4.5.1-5" class="pilcrow">¶</a></p>
<p id="section-4.5.1-6">See also <a href="#exception-mailing-list-footers" class="auto internal xref">Section 6.2.1.1</a> for guidance on how a rendering MUA might deal with this common pattern.<a href="#section-4.5.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="baroque-example">
<section id="section-4.5.2">
          <h4 id="name-a-baroque-example">
<a href="#section-4.5.2" class="section-number selfRef">4.5.2. </a><a href="#name-a-baroque-example" class="section-name selfRef">A Baroque Example</a>
          </h4>
<p id="section-4.5.2-1">Consider a message with the following overcomplicated structure:<a href="#section-4.5.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-4.5.2-2">
<pre>
M └┬╴multipart/encrypted
N  ├─╴application/pgp-encrypted
O  └┬╴application/octet-stream
P   ╧ (decrypts to)
Q   └┬╴multipart/signed
R    ├┬╴multipart/mixed
S    │├┬╴multipart/signed
T    ││├─╴text/plain
U    ││└─╴application/pgp-signature
V    │└─╴text/plain
W    └─╴application/pgp-signature
</pre><a href="#section-4.5.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2-3">The three Cryptographic Layers in such a message are rooted in parts <code>M</code>, <code>Q</code>, and <code>S</code>.
But the Cryptographic Envelope of the message consists only of the properties derived from the series <code>M</code> and <code>Q</code>.
The Cryptographic Payload of the message is part <code>R</code>.
Part <code>S</code> is an Errant Cryptographic Layer.<a href="#section-4.5.2-3" class="pilcrow">¶</a></p>
<p id="section-4.5.2-4">Note that this message has both a Cryptographic Envelope <em>and</em> an Errant Cryptographic Layer.<a href="#section-4.5.2-4" class="pilcrow">¶</a></p>
<p id="section-4.5.2-5">It is <span class="bcp14">NOT RECOMMENDED</span> to generate messages with such complicated structures.
Even if a receiving MUA can parse this structure properly, it is nearly impossible to render in a way that the user can reason about the cryptographic properties of part <code>T</code> compared to part <code>V</code>.<a href="#section-4.5.2-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="cryptographic-summary">
<section id="section-4.6">
        <h3 id="name-cryptographic-summary">
<a href="#section-4.6" class="section-number selfRef">4.6. </a><a href="#name-cryptographic-summary" class="section-name selfRef">Cryptographic Summary</a>
        </h3>
<p id="section-4.6-1">The cryptographic status of an email message with end-to-end cryptographic protections is known as the Cryptographic Summary.
A reasonable, simple Cryptographic Summary is derived from the aggregate properties of the layers in the Cryptographic Envelope.
This is a conceptual tool and a feature that an MUA can use to guide behavior and user experience, but it is not necessarily always directly exposed in any given user interface.
See <a href="#well-formed" class="auto internal xref">Section 6.1</a> for guidance and considerations about rendering the Cryptographic Summary to the user.<a href="#section-4.6-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="message-composition">
<section id="section-5">
      <h2 id="name-message-composition">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-message-composition" class="section-name selfRef">Message Composition</a>
      </h2>
<p id="section-5-1">This section describes the ideal composition of an email message with end-to-end cryptographic protection.
A message composed with this form is most likely to achieve its end-to-end security goals.<a href="#section-5-1" class="pilcrow">¶</a></p>
<div id="composition">
<section id="section-5.1">
        <h3 id="name-message-composition-algorit">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-message-composition-algorit" class="section-name selfRef">Message Composition Algorithm</a>
        </h3>
<p id="section-5.1-1">This section describes the steps that an MUA should use to compose a cryptographically protected message, such that it has a proper Cryptographic Envelope and Payload.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2">The inputs to the algorithm are:<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-5.1-3">
          <dt id="section-5.1-3.1">
<code>origbody</code>:</dt>
          <dd style="margin-left: 1.5em" id="section-5.1-3.2">The unprotected message body as a
          well-formed MIME tree (possibly just a single MIME leaf part).  As a
          well-formed MIME tree, <code>origbody</code> already has Structural
          Header Fields present (see <a href="#structural-header-fields" class="auto internal xref">Section 1.1.1</a>).<a href="#section-5.1-3.2" class="pilcrow">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-5.1-3.3">
<code>origheaders</code>:</dt>
          <dd style="margin-left: 1.5em" id="section-5.1-3.4">The intended Non-Structural Header
          Fields for the message, represented here as a list of <code>(h,v)</code>
          pairs, where <code>h</code> is a header field name and <code>v</code> is the
          associated value.<a href="#section-5.1-3.4" class="pilcrow">¶</a>
</dd>
          <dd class="break"></dd>
<dt id="section-5.1-3.5">
<code>crypto</code>:</dt>
          <dd style="margin-left: 1.5em" id="section-5.1-3.6">The series of cryptographic protections
          to apply (for example, "sign with the secret key corresponding to
          X.509 certificate X, then encrypt to X.509 certificates X and Y").
          This is a routine that accepts a MIME tree as input (the
          Cryptographic Payload), wraps the input in the appropriate
          Cryptographic Envelope, and returns the resultant MIME tree as
          output.<a href="#section-5.1-3.6" class="pilcrow">¶</a>
</dd>
        <dd class="break"></dd>
</dl>
<p id="section-5.1-4">The algorithm returns a MIME object that is ready to be injected into the mail system:<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.1-5">
          <li id="section-5.1-5.1">
            <p id="section-5.1-5.1.1">Apply <code>crypto</code> to MIME part <code>origbody</code>, producing MIME tree <code>output</code>.<a href="#section-5.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-5.1-5.2">
            <p id="section-5.1-5.2.1">For each header field name and value <code>(h,v)</code> in <code>origheaders</code>:<a href="#section-5.1-5.2.1" class="pilcrow">¶</a></p>
<ol start="1" type="a" class="normal type-a" id="section-5.1-5.2.2">
              <li id="section-5.1-5.2.2.1">
                <p id="section-5.1-5.2.2.1.1">Add header field <code>h</code> to <code>output</code> with value <code>v</code>.<a href="#section-5.1-5.2.2.1.1" class="pilcrow">¶</a></p>
</li>
            </ol>
</li>
          <li id="section-5.1-5.3">
            <p id="section-5.1-5.3.1">Return <code>output</code>.<a href="#section-5.1-5.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-5.1-6">This is the classic algorithm.  It only protects the Structural Header Fields of the message body and leaves Non-Structural (including User-Facing) Header Fields unprotected.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<p id="section-5.1-7">Therefore, a conformant MUA <span class="bcp14">MUST</span> implement Header Protection as described in <span>[<a href="#RFC9788" class="cite xref">RFC9788</a>]</span> (see <a href="#message-header-fields" class="auto internal xref">Section 9.3</a>).<a href="#section-5.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sign-then-encrypt">
<section id="section-5.2">
        <h3 id="name-encryption-outside-signatur">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-encryption-outside-signatur" class="section-name selfRef">Encryption Outside, Signature Inside</a>
        </h3>
<p id="section-5.2-1">An email message that is both signed and encrypted is signed <em>inside</em> the encryption and not the other way around.
For example, when crafting a signed-and-encrypted message using a simple Cryptographic Envelope of a single layer (<a href="#simple-cryptographic-envelopes" class="auto internal xref">Section 4.4.1</a>) with PGP/MIME, the OpenPGP Encrypted Message object should contain an OpenPGP Signed Message.
Likewise, when using a multilayer Cryptographic Envelope (<a href="#multilayer-cryptographic-envelopes" class="auto internal xref">Section 4.4.2</a>), the outer layer should be an encryption layer and the inner layer should be a signing layer.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">Putting the signature inside the encryption has two advantages:<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-3.1">
            <p id="section-5.2-3.1.1">The details of the signature remain confidential, visible only to the parties capable of decryption.<a href="#section-5.2-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-3.2">
            <p id="section-5.2-3.2.1">Any mail transport agent that modifies the message is unlikely to be able to accidentally break the signature.<a href="#section-5.2-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.2-4">A conformant MUA <span class="bcp14">MUST NOT</span> generate an encrypted and signed message where the only signature is outside the encryption.<a href="#section-5.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="no-encrypted-only">
<section id="section-5.3">
        <h3 id="name-avoid-offering-encrypted-on">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-avoid-offering-encrypted-on" class="section-name selfRef">Avoid Offering Encrypted-Only Messages</a>
        </h3>
<p id="section-5.3-1">When generating an email, there are four options for applying end-to-end cryptographic protections:<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-2.1">Unprotected: In some cases, offering any end-to-end cryptographic protection is harmful: It may confuse the recipient and offer no benefit.<a href="#section-5.3-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-2.2">Signed-only: In other cases, signing a message is useful (authenticity and integrity are desirable), but encryption is either impossible (for example, if the composer does not know how to encrypt to all recipients) or meaningless (for example, an email message to a mailing list that is intended to be published to a public archive).<a href="#section-5.3-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-2.3">Signed-and-encrypted: In other cases, full end-to-end confidentiality, authenticity, and integrity are desirable.<a href="#section-5.3-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-5.3-2.4">
            <p id="section-5.3-2.4.1">Encrypted-only: There is no common use case for generating an email message with end-to-end confidentiality but without       authenticity or integrity.<a href="#section-5.3-2.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-2.4.2.1">Additionally, some encryption schemes are malleable.  This allows an attacker to tamper with the plaintext by modifying the ciphertext (i.e., without decrypting it).  One way to prevent this is to authenticate the ciphertext, e.g., using signatures, Message Authentication Codes (MACs), or Authenticated Encryption with Associated Data (AEAD) schemes.  See the Cipher Block Chaining (CBC) / Cipher FeedBack (CFB) gadget attack in <span>[<a href="#EFAIL" class="cite xref">EFAIL</a>]</span>.<a href="#section-5.3-2.4.2.1" class="pilcrow">¶</a>
</li>
            </ul>
</li>
        </ul>
<p id="section-5.3-3">A conformant MUA should keep its message composition interface simple. When presenting the user with a choice of cryptographic protection, it <span class="bcp14">MUST</span> offer no more than three choices:<a href="#section-5.3-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5.3-4">
          <li id="section-5.3-4.1">
            <p id="section-5.3-4.1.1">No end-to-end cryptographic protection<a href="#section-5.3-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-5.3-4.2">
            <p id="section-5.3-4.2.1">Verified (signed only)<a href="#section-5.3-4.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-5.3-4.3">
            <p id="section-5.3-4.3.1">Confidential (signed and encrypted)<a href="#section-5.3-4.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-5.3-5">Note that these choices correspond to the simplified mental model in <a href="#simple-mental-model" class="auto internal xref">Section 3.1</a>.<a href="#section-5.3-5" class="pilcrow">¶</a></p>
<p id="section-5.3-6">A common anti-pattern among legacy MUAs is offering two boolean choices: one to toggle signing and another to toggle encryption.  This creates usability hurdles:<a href="#section-5.3-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-7.1">
            <p id="section-5.3-7.1.1">A user who wants to compose a signed-and-encrypted message will have to click two buttons instead of one.<a href="#section-5.3-7.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.3-7.2">
            <p id="section-5.3-7.2.1">A user who clicks "Encrypt" but neglects to click "Signed" may not understand that they are creating a message that cannot be authenticated by the recipient.<a href="#section-5.3-7.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="composing-reply">
<section id="section-5.4">
        <h3 id="name-composing-a-reply-message">
<a href="#section-5.4" class="section-number selfRef">5.4. </a><a href="#name-composing-a-reply-message" class="section-name selfRef">Composing a Reply Message</a>
        </h3>
<p id="section-5.4-1">When replying to a message, most MUAs compose an initial draft of the reply that contains quoted text from the original message.
A responsible MUA will take precautions to avoid leaking the cleartext of an encrypted message in such a reply.<a href="#section-5.4-1" class="pilcrow">¶</a></p>
<p id="section-5.4-2">If the original message was end-to-end encrypted, the replying MUA <span class="bcp14">MUST</span> either:<a href="#section-5.4-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.4-3.1">
            <p id="section-5.4-3.1.1">compose the reply with end-to-end encryption or<a href="#section-5.4-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.4-3.2">
            <p id="section-5.4-3.2.1">avoid including quoted text from the original message.<a href="#section-5.4-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.4-4">In general, MUAs <span class="bcp14">SHOULD</span> prefer the first option: to compose an encrypted reply.
This is what users expect.<a href="#section-5.4-4" class="pilcrow">¶</a></p>
<p id="section-5.4-5">However, in some circumstances, the replying MUA cannot compose an encrypted reply.
For example, the MUA might not have a valid, unexpired, and encryption-capable certificate for all recipients.
This can also happen during composition when a user adds a new recipient into the reply or manually toggles the cryptographic protections to remove encryption.<a href="#section-5.4-5" class="pilcrow">¶</a></p>
<p id="section-5.4-6">In this circumstance, the composing MUA <span class="bcp14">SHOULD</span> strip the quoted text from the original message, unless the user indicates that they are deliberately including previously confidential content in a non-confidential message.<a href="#section-5.4-6" class="pilcrow">¶</a></p>
<p id="section-5.4-7">Note additional nuance about replies to malformed messages that contain encryption in <a href="#reply-to-errant-encryption" class="auto internal xref">Section 6.2.2.1</a>.<a href="#section-5.4-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="message-interpretation">
<section id="section-6">
      <h2 id="name-message-interpretation">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-message-interpretation" class="section-name selfRef">Message Interpretation</a>
      </h2>
<p id="section-6-1">Despite the best efforts of well-intentioned composers to create email messages with well-formed, end-to-end cryptographic protection, rendering MUAs will inevitably encounter some messages with malformed end-to-end cryptographic protection.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">This section offers guidance on dealing with both well-formed and malformed messages containing Cryptographic Layers.<a href="#section-6-2" class="pilcrow">¶</a></p>
<div id="well-formed">
<section id="section-6.1">
        <h3 id="name-rendering-well-formed-messa">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-rendering-well-formed-messa" class="section-name selfRef">Rendering Well-Formed Messages</a>
        </h3>
<p id="section-6.1-1">A message is well-formed when it has a Cryptographic Envelope, a Cryptographic Payload, and no Errant Cryptographic Layers.
Rendering a well-formed message is straightforward.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1-2">The rendering MUA evaluates and assembles the cryptographic properties of the Cryptographic Envelope into a Cryptographic Summary and displays that status to the user in a secure and strictly controlled part of the UI.
In particular, the part of the UI used to render the Cryptographic Summary of the message <span class="bcp14">MUST NOT</span> be spoofable, modifiable, or otherwise controllable by the rendered message itself.
By analogy, consider the "lock" icon in the address bar of the web browser: Regardless of the content of the webpage, the lock icon will only be displayed when the transport to the web server is adequately secured.<a href="#section-6.1-2" class="pilcrow">¶</a></p>
<p id="section-6.1-3">Aside from this Cryptographic Summary, the message itself <span class="bcp14">MUST</span> be rendered as though the Cryptographic Payload is the body of the message.
The Cryptographic Layers themselves <span class="bcp14">SHOULD NOT</span> be rendered as distinct objects unless the MUA is providing the user with debugging information.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="errant-layers">
<section id="section-6.2">
        <h3 id="name-errant-cryptographic-layers-2">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-errant-cryptographic-layers-2" class="section-name selfRef">Errant Cryptographic Layers</a>
        </h3>
<p id="section-6.2-1">If an incoming message has any Errant Cryptographic Layers, a conformant interpreting MUA <span class="bcp14">MUST</span> ignore those layers when rendering the Cryptographic Summary of the message to the user.<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<div id="errant-signing-layer">
<section id="section-6.2.1">
          <h4 id="name-errant-signing-layer">
<a href="#section-6.2.1" class="section-number selfRef">6.2.1. </a><a href="#name-errant-signing-layer" class="section-name selfRef">Errant Signing Layer</a>
          </h4>
<p id="section-6.2.1-1">When rendering a message with an Errant Cryptographic Layer that provides authenticity and integrity (via signatures), the message should be rendered by replacing the Cryptographic Layer with the part it encloses.<a href="#section-6.2.1-1" class="pilcrow">¶</a></p>
<p id="section-6.2.1-2">For example, a message with this structure:<a href="#section-6.2.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-6.2.1-3">
<pre>
A └┬╴multipart/mixed
B  ├╴text/plain
C  ├┬╴multipart/signed
D  │├─╴image/jpeg
E  │└─╴application/pgp-signature
F  └─╴text/plain
</pre><a href="#section-6.2.1-3" class="pilcrow">¶</a>
</div>
<p id="section-6.2.1-4">should be rendered identically to this:<a href="#section-6.2.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-6.2.1-5">
<pre>
A └┬╴multipart/mixed
B  ├─╴text/plain
D  ├─╴image/jpeg
F  └─╴text/plain
</pre><a href="#section-6.2.1-5" class="pilcrow">¶</a>
</div>
<p id="section-6.2.1-6">In such a situation, a conformant MUA <span class="bcp14">MUST NOT</span> indicate in the Cryptographic Summary that the message is signed.
It <span class="bcp14">MUST</span> indicate that the message is Unprotected.<a href="#section-6.2.1-6" class="pilcrow">¶</a></p>
<div id="exception-mailing-list-footers">
<section id="section-6.2.1.1">
            <h5 id="name-exception-mailing-list-foot">
<a href="#section-6.2.1.1" class="section-number selfRef">6.2.1.1. </a><a href="#name-exception-mailing-list-foot" class="section-name selfRef">Exception: Mailing List Footers</a>
            </h5>
<p id="section-6.2.1.1-1">The use case described in <a href="#mailing-list-wrapping" class="auto internal xref">Section 4.5.1</a> is common enough in some contexts that a conformant MUA <span class="bcp14">MAY</span> decide to handle it as a special exception.<a href="#section-6.2.1.1-1" class="pilcrow">¶</a></p>
<p id="section-6.2.1.1-2">If the MUA determines that the message comes from a mailing list (for example, it has a <code>List-ID</code> header field) and it has a structure that appends a footer to a signing-only Cryptographic Layer with a valid signature, such as:<a href="#section-6.2.1.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-6.2.1.1-3">
<pre>
H └┬╴multipart/mixed
I  ├┬╴multipart/signed
J  │├─╴[protected part, may be arbitrary MIME subtree]
K  │└─╴application/{pgp,pkcs7}-signature
L  └─╴[footer, typically text/plain]
</pre><a href="#section-6.2.1.1-3" class="pilcrow">¶</a>
</div>
<p id="section-6.2.1.1-4">or:<a href="#section-6.2.1.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-6.2.1.1-5">
<pre>
H └┬╴multipart/mixed
I  ├┬╴application/pkcs7-mime; smime-type="signed-data"
   │┴ (unwraps to)
J  │└─╴[protected part, may be an arbitrary MIME subtree]
L  └─╴[footer, typically text/plain]
</pre><a href="#section-6.2.1.1-5" class="pilcrow">¶</a>
</div>
<p id="section-6.2.1.1-6">then the MUA <span class="bcp14">MAY</span> indicate to the user that this is a Verified message that has been wrapped by the mailing list.<a href="#section-6.2.1.1-6" class="pilcrow">¶</a></p>
<p id="section-6.2.1.1-7">In this case, the MUA <span class="bcp14">MUST</span> distinguish the footer (part <code>L</code>) from the protected part (part <code>J</code>) when rendering any information about the signature.<a href="#section-6.2.1.1-7" class="pilcrow">¶</a></p>
<p id="section-6.2.1.1-8">One way to do this is to offer the user two different views of the message: the "mailing list" view, which hides any positive Cryptographic Summary but shows the footer:<a href="#section-6.2.1.1-8" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-6.2.1.1-9">
<pre>
Cryptographic Protections: Unprotected
H └┬╴multipart/mixed
J  ├─╴[protected part, may be arbitrary MIME subtree]
L  └─╴[footer, typically text/plain]
</pre><a href="#section-6.2.1.1-9" class="pilcrow">¶</a>
</div>
<p id="section-6.2.1.1-10">or the "sender's view", which shows the Cryptographic Summary as Verified but hides the footer:<a href="#section-6.2.1.1-10" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-6.2.1.1-11">
<pre>
Cryptographic Protections: Verified [details from part I]
J └─╴[protected part, may be arbitrary MIME subtree]
</pre><a href="#section-6.2.1.1-11" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="errant-encryption-layer">
<section id="section-6.2.2">
          <h4 id="name-errant-encryption-layer">
<a href="#section-6.2.2" class="section-number selfRef">6.2.2. </a><a href="#name-errant-encryption-layer" class="section-name selfRef">Errant Encryption Layer</a>
          </h4>
<p id="section-6.2.2-1">An MUA may encounter a message with an Errant Cryptographic Layer that offers confidentiality (encryption), and the MUA is capable of decrypting it.<a href="#section-6.2.2-1" class="pilcrow">¶</a></p>
<p id="section-6.2.2-2">The user wants to be able to see the contents of any message that they have access to, so a conformant MUA in this situation <span class="bcp14">SHOULD</span> decrypt the part.<a href="#section-6.2.2-2" class="pilcrow">¶</a></p>
<p id="section-6.2.2-3">However, in this case, a conformant MUA <span class="bcp14">MUST NOT</span> indicate in the message's Cryptographic Summary that the message itself was encrypted.
   Such an indication could be taken to mean that other (non-encrypted) parts of the message arrived with cryptographic confidentiality.<a href="#section-6.2.2-3" class="pilcrow">¶</a></p>
<p id="section-6.2.2-4">Furthermore, when decrypting an Errant Cryptographic Layer, the MUA <span class="bcp14">MUST</span> treat the decrypted cleartext as a distinct MIME subtree and it <span class="bcp14">MUST NOT</span> attempt to merge or splice it together with any other part of the message.
This offers protection against the direct exfiltration (also known as EFAIL-DE) attacks described in <span>[<a href="#EFAIL" class="cite xref">EFAIL</a>]</span> and so-called <code>multipart/oracle</code> attacks described in <span>[<a href="#ORACLE" class="cite xref">ORACLE</a>]</span>.<a href="#section-6.2.2-4" class="pilcrow">¶</a></p>
<div id="reply-to-errant-encryption">
<section id="section-6.2.2.1">
            <h5 id="name-replying-to-a-message-with-">
<a href="#section-6.2.2.1" class="section-number selfRef">6.2.2.1. </a><a href="#name-replying-to-a-message-with-" class="section-name selfRef">Replying to a Message with an Errant Encryption Layer</a>
            </h5>
<p id="section-6.2.2.1-1">Note that there is an asymmetry here between rendering and replying to a message with an Errant Encryption Layer.<a href="#section-6.2.2.1-1" class="pilcrow">¶</a></p>
<p id="section-6.2.2.1-2">When rendering, the MUA does not indicate that the message was encrypted, even if some subpart of it was decrypted for rendering.<a href="#section-6.2.2.1-2" class="pilcrow">¶</a></p>
<p id="section-6.2.2.1-3">When composing a reply to a message that has any encryption layer, even an errant one, the reply message <span class="bcp14">SHOULD</span> be marked for encryption, unless quoted and attributed text is not included in the reply, as noted in <a href="#composing-reply" class="auto internal xref">Section 5.4</a>.<a href="#section-6.2.2.1-3" class="pilcrow">¶</a></p>
<p id="section-6.2.2.1-4">When composing a reply to a message with an Errant Cryptographic Layer, a conformant MUA <span class="bcp14">MUST NOT</span> quote or attribute text derived from the decryption of any Errant Cryptographic Layer.
This will typically mean either leaving the ciphertext itself in the generated reply message or simply not generating any quoted or attributed text at all.
This offers protection against the reply-based attacks described in <span>[<a href="#REPLY" class="cite xref">REPLY</a>]</span>.<a href="#section-6.2.2.1-4" class="pilcrow">¶</a></p>
<p id="section-6.2.2.1-5">In all circumstances, if the reply message cannot be encrypted (or if the user elects to not encrypt the reply), the composed reply <span class="bcp14">MUST NOT</span> include any material from the decrypted subpart.<a href="#section-6.2.2.1-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="avoiding-non-mime-cryptographic-mechanisms">
<section id="section-6.2.3">
          <h4 id="name-avoiding-non-mime-cryptogra">
<a href="#section-6.2.3" class="section-number selfRef">6.2.3. </a><a href="#name-avoiding-non-mime-cryptogra" class="section-name selfRef">Avoiding Non-MIME Cryptographic Mechanisms</a>
          </h4>
<p id="section-6.2.3-1">In some cases, there may be a cryptographic signature or encryption that does not coincide with a MIME boundary.
For example, so-called "PGP Inline" messages typically contain base64-encoded ("ASCII-armored", see <span><a href="https://rfc-editor.org/rfc/rfc9580#section-6" class="relref">Section 6</a> of [<a href="#RFC9580" class="cite xref">RFC9580</a>]</span>) ciphertext within the content of a MIME part.<a href="#section-6.2.3-1" class="pilcrow">¶</a></p>
<div id="do-not-validate-non-mime-signatures">
<section id="section-6.2.3.1">
            <h5 id="name-do-not-validate-non-mime-si">
<a href="#section-6.2.3.1" class="section-number selfRef">6.2.3.1. </a><a href="#name-do-not-validate-non-mime-si" class="section-name selfRef">Do Not Validate Non-MIME Signatures</a>
            </h5>
<p id="section-6.2.3.1-1">When encountering cryptographic signatures in these positions, a conformant MUA <span class="bcp14">MUST NOT</span> attempt to validate any signature.
It is challenging to communicate to the user exactly which part of such a message is covered by the signature, so it is better to leave the message marked as Unprotected.
See <span>[<a href="#SPOOFING" class="cite xref">SPOOFING</a>]</span> for examples of spoofed message signatures that rely on permissive legacy clients that are willing to validate signatures in poorly structured messages.<a href="#section-6.2.3.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="skip-or-isolate-non-mime-decryption-when-rendering">
<section id="section-6.2.3.2">
            <h5 id="name-skip-or-isolate-non-mime-de">
<a href="#section-6.2.3.2" class="section-number selfRef">6.2.3.2. </a><a href="#name-skip-or-isolate-non-mime-de" class="section-name selfRef">Skip or Isolate Non-MIME Decryption When Rendering</a>
            </h5>
<p id="section-6.2.3.2-1">When encountering what appears to be encrypted data not at a MIME boundary, a conformant MUA <span class="bcp14">MAY</span> fully decline to decrypt the data.<a href="#section-6.2.3.2-1" class="pilcrow">¶</a></p>
<p id="section-6.2.3.2-2">During message rendering, if a conformant MUA attempts decryption of such a non-MIME encrypted section of an email, it <span class="bcp14">MUST</span> synthesize a separate MIME part to contain only the decrypted data and it <span class="bcp14">MUST NOT</span> attempt to merge or splice that part together with any other part of the message.
Keeping such a section distinct and isolated from any other part of the message offers protection against the direct exfiltration attacks (also known as EFAIL-DE) described in <span>[<a href="#EFAIL" class="cite xref">EFAIL</a>]</span>.<a href="#section-6.2.3.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="do-not-decrypt-non-mime-decryption-when-replying">
<section id="section-6.2.3.3">
            <h5 id="name-do-not-decrypt-non-mime-dec">
<a href="#section-6.2.3.3" class="section-number selfRef">6.2.3.3. </a><a href="#name-do-not-decrypt-non-mime-dec" class="section-name selfRef">Do Not Decrypt Non-MIME Decryption When Replying</a>
            </h5>
<p id="section-6.2.3.3-1">When composing a reply to a message with such a non-MIME encrypted section, a conformant MUA <span class="bcp14">MUST NOT</span> decrypt any non-MIME encrypted section when generating quoted or attributed text, similar to the guidance in <a href="#reply-to-errant-encryption" class="auto internal xref">Section 6.2.2.1</a>.<a href="#section-6.2.3.3-1" class="pilcrow">¶</a></p>
<p id="section-6.2.3.3-2">This offers protection against the reply-based attacks described in <span>[<a href="#REPLY" class="cite xref">REPLY</a>]</span>.<a href="#section-6.2.3.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="forwarded-messages-with-cryptographic-protection">
<section id="section-6.3">
        <h3 id="name-forwarded-messages-with-cry">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-forwarded-messages-with-cry" class="section-name selfRef">Forwarded Messages with Cryptographic Protection</a>
        </h3>
<p id="section-6.3-1">An incoming email message may include an attached forwarded message, typically as a MIME subpart with <code>Content-Type: message/rfc822</code> <span>[<a href="#RFC5322" class="cite xref">RFC5322</a>]</span> or <code>Content-Type: message/global</code> <span>[<a href="#RFC6532" class="cite xref">RFC6532</a>]</span>.<a href="#section-6.3-1" class="pilcrow">¶</a></p>
<p id="section-6.3-2">Regardless of the cryptographic protections and structure of the incoming message, the internal forwarded message may have its own Cryptographic Envelope.<a href="#section-6.3-2" class="pilcrow">¶</a></p>
<p id="section-6.3-3">The Cryptographic Layers that are part of the Cryptographic Envelope of the forwarded message are Errant Cryptographic Layers with respect to the surrounding message -- they are layers that only apply to the forwarded message itself.<a href="#section-6.3-3" class="pilcrow">¶</a></p>
<p id="section-6.3-4">A conformant rendering MUA <span class="bcp14">MUST NOT</span> conflate the cryptographic protections of the forwarded message with the cryptographic protections of the incoming message.<a href="#section-6.3-4" class="pilcrow">¶</a></p>
<p id="section-6.3-5">A conformant rendering MUA <span class="bcp14">MAY</span> render a Cryptographic Summary of the protections afforded to the forwarded message by its own Cryptographic Envelope, as long as that rendering is unambiguously tied to the forwarded message itself and cannot be spoofed by either the enclosing message or the forwarded message.<a href="#section-6.3-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="signature-failures">
<section id="section-6.4">
        <h3 id="name-signature-failures">
<a href="#section-6.4" class="section-number selfRef">6.4. </a><a href="#name-signature-failures" class="section-name selfRef">Signature Failures</a>
        </h3>
<p id="section-6.4-1">A cryptographic signature may fail in multiple ways.
A conformant rendering MUA that discovers a failed signature treats the message as though the signature did not exist.
This is similar to the standard guidance for failed DomainKeys Identified Mail (DKIM) signatures (see <span><a href="https://rfc-editor.org/rfc/rfc6376#section-6.1" class="relref">Section 6.1</a> of [<a href="#RFC6376" class="cite xref">RFC6376</a>]</span>).<a href="#section-6.4-1" class="pilcrow">¶</a></p>
<p id="section-6.4-2">A conformant MUA <span class="bcp14">MUST NOT</span> render a message with a failed signature as more dangerous or more dubious than a comparable message without any signature at all.
In both cases, the Cryptographic Summary should be Unprotected.<a href="#section-6.4-2" class="pilcrow">¶</a></p>
<p id="section-6.4-3">A conformant MUA that encounters a signed-and-encrypted message where the signature is invalid <span class="bcp14">SHOULD</span> treat the message the same way that it would treat a message that is encryption-only, unless the MUA is providing the user with debugging information.<a href="#section-6.4-3" class="pilcrow">¶</a></p>
<p id="section-6.4-4">These are some different ways that a signature may be invalid on a given message:<a href="#section-6.4-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.4-5.1">
            <p id="section-6.4-5.1.1">The signature is not cryptographically valid (the math fails).<a href="#section-6.4-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.2">
            <p id="section-6.4-5.2.1">The signature relies on suspect cryptographic primitives (e.g., over a deprecated digest algorithm, or was made by a weak key, e.g., 1024-bit RSA); note that this requires the rendering MUA to have an explicit policy about what cryptographic primitives are acceptable.<a href="#section-6.4-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.3">
            <p id="section-6.4-5.3.1">The signature is made by a certificate that the rendering MUA does not have access to.<a href="#section-6.4-5.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.4">
            <p id="section-6.4-5.4.1">The certificate used to verify the signature was revoked.<a href="#section-6.4-5.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.5">
            <p id="section-6.4-5.5.1">The certificate used to verify the signature was expired at the time that the signature was made.<a href="#section-6.4-5.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.6">
            <p id="section-6.4-5.6.1">The certificate used to verify the signature does not correspond to the author of the message. (For X.509, there is no subjectAltName of type rfc822Name whose value matches an email address found in the <code>From</code> or <code>Sender</code> header field.)<a href="#section-6.4-5.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.7">
            <p id="section-6.4-5.7.1">The certificate used to verify the signature was not issued by an authority that the MUA user is willing to rely on for certifying the sender's email address, and the user has no other reasonable indication that the certificate belongs to the sender's email address.<a href="#section-6.4-5.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.8">
            <p id="section-6.4-5.8.1">The signature indicates that it was made at a time much before or much after the date of the message itself.<a href="#section-6.4-5.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.4-5.9">
            <p id="section-6.4-5.9.1">The signature covers a message that depends on an external subresource that might change (see <a href="#external-subresources" class="auto internal xref">Section 9.9</a>).<a href="#section-6.4-5.9.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.4-6">A valid signature must pass all these tests, but of course, invalid signatures may be invalid in more than one of the ways listed above.<a href="#section-6.4-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="weak-encryption">
<section id="section-6.5">
        <h3 id="name-weak-encryption">
<a href="#section-6.5" class="section-number selfRef">6.5. </a><a href="#name-weak-encryption" class="section-name selfRef">Weak Encryption</a>
        </h3>
<p id="section-6.5-1">Sometimes, an MUA might encounter a message with a well-formed Cryptographic Envelope that uses a form of encryption with substantial known flaws.
For example, a PGP/MIME message might use a Symmetrically Encrypted Data Packet, which is known to have malleable ciphertext (see <span><a href="https://rfc-editor.org/rfc/rfc9580#section-5.7" class="relref">Section 5.7</a> of [<a href="#RFC9580" class="cite xref">RFC9580</a>]</span>). As another example, an S/MIME message may use an <code>enveloped-data</code> MIME part with a <code>contentEncryptionAlgorithm</code> of <code>rc2-cbc</code> with <code>rc2ParameterVersion</code> of 160, meaning a 40-bit key (see <span><a href="https://rfc-editor.org/rfc/rfc3370#section-5.2" class="relref">Section 5.2</a> of [<a href="#RFC3370" class="cite xref">RFC3370</a>]</span>), which is widely considered breakable via brute force with moderate hardware investment in 2024.
As cryptanalysis and hardware capacities advance, an implementation may widen the scope of what encryption mechanisms are considered weak.<a href="#section-6.5-1" class="pilcrow">¶</a></p>
<p id="section-6.5-2">A rendering MUA <span class="bcp14">MUST</span> warn the user that such a message has a known weakness.
The rendering MUA <span class="bcp14">MAY</span> fully decline to decrypt such a message.
If it decides to decrypt a message with a weak encryption layer, it <span class="bcp14">MUST NOT</span> indicate in the message's Cryptographic Summary that the message was encrypted, as the confidentiality of the message is suspect.
This is similar to the approach taken in <a href="#errant-encryption-layer" class="auto internal xref">Section 6.2.2</a> for messages with an Errant Encryption Layer.<a href="#section-6.5-2" class="pilcrow">¶</a></p>
<p id="section-6.5-3">Like the Errant Encryption Layer situation, there is an asymmetry between rendering and replying to a message with weak encryption.
The guidance in <a href="#reply-to-errant-encryption" class="auto internal xref">Section 6.2.2.1</a> should be followed when replying to a message with weak encryption as well.<a href="#section-6.5-3" class="pilcrow">¶</a></p>
<p id="section-6.5-4">A rendering MUA <span class="bcp14">MAY</span> also treat historically archived messages with weak encryption differently than modern messages.
For example, if an encryption algorithm was known to be weak in 2005, then a message that appears to have been encrypted with that algorithm in 1995 might be decrypted with a warning, as an archival service.
But a message that appears to have been encrypted with that same weak algorithm in 2015 might be quarantined as a likely attack.<a href="#section-6.5-4" class="pilcrow">¶</a></p>
<p id="section-6.5-5">There are several possible ways to distinguish a historical message from a modern one, including:<a href="#section-6.5-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.5-6.1">
            <p id="section-6.5-6.1.1">the message timestamp (e.g., the <code>Date</code> header field)<a href="#section-6.5-6.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.5-6.2">
            <p id="section-6.5-6.2.1">the time the message was first observed on the network (e.g., delivery of a new message via IMAP from a mailbox that had recently checked)<a href="#section-6.5-6.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.5-6.3">
            <p id="section-6.5-6.3.1">the timestamp in any signature observed in the message<a href="#section-6.5-6.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.5-6.4">
            <p id="section-6.5-6.4.1">the message structure (a message composed using protocol elements that were invented after the encryption algorithm was known as weak is more likely to be an attack than a legitimate archival message)<a href="#section-6.5-6.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="reasoning-about-message-parts">
<section id="section-7">
      <h2 id="name-reasoning-about-message-par">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-reasoning-about-message-par" class="section-name selfRef">Reasoning about Message Parts</a>
      </h2>
<p id="section-7-1">When generating or rendering messages, it is useful to know what parts of the message are likely to be displayed and how.
This section introduces some common terms that can be applied to parts within the Cryptographic Payload.<a href="#section-7-1" class="pilcrow">¶</a></p>
<div id="main-body-part">
<section id="section-7.1">
        <h3 id="name-main-body-part">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-main-body-part" class="section-name selfRef">Main Body Part</a>
        </h3>
<p id="section-7.1-1">When an email message is composed or rendered to the user, there is typically one main view that presents a (mostly textual) part of the message.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">While the message itself may be constructed of several distinct MIME parts in a tree, the part that is rendered to the user is the "Main Body Part".<a href="#section-7.1-2" class="pilcrow">¶</a></p>
<p id="section-7.1-3">When rendering a message, one of the primary jobs of the rendering MUA is identifying which part (or parts) is the Main Body Part.
Typically, this is found by traversing the MIME tree of the message looking for a leaf node that has <code>text</code> (e.g., <code>text/plain</code> or <code>text/html</code>) as a primary content type and is not <code>Content-Disposition: attachment</code>.<a href="#section-7.1-3" class="pilcrow">¶</a></p>
<p id="section-7.1-4">MIME tree traversal follows the first child of every <code>multipart</code> node, with the exception of <code>multipart/alternative</code>.
 When traversing a <code>multipart/alternative</code> node, all children should be scanned, with preference given to the last child node with a MIME type that the MUA is capable of rendering directly.<a href="#section-7.1-4" class="pilcrow">¶</a></p>
<p id="section-7.1-5">An MUA <span class="bcp14">MAY</span> let the user select a preferred MIME type for rendering within <code>multipart/alternative</code> instead of the last renderable child.
For example, a user may explicitly prefer a <code>text/plain</code> alternative part over <code>text/html</code>.
Note that due to uncertainty about the capabilities and configuration of the rendering MUA, a conformant composing MUA should consider that multiple parts might be rendered as the Main Body Part when the message is ultimately viewed.
In particular, the composing MUA should ensure that any part likely to be viewed as the Main Body Part has the same semantic content as any other such part.<a href="#section-7.1-5" class="pilcrow">¶</a></p>
<p id="section-7.1-6">When composing a message, an originating MUA operating on behalf of an active user can identify which part (or parts) are the "main" parts: These are the parts the MUA generates from the user's editor.
Tooling that automatically generates email messages should also have a reasonable estimate of which part (or parts) are the "main" parts, as they can be programmatically identified by the message author.<a href="#section-7.1-6" class="pilcrow">¶</a></p>
<p id="section-7.1-7">For a filtering program that attempts to transform an outbound message without any special knowledge about which parts are the Main Body Parts, it can identify the likely parts by following the same routine as a rendering MUA.<a href="#section-7.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="attachments">
<section id="section-7.2">
        <h3 id="name-attachments">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-attachments" class="section-name selfRef">Attachments</a>
        </h3>
<p id="section-7.2-1">A message may contain one or more separated MIME parts that are intended for download or extraction.
Such a part is commonly called an "attachment" and is commonly identified by having <code>Content-Disposition: attachment</code>.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<p id="section-7.2-2">An MUA <span class="bcp14">MAY</span> identify a subpart as an attachment or permit extraction of a subpart even when the subpart does not have <code>Content-Disposition: attachment</code>.<a href="#section-7.2-2" class="pilcrow">¶</a></p>
<p id="section-7.2-3">When generating a message with end-to-end cryptographic protection, any attachment <span class="bcp14">MUST</span> be included within the Cryptographic Payload.
If an attachment is found outside the Cryptographic Payload, then the message is not well-formed (see <a href="#well-formed" class="auto internal xref">Section 6.1</a>) and will not be handled by other MUAs as intended.<a href="#section-7.2-3" class="pilcrow">¶</a></p>
<p id="section-7.2-4">Some MUAs have tried to compose messages where each attachment is placed in its own Cryptographic Envelope.
Such a message is problematic for several reasons:<a href="#section-7.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.2-5.1">
            <p id="section-7.2-5.1.1">The attachments can be stripped, replaced, or reordered without breaking any cryptographic integrity mechanism.<a href="#section-7.2-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-7.2-5.2">
            <p id="section-7.2-5.2.1">The resulting message may have a mix of cryptographic statuses (e.g., if a signature on one part fails but another succeeds or if one part is encrypted and another is not).
This mix of statuses is difficult to represent to the user in a comprehensible way.<a href="#section-7.2-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-7.2-5.3">
            <p id="section-7.2-5.3.1">The divisions between the different attachments are visible to operators of any mail transport agent (MTA) that handles the message, potentially resulting in a metadata leak.
For example, the MTA operator may learn the number of attachments and the size of each attachment.<a href="#section-7.2-5.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-7.2-6">These messages are unlikely to be usefully interoperable without additional standardization work (see <a href="#split-attachments" class="auto internal xref">Appendix A.12</a>).<a href="#section-7.2-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mime-part-examples">
<section id="section-7.3">
        <h3 id="name-mime-part-examples">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-mime-part-examples" class="section-name selfRef">MIME Part Examples</a>
        </h3>
<p id="section-7.3-1">Consider a common message with the following MIME structure:<a href="#section-7.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-7.3-2">
<pre>
M └┬╴application/pkcs7-mime
   ╧ (decrypts to)
N  └┬╴application/pkcs7-mime
    ┴ (unwraps to)
O   └┬╴multipart/mixed
P    ├┬╴multipart/alternative
Q    │├─╴text/plain
R    │└─╴text/html
S    └─╴image/png
</pre><a href="#section-7.3-2" class="pilcrow">¶</a>
</div>
<p id="section-7.3-3">Parts <code>M</code> and <code>N</code> comprise the Cryptographic Envelope.<a href="#section-7.3-3" class="pilcrow">¶</a></p>
<p id="section-7.3-4">Parts <code>Q</code> and <code>R</code> are both Main Body Parts.<a href="#section-7.3-4" class="pilcrow">¶</a></p>
<p id="section-7.3-5">If part <code>S</code> is <code>Content-Disposition: attachment</code>, then it is an attachment.
If part <code>S</code> has no <code>Content-Disposition</code> header field, it is potentially ambiguous whether it is an attachment or not.
If the composer prefers a specific behavior, it should explicitly set the <code>Content-Disposition</code> header field on part <code>S</code> to either <code>inline</code> or <code>attachment</code> as guidance to the rendering MUA.<a href="#section-7.3-5" class="pilcrow">¶</a></p>
<p id="section-7.3-6">Consider also this alternate structure:<a href="#section-7.3-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-ascii-art art-text artwork" id="section-7.3-7">
<pre>
M └┬╴application/pkcs7-mime
   ╧ (decrypts to)
N  └┬╴application/pkcs7-mime
    ┴ (unwraps to)
O   └┬╴multipart/alternative
P    ├─╴text/plain
Q    └┬╴multipart/related
R     ├─╴text/html
S     └─╴image/png
</pre><a href="#section-7.3-7" class="pilcrow">¶</a>
</div>
<p id="section-7.3-8">In this case, parts <code>M</code> and <code>N</code> still comprise the Cryptographic Envelope.<a href="#section-7.3-8" class="pilcrow">¶</a></p>
<p id="section-7.3-9">Parts <code>P</code> and <code>R</code> (the first two leaf nodes within each subtree of part <code>O</code>) are the Main Body Parts.<a href="#section-7.3-9" class="pilcrow">¶</a></p>
<p id="section-7.3-10">Part <code>S</code> is more likely not to be an attachment, as the subtree layout suggests that it is only relevant for the HTML version of the message.
For example, it might be rendered as an image within the HTML alternative.<a href="#section-7.3-10" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="cert-management">
<section id="section-8">
      <h2 id="name-certificate-management">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-certificate-management" class="section-name selfRef">Certificate Management</a>
      </h2>
<p id="section-8-1">A cryptographically capable MUA typically maintains knowledge about certificates for the user's own account(s), as well as certificates for the peers that it communicates with.<a href="#section-8-1" class="pilcrow">¶</a></p>
<div id="peer-certificates">
<section id="section-8.1">
        <h3 id="name-peer-certificates">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-peer-certificates" class="section-name selfRef">Peer Certificates</a>
        </h3>
<p id="section-8.1-1">Most certificates that a cryptographically capable MUA will use will be certificates belonging to the parties that the user communicates with through the MUA.
This section discusses how to manage the certificates that belong to such a peer.<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1-2">The MUA will need to be able to discover X.509 certificates for each peer, cache them, and select among them when composing an encrypted message.
        Detailed guidance about how to do this is beyond the scope of this document, but future revisions may bring it into scope (see <a href="#more-peer-certs" class="auto internal xref">Appendix A.3</a>).<a href="#section-8.1-2" class="pilcrow">¶</a></p>
<div id="peer-cert-selection">
<section id="section-8.1.1">
          <h4 id="name-peer-certificate-selection">
<a href="#section-8.1.1" class="section-number selfRef">8.1.1. </a><a href="#name-peer-certificate-selection" class="section-name selfRef">Peer Certificate Selection</a>
          </h4>
<p id="section-8.1.1-1">When composing an encrypted message, the MUA needs to select an encryption-capable certificate for each recipient.<a href="#section-8.1.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1.1-2">To select such a certificate for a given destination email address, the MUA should look through all of its known certificates and verify that <em>all</em> of the conditions below are met:<a href="#section-8.1.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.1.1-3.1">
              <p id="section-8.1.1-3.1.1">The certificate must be valid, not expired or revoked.<a href="#section-8.1.1-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-8.1.1-3.2">
              <p id="section-8.1.1-3.2.1">It must have a subjectAltName of type rfc822Name (for all ASCII email addresses) or SmtpUTF8Mailbox (for Internationalized Email Addresses) whose contents match the destination email address.
  In particular, for rfc822Name, the <code>local-part</code> of the two addresses should be an exact bytewise match, and the domain parts of the two addresses should be matched by ensuring label equivalence across the full domain name, as described in <span><a href="https://rfc-editor.org/rfc/rfc5890#section-2.3.2.4" class="relref">Section 2.3.2.4</a> of [<a href="#RFC5890" class="cite xref">RFC5890</a>]</span>.
  Comparison with SmtpUTF8Mailbox is specified in <span><a href="https://rfc-editor.org/rfc/rfc9598#section-5" class="relref">Section 5</a> of [<a href="#RFC9598" class="cite xref">RFC9598</a>]</span>.<a href="#section-8.1.1-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-8.1.1-3.3">
              <p id="section-8.1.1-3.3.1">The algorithm OID in the certificate's SubjectPublicKeyInfo (SPKI) is known to the MUA and capable of encryption.
Examples include:<a href="#section-8.1.1-3.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.1.1-3.3.2.1">
                  <p id="section-8.1.1-3.3.2.1.1">rsaEncryption (OID 1.2.840.113549.1.1.1), with the keyUsage (OID 2.5.29.15) extension present and the "key encipherment" bit (value 32) set.<a href="#section-8.1.1-3.3.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-8.1.1-3.3.2.2">
                  <p id="section-8.1.1-3.3.2.2.1">curveX25519 (OID 1.3.101.110), with the keyUsage extension present and the "key agreement" bit (value 8) set.<a href="#section-8.1.1-3.3.2.2.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
            <li class="normal" id="section-8.1.1-3.4">
              <p id="section-8.1.1-3.4.1">If extendedKeyUsage (OID 2.5.29.37) is present, it contains at least one of the following OIDs: email protection (OID 1.3.6.1.5.5.7.3.4), anyExtendedKeyUsage (OID 2.5.29.37.0).<a href="#section-8.1.1-3.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-8.1.1-4">A conformant MUA may include more considerations when selecting a peer certificate as well; see <a href="#more-peer-cert-selection" class="auto internal xref">Appendix A.3.4</a> for examples.<a href="#section-8.1.1-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="local-certificates">
<section id="section-8.2">
        <h3 id="name-local-certificates">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-local-certificates" class="section-name selfRef">Local Certificates</a>
        </h3>
<p id="section-8.2-1">The MUA also needs to know about one or more certificates associated with the user's email account.
It is typically expected to have access to the secret key material associated with the public keys in those certificates.<a href="#section-8.2-1" class="pilcrow">¶</a></p>
<p id="section-8.2-2">While some basic guidance is offered here, it is beyond the scope of this document to describe all possible relevant guidance for local certificate and key material handling.
See <a href="#more-local-certs" class="auto internal xref">Appendix A.4</a> for suggestions of guidance that a future version might bring into scope.<a href="#section-8.2-2" class="pilcrow">¶</a></p>
<div id="local-certificate-setup">
<section id="section-8.2.1">
          <h4 id="name-getting-certificates-for-th">
<a href="#section-8.2.1" class="section-number selfRef">8.2.1. </a><a href="#name-getting-certificates-for-th" class="section-name selfRef">Getting Certificates for the User</a>
          </h4>
<p id="section-8.2.1-1">If a conformant MUA does not have a certificate or secret key for the user, it should help the user to generate, acquire, or import them with minimum difficulty.<a href="#section-8.2.1-1" class="pilcrow">¶</a></p>
<div id="local-cert-smime">
<section id="section-8.2.1.1">
            <h5 id="name-user-certificates-for-s-mim">
<a href="#section-8.2.1.1" class="section-number selfRef">8.2.1.1. </a><a href="#name-user-certificates-for-s-mim" class="section-name selfRef">User Certificates for S/MIME</a>
            </h5>
<p id="section-8.2.1.1-1">For S/MIME, the user <span class="bcp14">SHOULD</span> have both a signing-capable certificate and an encryption-capable certificate (and the corresponding secret keys).
Using the same cryptographic key material for multiple algorithms (i.e., for both encryption and signing) has been the source of vulnerabilities in other (non-email) contexts (e.g., <span>[<a href="#DROWN" class="cite xref">DROWN</a>]</span> and <span>[<a href="#IKE" class="cite xref">IKE</a>]</span>).
The simplest way to avoid any comparable risk is to use distinct key material for each cryptographic algorithm.
   A conformant MUA that generates S/MIME certificates for the user <span class="bcp14">MUST</span>
   generate distinct S/MIME certificates to avoid possible cross-protocol
   key misuse: one for encryption and another for signing.<a href="#section-8.2.1.1-1" class="pilcrow">¶</a></p>
<p id="section-8.2.1.1-2">The simplest option for an S/MIME-capable MUA is for the MUA to permit the user to import a PKCS #12 <span>[<a href="#RFC7292" class="cite xref">RFC7292</a>]</span> object that is expected to contain secret key material, end entity certificates for the user, and intermediate certification authority (CA) certificates that permit chaining from the end entity certificates to widely accepted trust anchors.
A conformant MUA that imports such a PKCS #12 bundle <span class="bcp14">SHOULD</span> warn the user if the bundle contains an S/MIME certificate and corresponding secret key where the same secret key is used for both encryption and signing.<a href="#section-8.2.1.1-2" class="pilcrow">¶</a></p>
<p id="section-8.2.1.1-3">An S/MIME-capable MUA that has access to user certificates and their corresponding secret key material should also offer the ability to export those objects into a well-formed PKCS #12 object that could be imported into another MUA operated by the same user.<a href="#section-8.2.1.1-3" class="pilcrow">¶</a></p>
<p id="section-8.2.1.1-4">Manual handling of PKCS #12 objects is challenging for most users.
Producing the initial PKCS #12 object typically can only be done with the aid of a CA via non-standardized, labor-intensive, and error-prone procedures that most users do not understand.
Furthermore, manual export and import incurs ongoing labor (for example, before certificate expiration) by the user, which most users are unprepared to do (see <a href="#local-cert-maintenance" class="auto internal xref">Section 8.2.2</a>).<a href="#section-8.2.1.1-4" class="pilcrow">¶</a></p>
<p id="section-8.2.1.1-5">A better approach is for the MUA to integrate some form of automated certificate issuance procedure, for example, by using the Automatic Certificate Management Environment (ACME) protocol for end user S/MIME certificates <span>[<a href="#RFC8823" class="cite xref">RFC8823</a>]</span>.<a href="#section-8.2.1.1-5" class="pilcrow">¶</a></p>
<p id="section-8.2.1.1-6">Another possible approach is integration with a cryptographic hardware token or smart card that can provide certificates and permit the use of isolated secret key material, for example, see <span>[<a href="#PKCS11" class="cite xref">PKCS11</a>]</span>, though this approach delegates the complexity of acquiring and managing certificates to management of the hardware token itself (see <a href="#smartcards" class="auto internal xref">Appendix A.4.2</a>).<a href="#section-8.2.1.1-6" class="pilcrow">¶</a></p>
<p id="section-8.2.1.1-7">See also <span>[<a href="#I-D.woodhouse-cert-best-practice" class="cite xref">CERT-BEST-PRACTICE</a>]</span> for more recommendations about managing user certificates.<a href="#section-8.2.1.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="local-cert-pgp">
<section id="section-8.2.1.2">
            <h5 id="name-user-certificates-for-pgp-m">
<a href="#section-8.2.1.2" class="section-number selfRef">8.2.1.2. </a><a href="#name-user-certificates-for-pgp-m" class="section-name selfRef">User Certificates for PGP/MIME</a>
            </h5>
<p id="section-8.2.1.2-1">As distinct from S/MIME, OpenPGP <span>[<a href="#RFC9580" class="cite xref">RFC9580</a>]</span> has a different set of common practices.
For one thing, a single OpenPGP certificate can contain both a signing-capable key and a distinct encryption-capable key, so only one certificate is needed for an email user of OpenPGP as long as the certificate has distinct key material for the different purposes.<a href="#section-8.2.1.2-1" class="pilcrow">¶</a></p>
<p id="section-8.2.1.2-2">Furthermore, a single OpenPGP certificate <span class="bcp14">MAY</span> only be self-signed, so the MUA can generate such a certificate entirely on its own.<a href="#section-8.2.1.2-2" class="pilcrow">¶</a></p>
<p id="section-8.2.1.2-3">An OpenPGP-capable MUA should have the ability to import and export OpenPGP Transferable Secret Keys (see <span><a href="https://rfc-editor.org/rfc/rfc9580#section-10.2" class="relref">Section 10.2</a> of [<a href="#RFC9580" class="cite xref">RFC9580</a>]</span>) to enable manual transfer of user certificates and secret key material between multiple MUAs controlled by the user.<a href="#section-8.2.1.2-3" class="pilcrow">¶</a></p>
<p id="section-8.2.1.2-4">Since an OpenPGP certificate <span class="bcp14">MAY</span> be certified by third parties (whether formal CAs or merely other well-connected peers), the MUA <span class="bcp14">SHOULD</span> offer affordances to help the user acquire and merge third-party certifications on their certificate.
When doing this, the MUA should prioritize third-party certifications from entities that the user's peers are likely to know about and be willing to rely on.<a href="#section-8.2.1.2-4" class="pilcrow">¶</a></p>
<p id="section-8.2.1.2-5">Since an OpenPGP certificate can grow arbitrarily large with third-party certifications, the MUA should assist the user in pruning it to ensure that it remains a reasonable size when transmitting it to other parties.<a href="#section-8.2.1.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="local-key-generation">
<section id="section-8.2.1.3">
            <h5 id="name-generate-secret-key-materia">
<a href="#section-8.2.1.3" class="section-number selfRef">8.2.1.3. </a><a href="#name-generate-secret-key-materia" class="section-name selfRef">Generate Secret Key Material Locally</a>
            </h5>
<p id="section-8.2.1.3-1">Regardless of the protocol used (S/MIME or PGP), when producing certificates for the end user, the MUA <span class="bcp14">SHOULD</span> ensure that it has generated secret key material locally and <span class="bcp14">MUST NOT</span> accept secret key material from an untrusted external party as the basis for the user's certificate.
For example, a user who trusts their system administrator not to compromise their MUA may accept secret key material generated by the system administrator but probably should not accept secret key material generated by an unaffiliated online web service.<a href="#section-8.2.1.3-1" class="pilcrow">¶</a></p>
<p id="section-8.2.1.3-2">An MUA that accepts secret key material from a third party cannot prevent that third party from retaining this material.
A third party with this level of access could decrypt messages intended to be confidential for the user or could forge messages that would appear to come from the user.<a href="#section-8.2.1.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="local-cert-maintenance">
<section id="section-8.2.2">
          <h4 id="name-local-certificate-maintenan">
<a href="#section-8.2.2" class="section-number selfRef">8.2.2. </a><a href="#name-local-certificate-maintenan" class="section-name selfRef">Local Certificate Maintenance</a>
          </h4>
<p id="section-8.2.2-1">In the context of a single email account managed by an MUA, where that email account is expected to be able to use end-to-end cryptographic protections, the MUA <span class="bcp14">SHOULD</span> warn the user (or proactively fix the problem) when/if:<a href="#section-8.2.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.2.2-2.1">
              <p id="section-8.2.2-2.1.1">For S/MIME, the user's own certificate set for the account does not include a valid, unexpired encryption-capable X.509 certificate and a valid, unexpired signature-capable X.509 certificate.<a href="#section-8.2.2-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-8.2.2-2.2">
              <p id="section-8.2.2-2.2.1">For PGP/MIME, the user's own certificate does not include a valid, unexpired signing-capable key/subkey and a valid, unexpired encryption-capable key/subkey.<a href="#section-8.2.2-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-8.2.2-2.3">
              <p id="section-8.2.2-2.3.1">Any of the user's own certificates for the account:<a href="#section-8.2.2-2.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.2.2-2.3.2.1">
                  <p id="section-8.2.2-2.3.2.1.1">are due to expire in the next month (or at some other reasonable cadence).<a href="#section-8.2.2-2.3.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-8.2.2-2.3.2.2">
                  <p id="section-8.2.2-2.3.2.2.1">do not match the email address associated with the account in question.<a href="#section-8.2.2-2.3.2.2.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
            <li class="normal" id="section-8.2.2-2.4">
              <p id="section-8.2.2-2.4.1">Any of the user's own S/MIME certificates for the account:<a href="#section-8.2.2-2.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.2.2-2.4.2.1">
                  <p id="section-8.2.2-2.4.2.1.1">do not have a keyUsage extension.<a href="#section-8.2.2-2.4.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-8.2.2-2.4.2.2">
                  <p id="section-8.2.2-2.4.2.2.1">do not contain an extendedKeyUsage extension.<a href="#section-8.2.2-2.4.2.2.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-8.2.2-2.4.2.3">
                  <p id="section-8.2.2-2.4.2.3.1">would be considered invalid by the MUA for any other reason if it were a peer certificate.<a href="#section-8.2.2-2.4.2.3.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
          </ul>
<p id="section-8.2.2-3">An MUA that takes active steps to fix any of these problems before they arise is even more usable than one that just issues warnings, but guidance on how to do active certificate maintenance is beyond the scope of this document (see <a href="#more-local-cert-maintenance" class="auto internal xref">Appendix A.4.3</a>).<a href="#section-8.2.2-3" class="pilcrow">¶</a></p>
<p id="section-8.2.2-4">If the MUA does find any of these issues and chooses to warn the user, it should use one aggregate warning with simple language that describes how the certificates might not be acceptable for other people and recommend a course of action that the user can take to remedy the problem.<a href="#section-8.2.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sending-certificates">
<section id="section-8.2.3">
          <h4 id="name-shipping-certificates-in-ou">
<a href="#section-8.2.3" class="section-number selfRef">8.2.3. </a><a href="#name-shipping-certificates-in-ou" class="section-name selfRef">Shipping Certificates in Outbound Messages</a>
          </h4>
<p id="section-8.2.3-1">When composing mail, a conformant MUA <span class="bcp14">SHOULD</span> include copies of the user's own certificates (and potentially other certificates) in each message to facilitate future communication, unless it has specific knowledge that the other parties involved already know the relevant keys (for example, if it is mail between members within a domain that has a synchronized and up-to-date certificate directory).<a href="#section-8.2.3-1" class="pilcrow">¶</a></p>
<p id="section-8.2.3-2">The mechanism for including these certificates, and which certificates to include in the message, are protocol specific.<a href="#section-8.2.3-2" class="pilcrow">¶</a></p>
<div id="shipping-certificates-in-smime-messages">
<section id="section-8.2.3.1">
            <h5 id="name-shipping-certificates-in-s-">
<a href="#section-8.2.3.1" class="section-number selfRef">8.2.3.1. </a><a href="#name-shipping-certificates-in-s-" class="section-name selfRef">Shipping Certificates in S/MIME Messages</a>
            </h5>
<p id="section-8.2.3.1-1">In any S/MIME SignedData object, certificates can be shipped in the "certificates" member.
In any S/MIME EnvelopedData object, certificates can be shipped in the "originatorInfo.certs" member.<a href="#section-8.2.3.1-1" class="pilcrow">¶</a></p>
<p id="section-8.2.3.1-2">When a single S/MIME-protected email message is signed-and-encrypted, it is usually sufficient to ship all the relevant certificates in the inner SignedData object's "certificates" member.<a href="#section-8.2.3.1-2" class="pilcrow">¶</a></p>
<p id="section-8.2.3.1-3">The S/MIME certificates shipped in such a message <span class="bcp14">SHOULD</span> include:<a href="#section-8.2.3.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.2.3.1-4.1">
                <p id="section-8.2.3.1-4.1.1">the user's own S/MIME signing certificate, so that signature on the current message can be validated.<a href="#section-8.2.3.1-4.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-8.2.3.1-4.2">
                <p id="section-8.2.3.1-4.2.1">the user's own S/MIME encryption-capable certificate, so that the recipient can reply in encrypted form.<a href="#section-8.2.3.1-4.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-8.2.3.1-4.3">
                <p id="section-8.2.3.1-4.3.1">on an encrypted message to multiple recipients, the encryption-capable peer certificates of the other recipients, so that any recipient can easily "reply all" without needing to search for certificates.<a href="#section-8.2.3.1-4.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-8.2.3.1-4.4">
                <p id="section-8.2.3.1-4.4.1">any intermediate CA certificates needed to chain all of the above to a widely trusted set of root authorities.<a href="#section-8.2.3.1-4.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</section>
</div>
<div id="shipping-certificates-in-pgpmime-messages">
<section id="section-8.2.3.2">
            <h5 id="name-shipping-certificates-in-pg">
<a href="#section-8.2.3.2" class="section-number selfRef">8.2.3.2. </a><a href="#name-shipping-certificates-in-pg" class="section-name selfRef">Shipping Certificates in PGP/MIME Messages</a>
            </h5>
<p id="section-8.2.3.2-1">PGP/MIME does not have a single specific standard location for shipping certificates.<a href="#section-8.2.3.2-1" class="pilcrow">¶</a></p>
<p id="section-8.2.3.2-2">Some MUAs ship relevant OpenPGP certificates in a single MIME leaf of Content-Type "application/pgp-keys".
When such a message has cryptographic protections, to ensure that the message is well-formed, this kind of MIME part <span class="bcp14">SHOULD</span> be a leaf of the Cryptographic Payload and not outside of it.
One problem with this approach is that it appears to recipients with non-cryptographic MUAs as an "attachment", which can lead to confusion if the user does not know how to use it.<a href="#section-8.2.3.2-2" class="pilcrow">¶</a></p>
<p id="section-8.2.3.2-3">Other implementations ship relevant OpenPGP certificates in "Autocrypt" or "Autocrypt-Gossip" message header fields (see <span>[<a href="#AUTOCRYPT" class="cite xref">AUTOCRYPT</a>]</span>).
To ensure that those header fields receive the same cryptographic authenticity as the rest of the message, these header fields <span class="bcp14">SHOULD</span> be protected as described in <span>[<a href="#RFC9788" class="cite xref">RFC9788</a>]</span>.<a href="#section-8.2.3.2-3" class="pilcrow">¶</a></p>
<p id="section-8.2.3.2-4">The OpenPGP certificates shipped in such a message <span class="bcp14">SHOULD</span> include:<a href="#section-8.2.3.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.2.3.2-5.1">
                <p id="section-8.2.3.2-5.1.1">the user's own OpenPGP certificate, capable of both signing and encryption, so that the user can validate the message's signature and can encrypt future messages.<a href="#section-8.2.3.2-5.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-8.2.3.2-5.2">
                <p id="section-8.2.3.2-5.2.1">on an encrypted message to multiple recipients, the OpenPGP certificates of the other recipients, so that any recipient can easily "reply all" without needing to search for certificates.<a href="#section-8.2.3.2-5.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="common-pitfalls">
<section id="section-9">
      <h2 id="name-common-pitfalls-and-guideli">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-common-pitfalls-and-guideli" class="section-name selfRef">Common Pitfalls and Guidelines</a>
      </h2>
<p id="section-9-1">This section highlights a few "pitfalls" and guidelines based on these discussions and lessons learned.<a href="#section-9-1" class="pilcrow">¶</a></p>
<div id="reading-sent-messages">
<section id="section-9.1">
        <h3 id="name-reading-sent-messages">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-reading-sent-messages" class="section-name selfRef">Reading Sent Messages</a>
        </h3>
<p id="section-9.1-1">When sending a message, a typical MUA will store a copy of the message sent in sender's Sent mail folder so that the sender can read it later.
If the message is an encrypted message, storing it encrypted requires some forethought to ensure that the sender can read it in the future.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<p id="section-9.1-2">It is a common and simple practice to encrypt the message not only to the recipients of the message but also to the sender.
One advantage of doing this is that the message that is sent on the wire can be identical to the message stored in the sender's Sent mail folder.
This allows the sender to review and reread the message even though it was encrypted.<a href="#section-9.1-2" class="pilcrow">¶</a></p>
<p id="section-9.1-3">There are at least three other approaches that are possible to ensure future readability by the sender of the message but with different trade-offs:<a href="#section-9.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.1-4.1">
            <p id="section-9.1-4.1.1">Encrypt two versions of the message: one to the recipients (this version is sent on the wire) and one to the sender only (this version is stored in the sender's Sent folder).
This approach means that the message stored in the Sent folder is not byte-for-byte identical to the message sent to the recipients.
In the event that message delivery has a transient failure, the MUA cannot simply resubmit the stored message into the SMTP system and expect it to be readable by the recipient.<a href="#section-9.1-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-4.2">
            <p id="section-9.1-4.2.1">Store a cleartext version of the message in the Sent folder.
     This presents a risk of information leakage: Anyone with access to the Sent folder can read the contents of the message.
Furthermore, in any attempt to resend the message, the cryptographic transformation needs to be reapplied before sending or else the message contents will leak upon resend.
A conformant MUA <span class="bcp14">SHOULD NOT</span> store a cleartext copy in the Sent folder unless it knows that the Sent folder cannot be read by an attacker.
For example, if end-to-end confidentiality is desired, then storing the cleartext in an IMAP folder where a potentially adversarial server can read it defeats the purpose.<a href="#section-9.1-4.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-4.3">
            <p id="section-9.1-4.3.1">A final option is that the MUA can store a copy of the message's encryption session key.
Standard email encryption mechanisms (e.g., S/MIME and PGP/MIME) are hybrid mechanisms: The asymmetric encryption steps simply encrypt a symmetric "session key", which is used to encrypt the message itself.
If the MUA stores the session key itself, it can use the session key to decrypt the Sent message without needing the Sent message to be decryptable by the user's own asymmetric key.
An MUA doing this must take care to store (and backup) its stash of session keys, because if it loses them, it will not be able to read the sent messages; and if someone else gains access to them, they can decrypt the sent messages.
This has the additional consequence that any other MUA accessing the same Sent folder cannot decrypt the message unless it also has access to the stashed session key.<a href="#section-9.1-4.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="reading-encrypted-messages-after-certificate-expiration">
<section id="section-9.2">
        <h3 id="name-reading-encrypted-messages-">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-reading-encrypted-messages-" class="section-name selfRef">Reading Encrypted Messages after Certificate Expiration</a>
        </h3>
<p id="section-9.2-1">When encrypting a message, the composing MUA should decline to encrypt to an expired certificate (see <a href="#peer-cert-selection" class="auto internal xref">Section 8.1.1</a>).
But when decrypting a message, as long as the viewing MUA has access to the appropriate secret key material, it should permit decryption of the message, even if the associated certificate is expired.
That is, the rendering MUA should not prevent the user from reading a message that they have access to merely due to an expired encryption certificate.<a href="#section-9.2-1" class="pilcrow">¶</a></p>
<p id="section-9.2-2">The rendering MUA may warn the user when decrypting a message that appears to have been encrypted to an encryption-capable certificate that was expired at the time of encryption (e.g., based on the <code>Date</code> header field of the message or the timestamp in the cryptographic signature) but otherwise should not complain.<a href="#section-9.2-2" class="pilcrow">¶</a></p>
<p id="section-9.2-3">The primary goal of certificate expiration is to facilitate rotation of secret key material, so that secret key material does not need to be retained indefinitely.
Certificate expiration permits the user to destroy an older secret key if access to the messages encrypted to it is no longer necessary (see also <a href="#secure-deletion" class="auto internal xref">Appendix A.10</a>).<a href="#section-9.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="message-header-fields">
<section id="section-9.3">
        <h3 id="name-unprotected-message-header-">
<a href="#section-9.3" class="section-number selfRef">9.3. </a><a href="#name-unprotected-message-header-" class="section-name selfRef">Unprotected Message Header Fields</a>
        </h3>
<p id="section-9.3-1">Many legacy cryptographically aware MUAs only apply cryptographic protections to the body of the message but leave the header fields unprotected.
This gives rise to vulnerabilities like information leakage (e.g., the Subject line is visible to a passive intermediary) or message tampering (e.g., the Subject line is replaced, effectively changing the semantics of a signed message).
These are not only security vulnerabilities but also usability problems, because the distinction between what is part of the header section and what is part of the body of a message is unclear to many end users and requires a more complex mental model than is necessary.
Useful security comes from alignment between simple mental models and tooling.<a href="#section-9.3-1" class="pilcrow">¶</a></p>
<p id="section-9.3-2">To avoid these concerns, a conformant MUA <span class="bcp14">MUST</span> implement Header Protection as described in <span>[<a href="#RFC9788" class="cite xref">RFC9788</a>]</span>.<a href="#section-9.3-2" class="pilcrow">¶</a></p>
<p id="section-9.3-3">Note that some message header fields, such as <code>List-*</code>, <code>Archived-At</code>, and <code>Resent-*</code>, are typically added by an intervening MUA (see <a href="#intervening-mua" class="auto internal xref">Section 9.8</a>), not by one of the classic "ends" of an end-to-end email exchange.
A rendering MUA may choose to consider the contents of these header fields on an end-to-end protected message as markers added during message transit, even if they are not covered by the end-to-end cryptographic protection.<a href="#section-9.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="bcc-variants">
<section id="section-9.4">
        <h3 id="name-composing-an-encrypted-mess">
<a href="#section-9.4" class="section-number selfRef">9.4. </a><a href="#name-composing-an-encrypted-mess" class="section-name selfRef">Composing an Encrypted Message with Bcc</a>
        </h3>
<p id="section-9.4-1">When composing an encrypted message containing at least one recipient address in the <code>Bcc</code> header field, there is a risk that the encrypted message itself could leak information about the actual recipients, even if the <code>Bcc</code> header field does not mention the recipient.
For example, if the message clearly indicates which certificates it is encrypted to, the set of certificates can identify the recipients even if they are not named in the message header fields.<a href="#section-9.4-1" class="pilcrow">¶</a></p>
<p id="section-9.4-2">Because of these complexities, there are several interacting factors that need to be taken into account when composing an encrypted message with <code>Bcc</code>'ed recipients.<a href="#section-9.4-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.4-3.1">
            <p id="section-9.4-3.1.1">Should the <code>Bcc</code> header field be populated explicitly on <code>Bcc</code>'ed copies
      of the message and in the copy stored in the sender's <code>Sent</code>
      folder? See <span><a href="https://rfc-editor.org/rfc/rfc5322#section-3.6.3" class="relref">Section 3.6.3</a> of [<a href="#RFC5322" class="cite xref">RFC5322</a>]</span> for a set of choices.<a href="#section-9.4-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.4-3.2">
            <p id="section-9.4-3.2.1">When separate copies are made for <code>Bcc</code>'ed recipients, should each separate copy <em>also</em> be encrypted to the named recipients or just to the designated <code>Bcc</code> recipient?<a href="#section-9.4-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.4-3.3">
            <p id="section-9.4-3.3.1">When a copy is stored in the <code>Sent</code> folder, should that copy also be encrypted to <code>Bcc</code>'ed recipients? (See also <a href="#reading-sent-messages" class="auto internal xref">Section 9.1</a>.)<a href="#section-9.4-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.4-3.4">
            <p id="section-9.4-3.4.1">When a message is encrypted, if there is a mechanism to include the certificates of the recipients, whose certificates should be included?<a href="#section-9.4-3.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div id="bcc-recommendation">
<section id="section-9.4.1">
          <h4 id="name-simple-encryption-with-bcc">
<a href="#section-9.4.1" class="section-number selfRef">9.4.1. </a><a href="#name-simple-encryption-with-bcc" class="section-name selfRef">Simple Encryption with Bcc</a>
          </h4>
<p id="section-9.4.1-1">Here is a simple approach that tries to minimize the total number of variants of the message created while leaving a coherent view of the message itself:<a href="#section-9.4.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.4.1-2.1">
              <p id="section-9.4.1-2.1.1">No Cryptographic Payload contains any <code>Bcc</code> header field.<a href="#section-9.4.1-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.4.1-2.2">
              <p id="section-9.4.1-2.2.1">The main copy of the message is signed and encrypted to all named recipients and to the sender.
A copy of this message is also stored in the sender's <code>Sent</code> folder.<a href="#section-9.4.1-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.4.1-2.3">
              <p id="section-9.4.1-2.3.1">Each <code>Bcc</code> recipient receives a distinct copy of the message, with an identical Cryptographic Payload (that is, the cleartext is identical), and the message is signed and encrypted to that specific recipient and all the named recipients.
These copies are not stored in the sender's <code>Sent</code> folder.<a href="#section-9.4.1-2.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.4.1-2.4">
              <p id="section-9.4.1-2.4.1">Any <code>Bcc</code>'ed recipient <span class="bcp14">MUST NOT</span> be taken into consideration when determining which certificates to include in the message.
In particular, certificates for <code>Bcc</code>'ed recipients <span class="bcp14">MUST NOT</span> included in any message.<a href="#section-9.4.1-2.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<div id="rationale">
<section id="section-9.4.1.1">
            <h5 id="name-rationale">
<a href="#section-9.4.1.1" class="section-number selfRef">9.4.1.1. </a><a href="#name-rationale" class="section-name selfRef">Rationale</a>
            </h5>
<p id="section-9.4.1.1-1">The approach described in <a href="#bcc-recommendation" class="auto internal xref">Section 9.4.1</a> aligns the list of cryptographic recipients as closely as possible with the set of named recipients while still allowing a <code>Bcc</code>'ed recipient to read their own copy and to "reply all", should they want to.<a href="#section-9.4.1.1-1" class="pilcrow">¶</a></p>
<p id="section-9.4.1.1-2">This should reduce user confusion on the receiving side: A recipient of such a message who naively looks at the User-Facing Header Fields from their own mailbox will have a good sense of what cryptographic treatments have been applied to the message.
It also simplifies message composition and user experience: The message composer sees fields that match their expectations about what will happen to the message.
Additionally, it may preserve the ability for a <code>Bcc</code>'ed recipient to retain their anonymity, should they need to offer the signed Cryptographic Payload to an outside party as proof of the original sender's intent without revealing their own identity.<a href="#section-9.4.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="draft-messages">
<section id="section-9.5">
        <h3 id="name-draft-messages">
<a href="#section-9.5" class="section-number selfRef">9.5. </a><a href="#name-draft-messages" class="section-name selfRef">Draft Messages</a>
        </h3>
<p id="section-9.5-1">When composing a message, most MUAs will save a copy of the as-yet-unsent message to a "Drafts" folder.
If that folder is itself stored somewhere not under the user's control (e.g., an IMAP mailbox), it would be a mistake to store the draft message in the clear, because its contents could leak.<a href="#section-9.5-1" class="pilcrow">¶</a></p>
<p id="section-9.5-2">This is the case even if the message is ultimately sent deliberately in the clear.
During message composition, the MUA does not know whether the message is intended to be sent encrypted or not.
For example, just before sending, the user could decide to encrypt the message, and the MUA would have had no way of knowing.<a href="#section-9.5-2" class="pilcrow">¶</a></p>
<p id="section-9.5-3">The MUA <span class="bcp14">SHOULD</span> encrypt all draft messages, unless it has explicit knowledge that the message will not be encrypted when sent or that the Drafts folder cannot be read by an attacker.
For example, if end-to-end confidentiality is desired, then storing a cleartext draft in an IMAP folder where a potentially adversarial server can read it defeats the purpose.<a href="#section-9.5-3" class="pilcrow">¶</a></p>
<p id="section-9.5-4">Furthermore, when encrypting a draft message, the message draft <span class="bcp14">MUST</span> only be encrypted to the user's own certificate or to some equivalent secret key that only the user possesses.
A draft message encrypted in this way can be decrypted when the user wants to resume composing the message but cannot be read by anyone else, including a potential intended recipient.
Note that a draft message encrypted in this way will only be resumable by another MUA attached to the same mailbox if that other MUA has access to the user's decryption-capable secret key.
This shared access to key material is also likely necessary for useful interoperability but is beyond the scope of this document (see <a href="#cross-mua-local-keys" class="auto internal xref">Appendix A.4.1</a>).<a href="#section-9.5-4" class="pilcrow">¶</a></p>
<p id="section-9.5-5">A conformant MUA <span class="bcp14">MUST NOT</span> sign a message draft with the user's normal signing key, because creating a non-repudiable signature implies a commitment from the sender.
If a signed draft message were to leak to the user's "Drafts" folder on some untrustworthy server, the server operator could claim that the user had committed to something that they had not yet decided to commit to.
If draft signing is intended for cryptographic coordination between multiple MUAs of the same user, it should be negotiated with a different key (but see <a href="#cross-mua-local-keys" class="auto internal xref">Appendix A.4.1</a>).<a href="#section-9.5-5" class="pilcrow">¶</a></p>
<p id="section-9.5-6">The message should only be encrypted to its recipients upon actually sending the message.
No reasonable user expects their message's intended recipients to be able to read a message that is not yet complete.<a href="#section-9.5-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mixed-recipients">
<section id="section-9.6">
        <h3 id="name-composing-a-message-to-hete">
<a href="#section-9.6" class="section-number selfRef">9.6. </a><a href="#name-composing-a-message-to-hete" class="section-name selfRef">Composing a Message to Heterogeneous Recipients</a>
        </h3>
<p id="section-9.6-1">When composing a message that the user intends to be encrypted, it's possible that some recipients will be unable to view an encrypted copy.
For example, when Carol composes a message to Alice and Bob, Carol's MUA may be able to find a valid encryption-capable certificate for Alice, but none for Bob.<a href="#section-9.6-1" class="pilcrow">¶</a></p>
<p id="section-9.6-2">In this situation, there are four possible strategies, each of which has a negative impact on the experience of using encrypted mail.
Carol's MUA can:<a href="#section-9.6-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-9.6-3">
<li id="section-9.6-3.1">
            <p id="section-9.6-3.1.1">send encrypted to Alice and Bob, knowing that Bob will be unable to read the message.<a href="#section-9.6-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.6-3.2">
            <p id="section-9.6-3.2.1">send encrypted to Alice only, dropping Bob from the message recipient list.<a href="#section-9.6-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.6-3.3">
            <p id="section-9.6-3.3.1">send the message in the clear to both Alice and Bob.<a href="#section-9.6-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.6-3.4">
            <p id="section-9.6-3.4.1">send an encrypted copy of the message to Alice and a cleartext copy to Bob.<a href="#section-9.6-3.4.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-9.6-4">Each of these strategies has different drawbacks.<a href="#section-9.6-4" class="pilcrow">¶</a></p>
<p id="section-9.6-5">The problem with approach 1 is that Bob will receive unreadable mail.<a href="#section-9.6-5" class="pilcrow">¶</a></p>
<p id="section-9.6-6">The problem with approach 2 is that Carol's MUA will not send the message to Bob, despite Carol asking it to.<a href="#section-9.6-6" class="pilcrow">¶</a></p>
<p id="section-9.6-7">The problem with approach 3 is that Carol's MUA will not encrypt the message, despite Carol asking it to.<a href="#section-9.6-7" class="pilcrow">¶</a></p>
<p id="section-9.6-8">Approach 4 has two problems:<a href="#section-9.6-8" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-9.6-9">
          <li id="section-9.6-9.1">
            <p id="section-9.6-9.1.1">Carol's MUA will release a cleartext copy of the message,
            despite Carol asking it to send the message encrypted.<a href="#section-9.6-9.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-9.6-9.2">
            <p id="section-9.6-9.2.1">If Alice wants to "reply all" to the message, she may not be
            able to find an encryption-capable certificate for Bob either.
            This puts Alice in an awkward and confusing position, one that
            users are unlikely to understand.  In particular, if Alice's MUA
            is following the guidance about replies to encrypted messages in
            <a href="#composing-reply" class="auto internal xref">Section 5.4</a>, having received an encrypted
            copy will make Alice's reply buffer behave in an unusual
            fashion.<a href="#section-9.6-9.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-9.6-10">This is particularly problematic when the second recipient is not "Bob" but in fact a public mailing list or other visible archive, where messages are simply never encrypted.<a href="#section-9.6-10" class="pilcrow">¶</a></p>
<p id="section-9.6-11">Carol is unlikely to understand the subtleties and negative downstream interactions involved with approaches 1 and 4, so presenting the user with those choices is not advised.<a href="#section-9.6-11" class="pilcrow">¶</a></p>
<p id="section-9.6-12">The most understandable approach for an MUA with an active user is to ask the user (when they hit "send") to choose between approach 2 and approach 3.
If the user declines to choose between 2 and 3, the MUA can drop them back to their message composition window and let them make alternate adjustments.<a href="#section-9.6-12" class="pilcrow">¶</a></p>
<p id="section-9.6-13">See also further discussion of these scenarios in <span>[<a href="#I-D.dkg-mail-cleartext-copy" class="cite xref">CLEARTEXT-COPY</a>]</span>.<a href="#section-9.6-13" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proxy-dangers">
<section id="section-9.7">
        <h3 id="name-message-transport-protocol-">
<a href="#section-9.7" class="section-number selfRef">9.7. </a><a href="#name-message-transport-protocol-" class="section-name selfRef">Message Transport Protocol Proxy: A Dangerous Implementation Choice</a>
        </h3>
<p id="section-9.7-1">An implementer of end-to-end cryptographic protections may be tempted by a simple software design that piggybacks off of a mail protocol, like SMTP Submission <span>[<a href="#RFC6409" class="cite xref">RFC6409</a>]</span>, IMAP <span>[<a href="#RFC9051" class="cite xref">RFC9051</a>]</span>, or JSON Meta Application Protocol (JMAP) <span>[<a href="#RFC8621" class="cite xref">RFC8621</a>]</span>, to handle message assembly and interpretation.
In such an architecture, a naive MUA speaks something like a "standard" protocol, like SMTP, IMAP, or JMAP, to a local proxy, and the proxy handles signing and encryption (outbound) and decryption and verification (inbound) internally on behalf of the user.
While such a "pluggable" architecture has the advantage of likely being easy to apply to any MUA, it is problematic for the goals of end-to-end communication, especially in an existing cleartext ecosystem like email, where any given message might be unsigned or signed, cleartext or encrypted.
In particular:<a href="#section-9.7-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.7-2.1">
            <p id="section-9.7-2.1.1">the user cannot easily and safely identify what protections any particular message has (including messages currently being composed) and<a href="#section-9.7-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.7-2.2">
            <p id="section-9.7-2.2.1">the proxy itself is unaware of subtle nuances about the message that the MUA actually knows.<a href="#section-9.7-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-9.7-3">With a trustworthy and well-synchronized side channel or protocol extension between the MUA and the proxy, it is possible to deploy such an implementation safely, but the requirement for the side channel or extension eliminates the universal deployability advantage of the scheme.<a href="#section-9.7-3" class="pilcrow">¶</a></p>
<p id="section-9.7-4">Similar concerns apply to any implementation bound by an API that operates on message objects alone, without any additional contextual parameters.<a href="#section-9.7-4" class="pilcrow">¶</a></p>
<p id="section-9.7-5">This section attempts to document some of the inherent risks involved with such an architecture.<a href="#section-9.7-5" class="pilcrow">¶</a></p>
<div id="proxy-for-message-composition">
<section id="section-9.7.1">
          <h4 id="name-dangers-of-a-submission-pro">
<a href="#section-9.7.1" class="section-number selfRef">9.7.1. </a><a href="#name-dangers-of-a-submission-pro" class="section-name selfRef">Dangers of a Submission Proxy for Message Composition</a>
          </h4>
<p id="section-9.7.1-1">When composing and sending a message, the act of applying cryptographic protections has subtleties that cannot be directly expressed in the SMTP protocol used by Submission <span>[<a href="#RFC6409" class="cite xref">RFC6409</a>]</span> or in any other simple protocol that hands off a cleartext message for further processing.<a href="#section-9.7.1-1" class="pilcrow">¶</a></p>
<p id="section-9.7.1-2">For example, the sender cannot indicate via SMTP whether or not a given message <em>should</em> be encrypted (some messages, such as those sent to a publicly archived mailing list, are pointless to encrypt) or select among multiple certificates for a recipient, if they exist (see <a href="#peer-cert-selection" class="auto internal xref">Section 8.1.1</a>).<a href="#section-9.7.1-2" class="pilcrow">¶</a></p>
<p id="section-9.7.1-3">Likewise, because such a proxy only interacts with the message when it is ready to be sent, it cannot indicate back to the user <em>during message composition</em> whether or not the message is able to be encrypted (that is, whether a valid certificate is available for each intended recipient).
A message author may write an entirely different message if they know that it will be protected end-to-end; however, without this knowledge, the author is obliged to either write text that they presume will be intercepted or risk revealing sensitive content.<a href="#section-9.7.1-3" class="pilcrow">¶</a></p>
<p id="section-9.7.1-4">Even without encryption, deciding whether to sign or not (and which certificate to sign with, if more than one exists) is another choice that the proxy is ill-equipped to make.
The common message-signing techniques either render a message unreadable by any non-cryptographic MUA (i.e., PKCS #7 signed-data) or appear as an attachment that can cause confusion to a naive recipient using a non-cryptographic MUA (i.e., multipart/signed).
If the composer knows that the recipient will not check signatures, they may prefer to leave a cleartext message without a cryptographic signature at all.<a href="#section-9.7.1-4" class="pilcrow">¶</a></p>
<p id="section-9.7.1-5">Furthermore, handling encryption properly depends on the context of any given message, which cannot be expressed by the MUA to the Submission proxy.
For example, decisions about how to handle encryption and quoted or attributed text may depend on the cryptographic status of the message that is being replied to (see <a href="#composing-reply" class="auto internal xref">Section 5.4</a>).<a href="#section-9.7.1-5" class="pilcrow">¶</a></p>
<p id="section-9.7.1-6">Additionally, such a proxy would need to be capable of managing the user's own key and certificate (see <a href="#local-certificates" class="auto internal xref">Section 8.2</a>).
For example, how will the implementation indicate to the user when their own certificate is near expiry?
How will any other error conditions be handled when communication with the user is needed?<a href="#section-9.7.1-6" class="pilcrow">¶</a></p>
<p id="section-9.7.1-7">While an extension to SMTP might be able to express all the necessary semantics that would allow a generic MUA to compose messages with standard cryptographic protections via a proxy, such an extension is beyond the scope of this document.
See <span>[<a href="#I-D.ietf-jmap-smime-sender-extensions" class="cite xref">SMIME-SENDER-EXTENSIONS</a>]</span> for an example of how an MUA using a proxy protocol might indicate signing and encryption instructions to its proxy.<a href="#section-9.7.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="dangers-of-an-imap-proxy-for-message-rendering">
<section id="section-9.7.2">
          <h4 id="name-dangers-of-an-imap-proxy-fo">
<a href="#section-9.7.2" class="section-number selfRef">9.7.2. </a><a href="#name-dangers-of-an-imap-proxy-fo" class="section-name selfRef">Dangers of an IMAP Proxy for Message Rendering</a>
          </h4>
<p id="section-9.7.2-1">When receiving and rendering a message, the process of indicating the cryptographic status of a message to the user requires subtleties that are difficult to offer from a straightforward IMAP (or Post Office Protocol (POP) <span>[<a href="#RFC1939" class="cite xref">RFC1939</a>]</span> or JMAP) proxy.<a href="#section-9.7.2-1" class="pilcrow">¶</a></p>
<p id="section-9.7.2-2">One approach such a proxy could take is to remove all the Cryptographic Layers from a well-formed message and to package a description of those layers into a special header field that the MUA can read.
But this merely raises the question: What semantics need to be represented?
For example:<a href="#section-9.7.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.7.2-3.1">
              <p id="section-9.7.2-3.1.1">Was the message signed?  If so, by whom?  When?<a href="#section-9.7.2-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.7.2-3.2">
              <p id="section-9.7.2-3.2.1">Should the details of the cryptographic algorithms used in any signatures found be indicated as well?<a href="#section-9.7.2-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.7.2-3.3">
              <p id="section-9.7.2-3.3.1">Was the message encrypted?  If so, to whom?  What key was used to decrypt it?<a href="#section-9.7.2-3.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.7.2-3.4">
              <p id="section-9.7.2-3.4.1">If both signed and encrypted, was the signing outside or inside the encryption?<a href="#section-9.7.2-3.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.7.2-3.5">
              <p id="section-9.7.2-3.5.1">How should Errant Cryptographic Layers (see <a href="#errant-cryptographic-layers" class="auto internal xref">Section 4.5</a>) be dealt with?<a href="#section-9.7.2-3.5.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.7.2-3.6">
              <p id="section-9.7.2-3.6.1">What cryptographic protections do the header fields of the message have? (See <span>[<a href="#RFC9788" class="cite xref">RFC9788</a>]</span>.)<a href="#section-9.7.2-3.6.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-9.7.2-3.7">
              <p id="section-9.7.2-3.7.1">How are any errors or surprises communicated to the user?<a href="#section-9.7.2-3.7.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-9.7.2-4">If the proxy passes any of this cryptographic status to the client in an added header field, it must also ensure that no such header field is present on the messages it receives before processing it.
If it were to allow such an unmodified header field through to any client that is willing to trust its contents, an attacker could spoof the field to make the user believe lies about the cryptographic status of the message.
In order for an MUA to be confident in such a header field, it needs a guarantee from the proxy that any header field it produces will be safe.
How does the MUA reliably negotiate this guarantee with the proxy?
If the proxy can no longer offer this guarantee, how will the MUA know that things have changed?<a href="#section-9.7.2-4" class="pilcrow">¶</a></p>
<p id="section-9.7.2-5">If such an inbound proxy handles certificate discovery in inbound messages (see <a href="#peer-discovery-incoming" class="auto internal xref">Appendix A.3.1</a>), it will also need to communicate the results of that discovery process to its corresponding outbound proxy for message composition (see <a href="#proxy-for-message-composition" class="auto internal xref">Section 9.7.1</a>).<a href="#section-9.7.2-5" class="pilcrow">¶</a></p>
<p id="section-9.7.2-6">While an extension to IMAP (or POP or JMAP) might be able to express all the necessary semantics that would allow a generic MUA to indicate standardized cryptographic message status, such an extension is beyond the scope of this document.
<span>[<a href="#RFC9219" class="cite xref">RFC9219</a>]</span> describes the transmission of an S/MIME signature verification status over JMAP, which is a subset of the cryptographic status information described here.<a href="#section-9.7.2-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="who-controls-the-proxy">
<section id="section-9.7.3">
          <h4 id="name-who-controls-the-proxy">
<a href="#section-9.7.3" class="section-number selfRef">9.7.3. </a><a href="#name-who-controls-the-proxy" class="section-name selfRef">Who Controls the Proxy?</a>
          </h4>
<p id="section-9.7.3-1">Finally, consider that the naive proxy deployment approach is risky precisely because of its opacity to the end user.
Such a deployment could be placed anywhere in the stack, including on a machine that is not ultimately controlled by the end user, making it effectively a form of transport protection rather than end-to-end protection.<a href="#section-9.7.3-1" class="pilcrow">¶</a></p>
<p id="section-9.7.3-2">An MUA explicitly under the control of the end user with thoughtful integration can offer UI/UX and security guarantees that a simple proxy cannot provide.
See also <a href="#proxy-extensions" class="auto internal xref">Appendix A.13</a> for suggestions of future work that might augment a proxy to make it safer.<a href="#section-9.7.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="intervening-mua">
<section id="section-9.8">
        <h3 id="name-intervening-muas-do-not-han">
<a href="#section-9.8" class="section-number selfRef">9.8. </a><a href="#name-intervening-muas-do-not-han" class="section-name selfRef">Intervening MUAs Do Not Handle End-to-End Cryptographic Protections</a>
        </h3>
<p id="section-9.8-1">Some MUAs will resend a message in identical form (or very similar form) to the way that they received it.
For example, consider the following use cases:<a href="#section-9.8-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.8-2.1">
            <p id="section-9.8-2.1.1">a mail expander or mailing list that receives a message and resends it to all subscribers (see also <a href="#mailing-lists" class="auto internal xref">Appendix A.14</a> for more discussion of mailing lists)<a href="#section-9.8-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.8-2.2">
            <p id="section-9.8-2.2.1">an individual user who reintroduces a message they received into the mail transport system (see <span><a href="https://rfc-editor.org/rfc/rfc5322#section-3.6.6" class="relref">Section 3.6.6</a> of [<a href="#RFC5322" class="cite xref">RFC5322</a>]</span>)<a href="#section-9.8-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.8-2.3">
            <p id="section-9.8-2.3.1">an automated email intake system that forwards a report to the mailboxes of responsible staffers<a href="#section-9.8-2.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-9.8-3">These MUAs intervene in message transport by receiving and then reinjecting messages into the mail transport system.
In some cases, the original sender or final recipient of a message that has passed through such an MUA may be unaware of the intervention.
(Note that an MUA that forwards a received message as a attachment (MIME subpart) of type <code>message/rfc822</code> or <code>message/global</code> or "inline" in the body of a message is <em>not</em> acting as an intervening MUA in this sense, because the forwarded message is encapsulated within a visible outer message that is clearly from the MUA itself.)<a href="#section-9.8-3" class="pilcrow">¶</a></p>
<p id="section-9.8-4">An intervening MUA should be aware of end-to-end cryptographic protections that might already exist on messages that they resend.
In particular, it is unclear what the "end-to-end" properties are of a message that has been handled by an intervening MUA.
For signed-only messages, if the intervening MUA makes any substantive modifications to the message as it passes it along, it may break the signature from the original sender.
In many cases, breaking the original signature is the appropriate result, since the original message has been modified, and the original sender has no control over the modifications made by the intervening MUA.
For signed-and-encrypted messages, if the intervening MUA is capable of decrypting the message, it must be careful when retransmitting the message.
Will the new recipient be able to decrypt it?
If not, will the message be useful to the recipient?
If not, it may not make sense to resend the message.<a href="#section-9.8-4" class="pilcrow">¶</a></p>
<p id="section-9.8-5">Beyond the act of resending, an intervening MUA should not itself try to apply end-to-end cryptographic protections on a message that it is resending unless directed otherwise by some future specification.
Additional layers of cryptographic protection added in an ad hoc way by an intervening MUA are more likely to confuse the recipient and will not be interpretable as end-to-end protections as they do not originate with the original sender of the message.<a href="#section-9.8-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="external-subresources">
<section id="section-9.9">
        <h3 id="name-external-subresources-in-mi">
<a href="#section-9.9" class="section-number selfRef">9.9. </a><a href="#name-external-subresources-in-mi" class="section-name selfRef">External Subresources in MIME Parts Break Cryptographic Protections</a>
        </h3>
<p id="section-9.9-1">A MIME part with a content type that can refer to external resources (like <code>text/html</code>) may itself have some sort of end-to-end cryptographic protections.
However, retrieving or rendering these external resources may violate the properties that users expect from cryptographic protection.<a href="#section-9.9-1" class="pilcrow">¶</a></p>
<p id="section-9.9-2">As a baseline, retrieving the external resource at the time a message is read can be used as a "web bug", leaking the activity and network location of the recipient to the server hosting the external resource.
This privacy risk is present, of course, even for messages with no cryptographic protections but may be even more surprising to users who are shown some level of security indicator about a given message.<a href="#section-9.9-2" class="pilcrow">¶</a></p>
<p id="section-9.9-3">Other problems with external resources are more specifically bound to cryptographic protections.<a href="#section-9.9-3" class="pilcrow">¶</a></p>
<p id="section-9.9-4">For example, a signed email message with a <code>text/html</code> part that refers to an external image (i.e., via <code>&lt;img src="https://example.com/img.png"&gt;</code>) may render differently if the hosting web server decides to serve different content at the source URL for the image.
This effectively breaks the goals of integrity and authenticity that the user should be able to rely on for signed messages, unless the external subresource has strict integrity guarantees (e.g., via <span>[<a href="#SRI" class="cite xref">SRI</a>]</span>).<a href="#section-9.9-4" class="pilcrow">¶</a></p>
<p id="section-9.9-5">Likewise, fetching an external subresource for a signed-and-encrypted message effectively breaks goals of privacy and confidentiality for the user.<a href="#section-9.9-5" class="pilcrow">¶</a></p>
<p id="section-9.9-6">This is loosely analogous to security indicator problems that arose for web browsers as described in <span>[<a href="#MIXED-CONTENT" class="cite xref">MIXED-CONTENT</a>]</span>.
However, while fetching the external subresource over https is sufficient to avoid a "mixed content" warning from most browsers, it is insufficient for an MUA that wants to offer its users true end-to-end guarantees for email messages.<a href="#section-9.9-6" class="pilcrow">¶</a></p>
<p id="section-9.9-7">A conformant composing MUA that applies signing-only cryptographic protection to a new email message with an external subresource should take one of the following options:<a href="#section-9.9-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.9-8.1">
            <p id="section-9.9-8.1.1">pre-fetch the external subresource and include it in the message itself,<a href="#section-9.9-8.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.9-8.2">
            <p id="section-9.9-8.2.1">use a strong integrity mechanism like Subresource Integrity <span>[<a href="#SRI" class="cite xref">SRI</a>]</span> to guarantee the content of the subresource (though this does not fix the "web bug" privacy risk described above), or<a href="#section-9.9-8.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.9-8.3">
            <p id="section-9.9-8.3.1">prompt the composing user to remove the subresource from the message.<a href="#section-9.9-8.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-9.9-9">A conformant composing MUA that applies encryption to a new email message with an external resource cannot depend on Subresource Integrity to protect the privacy and confidentiality of the message, so it should either pre-fetch the external resource to include it in the message or prompt the composing user to remove it before sending.<a href="#section-9.9-9" class="pilcrow">¶</a></p>
<p id="section-9.9-10">A conformant rendering MUA that encounters a message with end-to-end cryptographic protections that contain a subresource <span class="bcp14">MUST</span> either refuse to retrieve and render the external subresource or decline to treat the message as having cryptographic protections.
For example, it could indicate in the Cryptographic Summary that the message is Unprotected.<a href="#section-9.9-10" class="pilcrow">¶</a></p>
<p id="section-9.9-11">Note that when composing a message reply with quoted text from the original message, if the original message did contain an external resource, the composing MUA <span class="bcp14">SHOULD NOT</span> fetch the external resource solely to include it in the reply message, as doing so would trigger the "web bug" at reply composition time.
Instead, the safest way to deal with quoted text that contains an external resource in an end-to-end encrypted reply is to strip any reference to the external resource during initial composition of the reply.<a href="#section-9.9-11" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-10">
      <h2 id="name-iana-considerations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-10-1">This document has no IANA actions.<a href="#section-10-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-11">
      <h2 id="name-security-considerations">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-11-1">This entire document addresses security considerations about end-to-end cryptographic protections for email messages.<a href="#section-11-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-12">
      <h2 id="name-references">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-12.1">
        <h3 id="name-normative-references">
<a href="#section-12.1" class="section-number selfRef">12.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3156">[RFC3156]</dt>
        <dd>
<span class="refAuthor">Elkins, M.</span>, <span class="refAuthor">Del Torto, D.</span>, <span class="refAuthor">Levien, R.</span>, and <span class="refAuthor">T. Roessler</span>, <span class="refTitle">"MIME Security with OpenPGP"</span>, <span class="seriesInfo">RFC 3156</span>, <span class="seriesInfo">DOI 10.17487/RFC3156</span>, <time datetime="2001-08" class="refDate">August 2001</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3156">https://www.rfc-editor.org/info/rfc3156</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4289">[RFC4289]</dt>
        <dd>
<span class="refAuthor">Freed, N.</span> and <span class="refAuthor">J. Klensin</span>, <span class="refTitle">"Multipurpose Internet Mail Extensions (MIME) Part Four: Registration Procedures"</span>, <span class="seriesInfo">BCP 13</span>, <span class="seriesInfo">RFC 4289</span>, <span class="seriesInfo">DOI 10.17487/RFC4289</span>, <time datetime="2005-12" class="refDate">December 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4289">https://www.rfc-editor.org/info/rfc4289</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5890">[RFC5890]</dt>
        <dd>
<span class="refAuthor">Klensin, J.</span>, <span class="refTitle">"Internationalized Domain Names for Applications (IDNA): Definitions and Document Framework"</span>, <span class="seriesInfo">RFC 5890</span>, <span class="seriesInfo">DOI 10.17487/RFC5890</span>, <time datetime="2010-08" class="refDate">August 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5890">https://www.rfc-editor.org/info/rfc5890</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8551">[RFC8551]</dt>
        <dd>
<span class="refAuthor">Schaad, J.</span>, <span class="refAuthor">Ramsdell, B.</span>, and <span class="refAuthor">S. Turner</span>, <span class="refTitle">"Secure/Multipurpose Internet Mail Extensions (S/MIME) Version 4.0 Message Specification"</span>, <span class="seriesInfo">RFC 8551</span>, <span class="seriesInfo">DOI 10.17487/RFC8551</span>, <time datetime="2019-04" class="refDate">April 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8551">https://www.rfc-editor.org/info/rfc8551</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9598">[RFC9598]</dt>
        <dd>
<span class="refAuthor">Melnikov, A.</span>, <span class="refAuthor">Chuang, W.</span>, and <span class="refAuthor">C. Bonnell</span>, <span class="refTitle">"Internationalized Email Addresses in X.509 Certificates"</span>, <span class="seriesInfo">RFC 9598</span>, <span class="seriesInfo">DOI 10.17487/RFC9598</span>, <time datetime="2024-05" class="refDate">May 2024</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9598">https://www.rfc-editor.org/info/rfc9598</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9788">[RFC9788]</dt>
      <dd>
<span class="refAuthor">Gillmor, D. K.</span>, <span class="refAuthor">Hoeneisen, B.</span>, and <span class="refAuthor">A. Melnikov</span>, <span class="refTitle">"Header Protection for Cryptographically Protected Email"</span>, <span class="seriesInfo">RFC 9788</span>, <span class="seriesInfo">DOI 10.17487/RFC9788</span>, <time datetime="2025-08" class="refDate">August 2025</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9788">https://www.rfc-editor.org/info/rfc9788</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-12.2">
        <h3 id="name-informative-references">
<a href="#section-12.2" class="section-number selfRef">12.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="AUTOCRYPT">[AUTOCRYPT]</dt>
        <dd>
<span class="refAuthor">Autocrypt Team</span>, <span class="refTitle">"Autocrypt - Convenient End-to-End Encryption for E-Mail"</span>, <span>&lt;<a href="https://autocrypt.org/">https://autocrypt.org/</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.woodhouse-cert-best-practice">[CERT-BEST-PRACTICE]</dt>
        <dd>
<span class="refAuthor">Woodhouse, D.</span> and <span class="refAuthor">N. Mavrogiannopoulos</span>, <span class="refTitle">"Recommendations for applications using X.509 client certificates"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-woodhouse-cert-best-practice-01</span>, <time datetime="2023-07-25" class="refDate">25 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-woodhouse-cert-best-practice-01">https://datatracker.ietf.org/doc/html/draft-woodhouse-cert-best-practice-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="CHROME-INDICATORS">[CHROME-INDICATORS]</dt>
        <dd>
<span class="refAuthor">Schechter, E.</span>, <span class="refTitle">"Evolving Chrome's security indicators"</span>, <span class="refContent">Chromium Blog</span>, <time datetime="2018-05" class="refDate">May 2018</time>, <span>&lt;<a href="https://blog.chromium.org/2018/05/evolving-chromes-security-indicators.html">https://blog.chromium.org/2018/05/evolving-chromes-security-indicators.html</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.dkg-mail-cleartext-copy">[CLEARTEXT-COPY]</dt>
        <dd>
<span class="refAuthor">Gillmor, D. K.</span>, <span class="refTitle">"Encrypted E-mail with Cleartext Copies"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-dkg-mail-cleartext-copy-01</span>, <time datetime="2023-02-21" class="refDate">21 February 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-dkg-mail-cleartext-copy-01">https://datatracker.ietf.org/doc/html/draft-dkg-mail-cleartext-copy-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="DROWN">[DROWN]</dt>
        <dd>
<span class="refAuthor">Aviram, N.</span>, <span class="refAuthor">Schinzel, S.</span>, <span class="refAuthor">Somorovsky, J.</span>, <span class="refAuthor">Heninger, N.</span>, <span class="refAuthor">Dankel, M.</span>, <span class="refAuthor">Steube, J.</span>, <span class="refAuthor">Valenta, L.</span>, <span class="refAuthor">Adrian, D.</span>, <span class="refAuthor">Halderman, J. A.</span>, <span class="refAuthor">Dukhovni, V.</span>, <span class="refAuthor">Käsper, E.</span>, <span class="refAuthor">Cohney, S.</span>, <span class="refAuthor">Engels, S.</span>, <span class="refAuthor">Paar, C.</span>, and <span class="refAuthor">Y. Shavitt</span>, <span class="refTitle">"DROWN: Breaking TLS using SSLv2"</span>, <span class="refContent">Proceedings of the 25th USENIX Security Symposium (USENIX Security 16), pp. 689-706</span>, <time datetime="2016-08" class="refDate">August 2016</time>, <span>&lt;<a href="https://drownattack.com/drown-attack-paper.pdf">https://drownattack.com/drown-attack-paper.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="EFAIL">[EFAIL]</dt>
        <dd>
<span class="refAuthor">Poddebniak, D.</span>, <span class="refAuthor">Dresen, C.</span>, <span class="refAuthor">Müller, J.</span>, <span class="refAuthor">Ising, F.</span>, <span class="refAuthor">Schinzel, S.</span>, <span class="refAuthor">Friedberger, S.</span>, <span class="refAuthor">Somorovsky, J.</span>, and <span class="refAuthor">J. Schwenk</span>, <span class="refTitle">"Efail: Breaking S/MIME and OpenPGP Email Encryption using Exfiltration Channels"</span>, <span class="refContent">Proceedings of the 27th USENIX Security Symposium (USENIX Security 18), pp. 549-566</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.usenix.org/conference/usenixsecurity18/presentation/poddebniak">https://www.usenix.org/conference/usenixsecurity18/presentation/poddebniak</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="IKE">[IKE]</dt>
        <dd>
<span class="refAuthor">Felsch, D.</span>, <span class="refAuthor">Grothe, M.</span>, <span class="refAuthor">Schwenk, J.</span>, <span class="refAuthor">Czubak, A.</span>, and <span class="refAuthor">M. Szymane</span>, <span class="refTitle">"The Dangers of Key Reuse: Practical Attacks on IPsec IKE"</span>, <span class="refContent">Proceedings of the 27th USENIX Security Symposium, pp. 567-583</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.usenix.org/system/files/conference/usenixsecurity18/sec18-felsch.pdf">https://www.usenix.org/system/files/conference/usenixsecurity18/sec18-felsch.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="MIXED-CONTENT">[MIXED-CONTENT]</dt>
        <dd>
<span class="refAuthor">Stark, E., Ed.</span>, <span class="refAuthor">West, M., Ed.</span>, and <span class="refAuthor">C. Lopez, Ed.</span>, <span class="refTitle">"Mixed Content"</span>, <span class="refContent">W3C Candidate Recommendation Draft</span>, <time datetime="2023-02" class="refDate">February 2023</time>, <span>&lt;<a href="https://www.w3.org/TR/2023/CRD-mixed-content-20230223/">https://www.w3.org/TR/2023/CRD-mixed-content-20230223/</a>&gt;</span>. <span class="annotation">Latest version available at <span>&lt;<a href="https://www.w3.org/TR/mixed-content/">https://www.w3.org/TR/mixed-content/</a>&gt;</span>.</span>
        </dd>
<dd class="break"></dd>
<dt id="I-D.wussler-openpgp-forwarding">[OPENPGP-FORWARDING]</dt>
        <dd>
<span class="refAuthor">Wussler, A.</span>, <span class="refTitle">"Automatic Forwarding for ECDH Curve25519 OpenPGP messages"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-wussler-openpgp-forwarding-00</span>, <time datetime="2023-07-10" class="refDate">10 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-wussler-openpgp-forwarding-00">https://datatracker.ietf.org/doc/html/draft-wussler-openpgp-forwarding-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="ORACLE">[ORACLE]</dt>
        <dd>
<span class="refAuthor">Ising, F.</span>, <span class="refAuthor">Poddebniak, D.</span>, <span class="refAuthor">Kappert, T.</span>, <span class="refAuthor">Saatjohann, C.</span>, and <span class="refAuthor">S. Schinzel</span>, <span class="refTitle">"Content-Type: multipart/oracle - Tapping into Format Oracles in Email End-to-End Encryption"</span>, <span class="refContent">Proceedings of the 32nd USENIX Security Symposium (USENIX Security 23), pp. 4175-4192</span>, <time datetime="2023-08" class="refDate">August 2023</time>, <span>&lt;<a href="https://www.usenix.org/conference/usenixsecurity23/presentation/ising">https://www.usenix.org/conference/usenixsecurity23/presentation/ising</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PKCS11">[PKCS11]</dt>
        <dd>
<span class="refAuthor">Bong, D., Ed.</span> and <span class="refAuthor">T. Cox, Ed.</span>, <span class="refTitle">"PKCS #11 Specification Version 3.1"</span>, <span class="refContent">OASIS Standard</span>, <time datetime="2023-07" class="refDate">July 2023</time>, <span>&lt;<a href="https://docs.oasis-open.org/pkcs11/pkcs11-spec/v3.1/os/pkcs11-spec-v3.1-os.html">https://docs.oasis-open.org/pkcs11/pkcs11-spec/v3.1/os/pkcs11-spec-v3.1-os.html</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="REPLY">[REPLY]</dt>
        <dd>
<span class="refAuthor">Müller, J.</span>, <span class="refAuthor">Brinkmann, M.</span>, <span class="refAuthor">Poddebniak, D.</span>, <span class="refAuthor">Schinzel, S.</span>, and <span class="refAuthor">J. Schwenk</span>, <span class="refTitle">"Re: What's Up Johnny?: Covert Content Attacks on Email End-to-End Encryption"</span>, <span class="refContent">Applied Cryptography and Network Security (ACNS 2019), Lecture Notes in Computer Science, vol. 11464, pp. 24-42</span>, <span class="seriesInfo">DOI 10.1007/978-3-030-21568-2_2</span>, <time datetime="2019-04" class="refDate">April 2019</time>, <span>&lt;<a href="https://doi.org/10.1007/978-3-030-21568-2_2">https://doi.org/10.1007/978-3-030-21568-2_2</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC1939">[RFC1939]</dt>
        <dd>
<span class="refAuthor">Myers, J.</span> and <span class="refAuthor">M. Rose</span>, <span class="refTitle">"Post Office Protocol - Version 3"</span>, <span class="seriesInfo">STD 53</span>, <span class="seriesInfo">RFC 1939</span>, <span class="seriesInfo">DOI 10.17487/RFC1939</span>, <time datetime="1996-05" class="refDate">May 1996</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc1939">https://www.rfc-editor.org/info/rfc1939</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2045">[RFC2045]</dt>
        <dd>
<span class="refAuthor">Freed, N.</span> and <span class="refAuthor">N. Borenstein</span>, <span class="refTitle">"Multipurpose Internet Mail Extensions (MIME) Part One: Format of Internet Message Bodies"</span>, <span class="seriesInfo">RFC 2045</span>, <span class="seriesInfo">DOI 10.17487/RFC2045</span>, <time datetime="1996-11" class="refDate">November 1996</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2045">https://www.rfc-editor.org/info/rfc2045</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3207">[RFC3207]</dt>
        <dd>
<span class="refAuthor">Hoffman, P.</span>, <span class="refTitle">"SMTP Service Extension for Secure SMTP over Transport Layer Security"</span>, <span class="seriesInfo">RFC 3207</span>, <span class="seriesInfo">DOI 10.17487/RFC3207</span>, <time datetime="2002-02" class="refDate">February 2002</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3207">https://www.rfc-editor.org/info/rfc3207</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3274">[RFC3274]</dt>
        <dd>
<span class="refAuthor">Gutmann, P.</span>, <span class="refTitle">"Compressed Data Content Type for Cryptographic Message Syntax (CMS)"</span>, <span class="seriesInfo">RFC 3274</span>, <span class="seriesInfo">DOI 10.17487/RFC3274</span>, <time datetime="2002-06" class="refDate">June 2002</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3274">https://www.rfc-editor.org/info/rfc3274</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3370">[RFC3370]</dt>
        <dd>
<span class="refAuthor">Housley, R.</span>, <span class="refTitle">"Cryptographic Message Syntax (CMS) Algorithms"</span>, <span class="seriesInfo">RFC 3370</span>, <span class="seriesInfo">DOI 10.17487/RFC3370</span>, <time datetime="2002-08" class="refDate">August 2002</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3370">https://www.rfc-editor.org/info/rfc3370</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4511">[RFC4511]</dt>
        <dd>
<span class="refAuthor">Sermersheim, J., Ed.</span>, <span class="refTitle">"Lightweight Directory Access Protocol (LDAP): The Protocol"</span>, <span class="seriesInfo">RFC 4511</span>, <span class="seriesInfo">DOI 10.17487/RFC4511</span>, <time datetime="2006-06" class="refDate">June 2006</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4511">https://www.rfc-editor.org/info/rfc4511</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5322">[RFC5322]</dt>
        <dd>
<span class="refAuthor">Resnick, P., Ed.</span>, <span class="refTitle">"Internet Message Format"</span>, <span class="seriesInfo">RFC 5322</span>, <span class="seriesInfo">DOI 10.17487/RFC5322</span>, <time datetime="2008-10" class="refDate">October 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5322">https://www.rfc-editor.org/info/rfc5322</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6376">[RFC6376]</dt>
        <dd>
<span class="refAuthor">Crocker, D., Ed.</span>, <span class="refAuthor">Hansen, T., Ed.</span>, and <span class="refAuthor">M. Kucherawy, Ed.</span>, <span class="refTitle">"DomainKeys Identified Mail (DKIM) Signatures"</span>, <span class="seriesInfo">STD 76</span>, <span class="seriesInfo">RFC 6376</span>, <span class="seriesInfo">DOI 10.17487/RFC6376</span>, <time datetime="2011-09" class="refDate">September 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6376">https://www.rfc-editor.org/info/rfc6376</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6409">[RFC6409]</dt>
        <dd>
<span class="refAuthor">Gellens, R.</span> and <span class="refAuthor">J. Klensin</span>, <span class="refTitle">"Message Submission for Mail"</span>, <span class="seriesInfo">STD 72</span>, <span class="seriesInfo">RFC 6409</span>, <span class="seriesInfo">DOI 10.17487/RFC6409</span>, <time datetime="2011-11" class="refDate">November 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6409">https://www.rfc-editor.org/info/rfc6409</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6532">[RFC6532]</dt>
        <dd>
<span class="refAuthor">Yang, A.</span>, <span class="refAuthor">Steele, S.</span>, and <span class="refAuthor">N. Freed</span>, <span class="refTitle">"Internationalized Email Headers"</span>, <span class="seriesInfo">RFC 6532</span>, <span class="seriesInfo">DOI 10.17487/RFC6532</span>, <time datetime="2012-02" class="refDate">February 2012</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6532">https://www.rfc-editor.org/info/rfc6532</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7292">[RFC7292]</dt>
        <dd>
<span class="refAuthor">Moriarty, K., Ed.</span>, <span class="refAuthor">Nystrom, M.</span>, <span class="refAuthor">Parkinson, S.</span>, <span class="refAuthor">Rusch, A.</span>, and <span class="refAuthor">M. Scott</span>, <span class="refTitle">"PKCS #12: Personal Information Exchange Syntax v1.1"</span>, <span class="seriesInfo">RFC 7292</span>, <span class="seriesInfo">DOI 10.17487/RFC7292</span>, <time datetime="2014-07" class="refDate">July 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7292">https://www.rfc-editor.org/info/rfc7292</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7435">[RFC7435]</dt>
        <dd>
<span class="refAuthor">Dukhovni, V.</span>, <span class="refTitle">"Opportunistic Security: Some Protection Most of the Time"</span>, <span class="seriesInfo">RFC 7435</span>, <span class="seriesInfo">DOI 10.17487/RFC7435</span>, <time datetime="2014-12" class="refDate">December 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7435">https://www.rfc-editor.org/info/rfc7435</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7929">[RFC7929]</dt>
        <dd>
<span class="refAuthor">Wouters, P.</span>, <span class="refTitle">"DNS-Based Authentication of Named Entities (DANE) Bindings for OpenPGP"</span>, <span class="seriesInfo">RFC 7929</span>, <span class="seriesInfo">DOI 10.17487/RFC7929</span>, <time datetime="2016-08" class="refDate">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7929">https://www.rfc-editor.org/info/rfc7929</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8162">[RFC8162]</dt>
        <dd>
<span class="refAuthor">Hoffman, P.</span> and <span class="refAuthor">J. Schlyter</span>, <span class="refTitle">"Using Secure DNS to Associate Certificates with Domain Names for S/MIME"</span>, <span class="seriesInfo">RFC 8162</span>, <span class="seriesInfo">DOI 10.17487/RFC8162</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8162">https://www.rfc-editor.org/info/rfc8162</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8621">[RFC8621]</dt>
        <dd>
<span class="refAuthor">Jenkins, N.</span> and <span class="refAuthor">C. Newman</span>, <span class="refTitle">"The JSON Meta Application Protocol (JMAP) for Mail"</span>, <span class="seriesInfo">RFC 8621</span>, <span class="seriesInfo">DOI 10.17487/RFC8621</span>, <time datetime="2019-08" class="refDate">August 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8621">https://www.rfc-editor.org/info/rfc8621</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8823">[RFC8823]</dt>
        <dd>
<span class="refAuthor">Melnikov, A.</span>, <span class="refTitle">"Extensions to Automatic Certificate Management Environment for End-User S/MIME Certificates"</span>, <span class="seriesInfo">RFC 8823</span>, <span class="seriesInfo">DOI 10.17487/RFC8823</span>, <time datetime="2021-04" class="refDate">April 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8823">https://www.rfc-editor.org/info/rfc8823</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9051">[RFC9051]</dt>
        <dd>
<span class="refAuthor">Melnikov, A., Ed.</span> and <span class="refAuthor">B. Leiba, Ed.</span>, <span class="refTitle">"Internet Message Access Protocol (IMAP) - Version 4rev2"</span>, <span class="seriesInfo">RFC 9051</span>, <span class="seriesInfo">DOI 10.17487/RFC9051</span>, <time datetime="2021-08" class="refDate">August 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9051">https://www.rfc-editor.org/info/rfc9051</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9216">[RFC9216]</dt>
        <dd>
<span class="refAuthor">Gillmor, D. K., Ed.</span>, <span class="refTitle">"S/MIME Example Keys and Certificates"</span>, <span class="seriesInfo">RFC 9216</span>, <span class="seriesInfo">DOI 10.17487/RFC9216</span>, <time datetime="2022-04" class="refDate">April 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9216">https://www.rfc-editor.org/info/rfc9216</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9219">[RFC9219]</dt>
        <dd>
<span class="refAuthor">Melnikov, A.</span>, <span class="refTitle">"S/MIME Signature Verification Extension to the JSON Meta Application Protocol (JMAP)"</span>, <span class="seriesInfo">RFC 9219</span>, <span class="seriesInfo">DOI 10.17487/RFC9219</span>, <time datetime="2022-04" class="refDate">April 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9219">https://www.rfc-editor.org/info/rfc9219</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9580">[RFC9580]</dt>
        <dd>
<span class="refAuthor">Wouters, P., Ed.</span>, <span class="refAuthor">Huigens, D.</span>, <span class="refAuthor">Winter, J.</span>, and <span class="refAuthor">Y. Niibe</span>, <span class="refTitle">"OpenPGP"</span>, <span class="seriesInfo">RFC 9580</span>, <span class="seriesInfo">DOI 10.17487/RFC9580</span>, <time datetime="2024-07" class="refDate">July 2024</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9580">https://www.rfc-editor.org/info/rfc9580</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-jmap-smime-sender-extensions">[SMIME-SENDER-EXTENSIONS]</dt>
        <dd>
<span class="refAuthor">Melnikov, A.</span>, <span class="refTitle">"JMAP extension for S/MIME signing and encryption"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-jmap-smime-sender-extensions-04</span>, <time datetime="2023-08-03" class="refDate">3 August 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-jmap-smime-sender-extensions-04">https://datatracker.ietf.org/doc/html/draft-ietf-jmap-smime-sender-extensions-04</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SPOOFING">[SPOOFING]</dt>
        <dd>
<span class="refAuthor">Müller, J.</span>, <span class="refAuthor">Brinkmann, M.</span>, <span class="refAuthor">Poddebniak, D.</span>, <span class="refAuthor">Böck, H.</span>, <span class="refAuthor">Schinzel, S.</span>, <span class="refAuthor">Somorovsky, J.</span>, and <span class="refAuthor">J. Schwenk</span>, <span class="refTitle">""Johnny, you are fired!" - Spoofing OpenPGP and S/MIME Signatures in Emails"</span>, <span class="refContent">Proceedings of the 28th USENIX Security Symposium (USENIX Security 19), pp. 1011-1028</span>, <time datetime="2019-08" class="refDate">August 2019</time>, <span>&lt;<a href="https://www.usenix.org/system/files/sec19-muller.pdf">https://www.usenix.org/system/files/sec19-muller.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SRI">[SRI]</dt>
        <dd>
<span class="refAuthor">Akhawe, D.</span>, <span class="refAuthor">Braun, F.</span>, <span class="refAuthor">Marier, F.</span>, and <span class="refAuthor">J. Weinberger</span>, <span class="refTitle">"Subresource Integrity"</span>, <span class="refContent">W3C Candidate Recommendation</span>, <time datetime="2016-06" class="refDate">June 2016</time>, <span>&lt;<a href="https://www.w3.org/TR/2016/REC-SRI-20160623/">https://www.w3.org/TR/2016/REC-SRI-20160623/</a>&gt;</span>. <span class="annotation">Latest version available at <span>&lt;<a href="https://www.w3.org/TR/SRI/">https://www.w3.org/TR/SRI/</a>&gt;</span>.</span>
        </dd>
<dd class="break"></dd>
<dt id="I-D.koch-openpgp-webkey-service">[WEBKEY-SERVICE]</dt>
      <dd>
<span class="refAuthor">Koch, W.</span>, <span class="refTitle">"OpenPGP Web Key Directory"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-koch-openpgp-webkey-service-20</span>, <time datetime="2025-06-02" class="refDate">2 June 2025</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-koch-openpgp-webkey-service-20">https://datatracker.ietf.org/doc/html/draft-koch-openpgp-webkey-service-20</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="future-work">
<section id="appendix-A">
      <h2 id="name-future-work">
<a href="#appendix-A" class="section-number selfRef">Appendix A. </a><a href="#name-future-work" class="section-name selfRef">Future Work</a>
      </h2>
<p id="appendix-A-1">This document contains useful guidance for MUA implementers, but it cannot contain all possible guidance.
Future revisions of this document may want to further explore the following topics, which are out of scope for this version.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
<div id="webmail-threat-model">
<section id="appendix-A.1">
        <h3 id="name-webmail-threat-model">
<a href="#appendix-A.1" class="section-number selfRef">A.1. </a><a href="#name-webmail-threat-model" class="section-name selfRef">Webmail Threat Model</a>
        </h3>
<p id="appendix-A.1-1">The webmail threat model for end-to-end cryptographic protections is significantly more complex than the classic MUA model.
For example, the web server hosting the webmail interface could be a potential adversary.
If the user treats the web server as a trusted party, but the web server violates that trust, the end-to-end cryptographic protections do not hold.<a href="#appendix-A.1-1" class="pilcrow">¶</a></p>
<p id="appendix-A.1-2">A future version of this document could include more detailed discussion of an adversarial threat model for end-to-end cryptographic protections in a webmail context.<a href="#appendix-A.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="test-vectors">
<section id="appendix-A.2">
        <h3 id="name-test-vectors">
<a href="#appendix-A.2" class="section-number selfRef">A.2. </a><a href="#name-test-vectors" class="section-name selfRef">Test Vectors</a>
        </h3>
<p id="appendix-A.2-1">A future version of this document (or a companion document) could contain examples of well-formed and malformed messages using cryptographic key material and certificates from <span>[<a href="#RFC9580" class="cite xref">RFC9580</a>]</span> and <span>[<a href="#RFC9216" class="cite xref">RFC9216</a>]</span>.<a href="#appendix-A.2-1" class="pilcrow">¶</a></p>
<p id="appendix-A.2-2">It may also include example renderings of these messages.<a href="#appendix-A.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="more-peer-certs">
<section id="appendix-A.3">
        <h3 id="name-further-guidance-on-peer-ce">
<a href="#appendix-A.3" class="section-number selfRef">A.3. </a><a href="#name-further-guidance-on-peer-ce" class="section-name selfRef">Further Guidance on Peer Certificates</a>
        </h3>
<div id="peer-discovery-incoming">
<section id="appendix-A.3.1">
          <h4 id="name-certificate-discovery-from-">
<a href="#appendix-A.3.1" class="section-number selfRef">A.3.1. </a><a href="#name-certificate-discovery-from-" class="section-name selfRef">Certificate Discovery from Incoming Messages</a>
          </h4>
<p id="appendix-A.3.1-1">As described in <a href="#sending-certificates" class="auto internal xref">Section 8.2.3</a>, an incoming email message may have one or more certificates embedded in it.
This document currently acknowledges that a rendering MUA should assemble a cache of certificates for future use, but providing more detailed guidance for how to assemble and manage that cache is currently out of scope.<a href="#appendix-A.3.1-1" class="pilcrow">¶</a></p>
<p id="appendix-A.3.1-2">Existing recommendations like <span>[<a href="#AUTOCRYPT" class="cite xref">AUTOCRYPT</a>]</span> provide some guidance for handling incoming certificates about peers but only in certain contexts.
A future version of this document may describe in more detail how these incoming certificates should be handled.<a href="#appendix-A.3.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="peer-discovery--directory">
<section id="appendix-A.3.2">
          <h4 id="name-certificate-directories">
<a href="#appendix-A.3.2" class="section-number selfRef">A.3.2. </a><a href="#name-certificate-directories" class="section-name selfRef">Certificate Directories</a>
          </h4>
<p id="appendix-A.3.2-1">Some MUAs may have the capability to look up peer certificates in a directory, for example, via the Lightweight Directory Access Protocol (LDAP) <span>[<a href="#RFC4511" class="cite xref">RFC4511</a>]</span>, Web Key Directory (WKD) <span>[<a href="#I-D.koch-openpgp-webkey-service" class="cite xref">WEBKEY-SERVICE</a>]</span>, or DNS (e.g., SMIMEA <span>[<a href="#RFC8162" class="cite xref">RFC8162</a>]</span> or OPENPGPKEY <span>[<a href="#RFC7929" class="cite xref">RFC7929</a>]</span> resource records).<a href="#appendix-A.3.2-1" class="pilcrow">¶</a></p>
<p id="appendix-A.3.2-2">A future version of this document may describe in more detail what sources an MUA should consider when searching for a peer's certificates and what to do with the certificates found by various methods.<a href="#appendix-A.3.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cert-revocation">
<section id="appendix-A.3.3">
          <h4 id="name-checking-for-certificate-re">
<a href="#appendix-A.3.3" class="section-number selfRef">A.3.3. </a><a href="#name-checking-for-certificate-re" class="section-name selfRef">Checking for Certificate Revocation</a>
          </h4>
<p id="appendix-A.3.3-1">A future version of this document could discuss how/when to check for revocation of peer certificates or of the user's own certificate.<a href="#appendix-A.3.3-1" class="pilcrow">¶</a></p>
<p id="appendix-A.3.3-2">Such discussion should address privacy concerns: What information leaks to whom when checking peer certificate revocations?<a href="#appendix-A.3.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="more-peer-cert-selection">
<section id="appendix-A.3.4">
          <h4 id="name-further-peer-certificate-se">
<a href="#appendix-A.3.4" class="section-number selfRef">A.3.4. </a><a href="#name-further-peer-certificate-se" class="section-name selfRef">Further Peer Certificate Selection</a>
          </h4>
<p id="appendix-A.3.4-1">A future version of this document may describe more prescriptions for deciding whether a peer certificate is acceptable for encrypting a message.
For example, if the SPKI is an Elliptic Curve (EC) public key and the keyUsage extension is absent, what should the encrypting MUA do?<a href="#appendix-A.3.4-1" class="pilcrow">¶</a></p>
<p id="appendix-A.3.4-2">A future version of this document might also provide guidance on what to do if multiple certificates are all acceptable for encrypting to a given recipient.
For example, the composing MUA could select among them in some deterministic way; it could encrypt to all of them; or it could present them to the user to let the user select any or all of them.<a href="#appendix-A.3.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="display-names">
<section id="appendix-A.3.5">
          <h4 id="name-human-readable-names-in-pee">
<a href="#appendix-A.3.5" class="section-number selfRef">A.3.5. </a><a href="#name-human-readable-names-in-pee" class="section-name selfRef">Human-Readable Names in Peer Certificates, Header Fields, and Address Books</a>
          </h4>
<p id="appendix-A.3.5-1">In header fields such as <code>From</code> that may contain a <code>display-name</code> as described in <span><a href="https://rfc-editor.org/rfc/rfc5322#section-3.4" class="relref">Section 3.4</a> of [<a href="#RFC5322" class="cite xref">RFC5322</a>]</span>, a malicious composer (or interfering adversary) may populate the <code>display-name</code> part with a human-readable name that does not at all match the actual name of the participant.
<a href="#peer-cert-selection" class="auto internal xref">Section 8.1.1</a> describes some matching rules relating peer certificates to email addresses (the <code>addr-spec</code> part of these email header fields) but does not contemplate matching <code>display-name</code>s or other similar user-visible data elements.
<a href="#signature-failures" class="auto internal xref">Section 6.4</a> describes how signature validation should confirm a binding between the <code>addr-spec</code> and the certificate itself, but it also does not contemplate matching <code>display-name</code>s or other similar user-visible data elements.
Depending on how the rendering MUA renders the <code>display-name</code> in a message's header field, that unvalidated field may present a risk of user confusion, which could break the intended end-to-end assurances.
Yet both X.509 and OpenPGP certificate formats offer ways to provide cryptographically certified (though possibly not unique) comparable human-readable names.
Additionally, many MUAs also include an address book or comparable feature that can make substantive connections between user-relevant identity labels and email addresses.<a href="#appendix-A.3.5-1" class="pilcrow">¶</a></p>
<p id="appendix-A.3.5-2">A human-readable name like a <code>display-name</code> does not have the property of global uniqueness that an <code>addr-spec</code> does, so reasoning about human-readable names and rendering them to the user as an element in a system providing end-to-end cryptographic assurance requires additional deliberate analysis.<a href="#appendix-A.3.5-2" class="pilcrow">¶</a></p>
<p id="appendix-A.3.5-3">A future version of this document might offer strategies for associating human-readable names from certificates (and features like address books) to the rendering of header fields that include <code>display-name</code>.
Such guidance should be paired with an analysis of specific usability and security risks associated with these human-readable fields, as well as a description of how the recommended guidance mitigates those risks.<a href="#appendix-A.3.5-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="more-local-certs">
<section id="appendix-A.4">
        <h3 id="name-further-guidance-on-local-c">
<a href="#appendix-A.4" class="section-number selfRef">A.4. </a><a href="#name-further-guidance-on-local-c" class="section-name selfRef">Further Guidance on Local Certificates and Secret Keys</a>
        </h3>
<div id="cross-mua-local-keys">
<section id="appendix-A.4.1">
          <h4 id="name-cross-mua-sharing-of-local-">
<a href="#appendix-A.4.1" class="section-number selfRef">A.4.1. </a><a href="#name-cross-mua-sharing-of-local-" class="section-name selfRef">Cross-MUA Sharing of Local Certificates and Secret Keys</a>
          </h4>
<p id="appendix-A.4.1-1">Many users today use more than one MUA to access the same mailbox (for example, one MUA on a mobile device and another MUA on a desktop computer).<a href="#appendix-A.4.1-1" class="pilcrow">¶</a></p>
<p id="appendix-A.4.1-2">A future version of this document might offer guidance on how multiple MUAs attached to the same mailbox can efficiently and securely share the user's own secret key material and certificates between each other.
This guidance should include suggestions on how to maintain the user's keys (e.g., avoiding certificate expiration) and safe secret key transmission.<a href="#appendix-A.4.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="smartcards">
<section id="appendix-A.4.2">
          <h4 id="name-use-of-smart-cards-or-other">
<a href="#appendix-A.4.2" class="section-number selfRef">A.4.2. </a><a href="#name-use-of-smart-cards-or-other" class="section-name selfRef">Use of Smart Cards or Other Portable Secret Key Mechanisms</a>
          </h4>
<p id="appendix-A.4.2-1">Rather than having to transfer secret key material between clients, some users may prefer to rely on portable hardware-backed secret keys in the form of smart cards, USB tokens, or other comparable form factors.
These secret keys sometimes require direct user interaction for each use, which can complicate the usability of any MUA that uses them to decrypt a large number of messages.<a href="#appendix-A.4.2-1" class="pilcrow">¶</a></p>
<p id="appendix-A.4.2-2">Guidance on the use of this kind of secret key management is beyond the scope of this document, but future revisions may bring them into scope.<a href="#appendix-A.4.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="more-local-cert-maintenance">
<section id="appendix-A.4.3">
          <h4 id="name-active-local-certificate-ma">
<a href="#appendix-A.4.3" class="section-number selfRef">A.4.3. </a><a href="#name-active-local-certificate-ma" class="section-name selfRef">Active Local Certificate Maintenance</a>
          </h4>
<p id="appendix-A.4.3-1"><a href="#local-cert-maintenance" class="auto internal xref">Section 8.2.2</a> describes conditions where the MUA <span class="bcp14">SHOULD</span> warn the user that something is going wrong with their certificate.<a href="#appendix-A.4.3-1" class="pilcrow">¶</a></p>
<p id="appendix-A.4.3-2">A future version of this document might outline how an MUA could actively avoid these warning situations, for example, by automatically updating the certificate or prompting the user to take specific action.<a href="#appendix-A.4.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="cert-authorities">
<section id="appendix-A.5">
        <h3 id="name-certification-authorities">
<a href="#appendix-A.5" class="section-number selfRef">A.5. </a><a href="#name-certification-authorities" class="section-name selfRef">Certification Authorities</a>
        </h3>
<p id="appendix-A.5-1">A future document could offer guidance on how an MUA should select and manage root CAs.<a href="#appendix-A.5-1" class="pilcrow">¶</a></p>
<p id="appendix-A.5-2">For example:<a href="#appendix-A.5-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A.5-3.1">
            <p id="appendix-A.5-3.1.1">Should the MUA cache intermediate CAs?<a href="#appendix-A.5-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-A.5-3.2">
            <p id="appendix-A.5-3.2.1">Should the MUA share such a cache with other PKI clients (e.g., web browsers)?<a href="#appendix-A.5-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-A.5-3.3">
            <p id="appendix-A.5-3.3.1">What distinctions are there between a CA for S/MIME and a CA for the Web?<a href="#appendix-A.5-3.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="indexing-and-search">
<section id="appendix-A.6">
        <h3 id="name-indexing-and-search-of-encr">
<a href="#appendix-A.6" class="section-number selfRef">A.6. </a><a href="#name-indexing-and-search-of-encr" class="section-name selfRef">Indexing and Search of Encrypted Messages</a>
        </h3>
<p id="appendix-A.6-1">A common use case for MUAs is the search of existing messages by keyword or topic.
This is done most efficiently for large mailboxes by assembling an index of message content rather than by a linear scan of all message content.<a href="#appendix-A.6-1" class="pilcrow">¶</a></p>
<p id="appendix-A.6-2">When message contents and header fields are encrypted, search by index is complicated.
If the cleartext is not indexed, then messages cannot be found by search.
On the other hand, if the cleartext is indexed, then the index effectively contains the sensitive contents of the message and needs to be protected.<a href="#appendix-A.6-2" class="pilcrow">¶</a></p>
<p id="appendix-A.6-3">Detailed guidance on the trade-off here, including choices about remote search vs. local search, are beyond the scope of this document, but a future version of the document may bring them into scope.<a href="#appendix-A.6-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cached-sigs">
<section id="appendix-A.7">
        <h3 id="name-cached-signature-validation">
<a href="#appendix-A.7" class="section-number selfRef">A.7. </a><a href="#name-cached-signature-validation" class="section-name selfRef">Cached Signature Validation</a>
        </h3>
<p id="appendix-A.7-1">Asymmetric signature validation can be computationally expensive, and the results can also potentially vary over time (e.g., if a signing certificate is discovered to be revoked).
In some cases, the user may care about the signature validation that they saw when they first read or received the message, not only about the status of the signature verification at the current time.<a href="#appendix-A.7-1" class="pilcrow">¶</a></p>
<p id="appendix-A.7-2">So, for both performance reasons and historical perspective, it may be useful for an MUA to cache signature validation results in a way that they can be easily retrieved and compared.
Documenting how and when to cache signature validation, as well as how to indicate it to the user, is beyond the scope of this document, but a future version of the document may bring these topics into scope.<a href="#appendix-A.7-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="aggregate-cryptographic-status">
<section id="appendix-A.8">
        <h3 id="name-aggregate-cryptographic-sta">
<a href="#appendix-A.8" class="section-number selfRef">A.8. </a><a href="#name-aggregate-cryptographic-sta" class="section-name selfRef">Aggregate Cryptographic Status</a>
        </h3>
<p id="appendix-A.8-1">This document limits itself to consideration of the cryptographic status of single messages as a baseline concept that can be clearly and simply communicated to the user.
However, some users and some MUAs may find it useful to contemplate even higher-level views of cryptographic status, which are not considered directly here.<a href="#appendix-A.8-1" class="pilcrow">¶</a></p>
<p id="appendix-A.8-2">For example, a future version of the document may also consider how to indicate a simple cryptographic status of message threads (groups of explicitly related messages), conversations (groups of messages with shared sets of participants), peers, or other perspectives that an MUA can provide.<a href="#appendix-A.8-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="expect-e2e">
<section id="appendix-A.9">
        <h3 id="name-expectations-of-cryptograph">
<a href="#appendix-A.9" class="section-number selfRef">A.9. </a><a href="#name-expectations-of-cryptograph" class="section-name selfRef">Expectations of Cryptographic Protection</a>
        </h3>
<p id="appendix-A.9-1">As mentioned in <a href="#security-indicators" class="auto internal xref">Section 2.3</a>, the types of security indicators displayed to the user may vary based on the expectations of the user for a given communication.
At present, there is no widely shared method for the MUA to establish and maintain reasonable expectations about whether a specific rendered message should have cryptographic protections.<a href="#appendix-A.9-1" class="pilcrow">¶</a></p>
<p id="appendix-A.9-2">If such a standard is developed, a future version of this document should reference it and encourage the deployment of clearer and simpler security indicators.<a href="#appendix-A.9-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="secure-deletion">
<section id="appendix-A.10">
        <h3 id="name-secure-deletion">
<a href="#appendix-A.10" class="section-number selfRef">A.10. </a><a href="#name-secure-deletion" class="section-name selfRef">Secure Deletion</a>
        </h3>
<p id="appendix-A.10-1">One feature many users desire from a secure communications medium is the ability to reliably destroy a message such that it cannot be recovered even by a determined adversary.
In other contexts, a similar desired property is called "forward secrecy".
Doing this with standard email mechanisms such as S/MIME and PGP/MIME is challenging because of two interrelated factors:<a href="#appendix-A.10-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="appendix-A.10-2.1">
            <p id="appendix-A.10-2.1.1">A copy of an email message may be retained by any of the mail transport agents that handle it during delivery.<a href="#appendix-A.10-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="appendix-A.10-2.2">
            <p id="appendix-A.10-2.2.1">The secret key used to decrypt an encrypted email message is typically retained indefinitely.<a href="#appendix-A.10-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="appendix-A.10-3">This means that an adversary aiming to recover the cleartext contents of a deleted message can do so by getting access to a copy of the encrypted message and the long-term secret key material.<a href="#appendix-A.10-3" class="pilcrow">¶</a></p>
<p id="appendix-A.10-4">Some mitigation measures may be available to make it possible to delete some encrypted messages securely, but this document considers this use case out of scope.
A future version of the document may elaborate on secure message deletion in more detail.<a href="#appendix-A.10-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="interaction-with-opportunistic-encryption">
<section id="appendix-A.11">
        <h3 id="name-interaction-with-opportunis">
<a href="#appendix-A.11" class="section-number selfRef">A.11. </a><a href="#name-interaction-with-opportunis" class="section-name selfRef">Interaction with Opportunistic Encryption</a>
        </h3>
<p id="appendix-A.11-1">This document focuses on guidance for strong, user-comprehensible end-to-end cryptographic protections for email.
Other approaches are possible, including various forms of opportunistic and transport encryption, which are out of scope for this document.<a href="#appendix-A.11-1" class="pilcrow">¶</a></p>
<p id="appendix-A.11-2">A future version of this document could describe the interaction between this guidance and more opportunistic forms of encryption, for example, some of the scenarios contemplated in <span>[<a href="#I-D.dkg-mail-cleartext-copy" class="cite xref">CLEARTEXT-COPY</a>]</span>.<a href="#appendix-A.11-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="split-attachments">
<section id="appendix-A.12">
        <h3 id="name-split-attachments">
<a href="#appendix-A.12" class="section-number selfRef">A.12. </a><a href="#name-split-attachments" class="section-name selfRef">Split Attachments</a>
        </h3>
<p id="appendix-A.12-1">As noted in <a href="#attachments" class="auto internal xref">Section 7.2</a>, the standard form for encrypted email messages is a single Cryptographic Envelope.
In a scenario where multiple user agents are drafting a single encrypted message over low-bandwidth links, this can create a poor user experience, as each MUA has to retrieve the full message, including attachments, to modify the draft.
Similarly, when retrieving a message with a large attachment, the receiving MUA might want to only render the Main Body Part and will have a significant delay in doing so if required to process the full message before handling.<a href="#appendix-A.12-1" class="pilcrow">¶</a></p>
<p id="appendix-A.12-2">Future work might include an attempt to standardize a mechanism that eases this use case, potentially at the risk of additional metadata leakage about the message (e.g., the size and number of message parts).
Any such work should explicitly try to minimize the risks and concerns described in <a href="#attachments" class="auto internal xref">Section 7.2</a>.<a href="#appendix-A.12-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proxy-extensions">
<section id="appendix-A.13">
        <h3 id="name-proxy-extensions">
<a href="#appendix-A.13" class="section-number selfRef">A.13. </a><a href="#name-proxy-extensions" class="section-name selfRef">Proxy Extensions</a>
        </h3>
<p id="appendix-A.13-1">As noted in <a href="#proxy-dangers" class="auto internal xref">Section 9.7</a>, a proxy-based implementation can be a tempting approach.
But its naive form is likely to be insufficient to provide safe end-to-end encrypted email.<a href="#appendix-A.13-1" class="pilcrow">¶</a></p>
<p id="appendix-A.13-2">A future version of this document, or a separate but related document, could try to outline the specific additional information, state, and network API surface that would be needed to allow an MUA to be safely integrated with an encryption provider.
Any such work should try to address the potential problems described in <a href="#proxy-dangers" class="auto internal xref">Section 9.7</a>.<a href="#appendix-A.13-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="mailing-lists">
<section id="appendix-A.14">
        <h3 id="name-mailing-lists">
<a href="#appendix-A.14" class="section-number selfRef">A.14. </a><a href="#name-mailing-lists" class="section-name selfRef">Mailing Lists</a>
        </h3>
<p id="appendix-A.14-1">Mailing lists offer challenging complications to any notion of end-to-end cryptographic protections.
By default, there is some sort of intervening MUA (see <a href="#intervening-mua" class="auto internal xref">Section 9.8</a>), but more than that, user expectations about cryptographic protections might differ from normal messages, at least insofar as they understand they are writing to a mailing list.
A particular challenge to the notion of end-to-end cryptographic security with mailing lists is that a subscriber to a mailing list often does not know who else is subscribed to the mailing list.
Another challenge is that, for some mailing lists, some subscribers might not have a valid, non-expired certificate.<a href="#appendix-A.14-1" class="pilcrow">¶</a></p>
<p id="appendix-A.14-2">Encryption can interact with mailing lists in different ways, depending on the use case of the list.
It's not clear that there are any useful motivations for sending encrypted mail to a publicly archived mailing list.
But an unarchived mailing list might want to provide confidentiality between all recipients, even if the recipients don't know for certain who all the other participants are.
Or a mailing list with private archives might well decide that two "hops" of encryption (between the composer and the mailing list, and the mailing list and all the subscribers) are useful confidentiality measures even though they are not "end-to-end" in the sense of the composer directly to all recipients.<a href="#appendix-A.14-2" class="pilcrow">¶</a></p>
<p id="appendix-A.14-3">Similarly, cryptographic signatures may play different roles in a mailing list, depending on the list's communication goals.
The mailing list itself might want to verify that an incoming message is cryptographically signed by an authorized sender before redistribution to the list subscribers.
It might also want to pass along the composer's signature in a way that the subscribers can all verify it.
Alternately, the mailing list might want to sign each redistributed message itself and change the message so it appears to come from the list rather than the original composer.<a href="#appendix-A.14-3" class="pilcrow">¶</a></p>
<p id="appendix-A.14-4">Yet another design for a mailing list with end-to-end cryptographic protections might involve redistributing shared secret keys to all recipients or using some sort of proxied re-encryption scheme, similar to <span>[<a href="#I-D.wussler-openpgp-forwarding" class="cite xref">OPENPGP-FORWARDING</a>]</span>.<a href="#appendix-A.14-4" class="pilcrow">¶</a></p>
<p id="appendix-A.14-5">A future version of this document, or a separate but related document, might describe some of these trade-offs and provide guidance for safely meeting common requirements or use cases when combining end-to-end cryptographic protections with mailing lists.<a href="#appendix-A.14-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="acknowledgements">
<section id="appendix-B">
      <h2 id="name-acknowledgements">
<a href="#name-acknowledgements" class="section-name selfRef">Acknowledgements</a>
      </h2>
<p id="appendix-B-1">The set of constructs and recommendations in this document are
      derived from discussions with many different implementers, including
      <span class="contact-name">Bjarni Rúnar Einarsson</span>, <span class="contact-name">Daniel       Huigens</span>, <span class="contact-name">David Bremner</span>, <span class="contact-name">Deb       Cooley</span>, <span class="contact-name">Eliot Lear</span>, <span class="contact-name">Fabian       Ising</span>, <span class="contact-name">Heiko Schaefer</span>, <span class="contact-name">Holger Krekel</span>, <span class="contact-name">Jameson Rollins</span>,
      <span class="contact-name">John Levine</span>, <span class="contact-name">Jonathan       Hammell</span>, <span class="contact-name">juga</span>, <span class="contact-name">Patrick       Brunschwig</span>, <span class="contact-name">Paul Kyzivat</span>, <span class="contact-name">Pete Resnick</span>, <span class="contact-name">Roman Danyliw</span>, <span class="contact-name">Santosh Chokhani</span>, <span class="contact-name">Stephen Farrell</span>,
      <span class="contact-name">Thore Göbel</span>, and <span class="contact-name">Vincent       Breitmoser</span>.<a href="#appendix-B-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-C">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Daniel Kahn Gillmor (<span class="role">editor</span>)</span></div>
<div dir="auto" class="left"><span class="org">American Civil Liberties Union</span></div>
<div dir="auto" class="left"><span class="street-address">125 Broad St.</span></div>
<div dir="auto" class="left">
<span class="locality">New York</span>, <span class="region">NY</span> <span class="postal-code">10004</span>
</div>
<div dir="auto" class="left"><span class="country-name">United States of America</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:dkg@fifthhorseman.net" class="email">dkg@fifthhorseman.net</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Alexey Melnikov (<span class="role">editor</span>)</span></div>
<div dir="auto" class="left"><span class="org">Isode Ltd</span></div>
<div dir="auto" class="left"><span class="street-address">14 Castle Mews</span></div>
<div dir="auto" class="left"><span class="locality">Hampton, Middlesex</span></div>
<div dir="auto" class="left"><span class="postal-code">TW12 2NP</span></div>
<div dir="auto" class="left"><span class="country-name">United Kingdom</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:alexey.melnikov@isode.com" class="email">alexey.melnikov@isode.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Bernie Hoeneisen (<span class="role">editor</span>)</span></div>
<div dir="auto" class="left"><span class="org">pEp Project</span></div>
<div dir="auto" class="left"><span class="street-address">Oberer Graben 4</span></div>
<div dir="auto" class="left">CH-<span class="postal-code">8400</span> <span class="locality">Winterthur</span>
</div>
<div dir="auto" class="left"><span class="country-name">Switzerland</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:bernie@ietf.hoeneisen.ch" class="email">bernie@ietf.hoeneisen.ch</a>
</div>
<div class="url">
<span>URI:</span>
<a href="https://pep-project.org/" class="url">https://pep-project.org/</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
